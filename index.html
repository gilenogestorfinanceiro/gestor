<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Gileno - Gest√£o Financeira</title>
<meta name="description" content="Gileno - Gest√£o Financeira. Controle suas finan√ßas pessoais com seguran√ßa na nuvem.">
<meta property="og:title" content="Gileno - Gest√£o Financeira">
<meta property="og:description" content="Controle suas finan√ßas pessoais com seguran√ßa na nuvem. Gerencie contas, cart√µes, transfer√™ncias e muito mais.">
<meta property="og:type" content="website">
<meta property="og:image" content="https://gilenogestorfinanceiro.github.io/gestor/og_banner.jpg">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:url" content="https://gilenogestorfinanceiro.github.io/gestor/">
<meta name="theme-color" content="#1a1a1a">
<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAABCGlDQ1BJQ0MgUHJvZmlsZQAAeJxjYGA8wQAELAYMDLl5JUVB7k4KEZFRCuwPGBiBEAwSk4sLGHADoKpv1yBqL+viUYcLcKakFicD6Q9ArFIEtBxopAiQLZIOYWuA2EkQtg2IXV5SUAJkB4DYRSFBzkB2CpCtkY7ETkJiJxcUgdT3ANk2uTmlyQh3M/Ck5oUGA2kOIJZhKGYIYnBncAL5H6IkfxEDg8VXBgbmCQixpJkMDNtbGRgkbiHEVBYwMPC3MDBsO48QQ4RJQWJRIliIBYiZ0tIYGD4tZ2DgjWRgEL7AwMAVDQsIHG5TALvNnSEfCNMZchhSgSKeDHkMyQx6QJYRgwGDIYMZAKbWPz9HbOBQAAAErklEQVR4nNWWXWxURRTHz5m59+4H220pt8tXu/aDtZQGpBiKLYHEEKIhJGCJCQJq0hoDJsqjiW+8+u5XFCNCUAkSE2oiGgzBtpYGsLBtKZYqXWih7W67H3e39965M+NDhZDuLW1j+uB5mpnMnN+c+c/MOehXA7A4hohSSrJI3gFASgkAiwiYtkUHKAtdgIjTjekTAAAEIAD8PwIQkRAipeScCyEIIYg47dqUkgH4HpMXCpheaNomB0ZACfgCqqbats2ZYwE4AGWq8qrm6WfOT7blRxQLAhBCLMsSICKRSGNjY0NjQ93zGwuDwfuxkR/O/9j17Tcvm/YWVQsDvscyAiA/iKcBKKEZKxNeXbZnz966urrKNVUV5RUlK3TBHYVqFeXlFznfROhKLpMgY0JQAJHnZFYAJTRjpRrqtzY17bMZk4B9vX1ff3VicPBOcjKpESqXBJZyUUqUKHN6hWMIQd1UQNeXTAg1rExD/QuvHTh4q6+/Zl3NH9eufX/ubDqbAgACKIDoQH4Orco5/GAuHROyAMB5dK/miAARmWOtDK1obmm5cOGXrY2NnR0dp8+c8hDf0sCyDbW1D1KpeCx2LlCYTaX3W5PDIBUgOVA0VZsXgBBi2WZLS3N//21d19Pp5Okzpwr9S4UQGiHB0tK0kfnCG/CY1rGaqtVL/BW2w4ScnJiI3YsRnPlyXV6ybdslRcvXP7fh2tXr4XDZ8c+PA8Da6uqjR4/KUCh1/frJhwmDi5fS8fc/++hK26UvT574+NNPDr3xuu3YhMx0ODMCQkiOZSvX1I2Pxi3LvPzrJRSypqomxfmNu3f3pTPvGuZZlRybMgTI+7cGrggcHx1njA0Pj0iYhwYSQAUs8XpGkqmsbf99+/am7dvLV60a+u7M/tiwarMPSldGl/i9PVFUPW8fObyuuvbwO0eSydSdgQEAKfN0ngkQQmjUu2NsvKetjRrZSsaqf+9cZ7ONuamLy4pbBVtfVVk6OTkiJaU0O5XZtn3b0NBQIpG4M/Cn4qbozCEKYCCWpYxXordGKMYl/jYx2WqZV0OhyIba4t4+M5EwcjlVUdNmatfO3YVFRTej0ZxhjI2OKYqSH4G76J2ZrN/iaEzFp8xTjo2EBgVniUR2Kmdks5Zlpc1UQ/3WF3fs6OrqEpz39vQ43MG8K+QC4AAawFluD3C7mPN6VTukeQdBCiEy2RxjLJ6Ij42N7d3d1Nz8VjQaLQgG78ViDx8+UFU1f/suRyQBNMSYdD6seubNZCYwPHKAEObwExMTfoUKLiKRyqamprJwuLu7W9f1G93dPdGblFIpwfXDdpFFIHqFuDx0F3fuDJPNODqqC7GLElmiV0ee3bylXl+mDw7+FQgE2tvbOtrbEBERpXRNB7P8RYjoMIYAlWvXFi0PqT5/KFBQXBjUdT0cDhcEAx3tHa2t52P3hjyK59HGFwKYZoAEi5kUiN/v8/r9Xp9P0zTOeXw8nsxOKKB6VI+Q4J7J5gQ8xkgphRBCCCmFBAmAlFBFUeCJtPwUmyOj/VvbEEIpzR+fj8036c/f4wz7/xdergAJbh9v3pw5J8y3NpV5DZjt1uebq8g4S3e+Tp+c/A8nFD+utyhTkgAAAABJRU5ErkJggg==">
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Gileno GF">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--bg:#0d0d0d;--surface:#1a1a1a;--surface2:#222222;--surface3:#2c2c2c;
--border:#383838;--border2:#4a4a4a;
--text:#e8e8e8;--text2:#999999;--text3:#666666;
--primary:#cc2222;--primary2:#aa1818;--primary-glow:rgba(204,34,34,0.12);
--green:#10b981;--green2:#059669;--green-bg:rgba(16,185,129,0.1);
--red:#ef4444;--red2:#dc2626;--red-bg:rgba(239,68,68,0.1);
--orange:#f59e0b;--orange-bg:rgba(245,158,11,0.1);
--purple:#8b5cf6;--purple-bg:rgba(139,92,246,0.1);
--radius:12px;--radius-sm:8px;--radius-xs:6px;
--shadow:0 4px 24px rgba(0,0,0,0.4);
--font:'DM Sans',system-ui,sans-serif;--mono:'JetBrains Mono',monospace;
}
[data-theme="light"]{
--bg:#f2f2f2;--surface:#ffffff;--surface2:#f0f0f0;--surface3:#e6e6e6;
--border:#d4d4d4;--border2:#c0c0c0;
--text:#1a1a1a;--text2:#555555;--text3:#888888;
--primary:#cc2222;--primary2:#aa1818;--primary-glow:rgba(204,34,34,0.08);
--green:#059669;--green2:#047857;--green-bg:rgba(5,150,105,0.08);
--red:#dc2626;--red2:#b91c1c;--red-bg:rgba(220,38,38,0.08);
--orange:#d97706;--orange-bg:rgba(217,119,6,0.08);
--purple:#7c3aed;--purple-bg:rgba(124,58,237,0.08);
--shadow:0 4px 24px rgba(0,0,0,0.08);
}
html,body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
button{font-family:var(--font);cursor:pointer;border:none;outline:none}
input,select{font-family:var(--font);outline:none}

.app{display:flex;flex-direction:column;min-height:100vh}
.app-header{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;backdrop-filter:blur(20px)}
.app-logo{display:flex;align-items:center;gap:10px}
.app-logo svg{width:28px;height:28px}
.app-logo span{font-size:15px;font-weight:700;letter-spacing:-0.5px;background:linear-gradient(135deg,#cc2222,#888888);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-actions{display:flex;gap:8px}
.btn-icon{width:36px;height:36px;border-radius:var(--radius-sm);background:var(--surface2);color:var(--text2);display:flex;align-items:center;justify-content:center;transition:all .2s}
.btn-icon:hover{background:var(--surface3);color:var(--text)}

.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:6px 8px calc(env(safe-area-inset-bottom,0px) + 8px);z-index:100}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 8px;border-radius:var(--radius-sm);color:var(--text3);font-size:9px;font-weight:500;transition:all .2s;-webkit-tap-highlight-color:transparent;background:none}
.nav-item.active{color:var(--primary)}
.nav-item svg{width:22px;height:22px}
.nav-item:active{transform:scale(0.92)}

.main{flex:1;padding:16px 16px 90px;max-width:600px;margin:0 auto;width:100%}
@media(min-width:768px){.main{max-width:700px;padding:24px 24px 90px}}

.page{display:none;animation:fadeIn .3s ease}.page.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.card-title{font-size:12px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.card-title .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

.kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi.green::before{background:var(--green)}.kpi.red::before{background:var(--red)}
.kpi.blue::before{background:#2563eb}.kpi.orange::before{background:var(--orange)}
.kpi.res-pos::before{background:#2563eb}.kpi.res-neg::before{background:#b91c1c}
.kpi-label{font-size:11px;color:var(--text3);font-weight:500;text-transform:uppercase;letter-spacing:0.3px}
.kpi-value{font-size:20px;font-weight:700;font-family:var(--mono);margin-top:4px;letter-spacing:-1px}
.kpi.green .kpi-value{color:var(--green)}.kpi.red .kpi-value{color:var(--red)}
.kpi.blue .kpi-value{color:#2563eb}.kpi.orange .kpi-value{color:var(--orange)}
.kpi.res-pos .kpi-value{color:#2563eb}.kpi.res-neg .kpi-value{color:#b91c1c}
.kpi-val-hide.hidden-val{color:transparent!important;background:var(--surface2);border-radius:4px;user-select:none}
.kpi-val-hide.hidden-val div{color:transparent!important}
.bank-balance.hidden-val{color:transparent!important;background:var(--surface2);border-radius:4px;user-select:none}
.ag-color-dot.active{border:2px solid #fff!important;box-shadow:0 0 8px rgba(255,255,255,0.3)}
#maisMenu button:hover{background:var(--surface2)}

.form-group{margin-bottom:14px}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px}
.form-input{width:100%;padding:12px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:15px;transition:all .2s}
.form-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-glow)}
.form-input::placeholder{color:var(--text3)}
select.form-input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.valor-input-wrap{position:relative}
.valor-prefix{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text3);font-size:14px;font-weight:500}
.valor-input-wrap .form-input{padding-left:36px;font-family:var(--mono);font-size:18px;font-weight:600}

.btn{padding:14px 24px;border-radius:var(--radius-sm);font-size:15px;font-weight:600;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:8px;width:100%}
.btn:active{transform:scale(0.97)}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary2)}
.btn-green{background:var(--green);color:#fff}.btn-green:hover{background:var(--green2)}
.btn-red{background:var(--red);color:#fff}.btn-red:hover{background:var(--red2)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text2)}
.btn-outline:hover{border-color:var(--primary);color:var(--primary)}
.btn-sm{padding:8px 16px;font-size:13px;width:auto}

.toggle-tabs{display:flex;background:var(--surface2);border-radius:var(--radius-sm);padding:3px;margin-bottom:16px;border:1px solid var(--border)}
.toggle-tab{flex:1;padding:10px;text-align:center;border-radius:var(--radius-xs);font-size:13px;font-weight:600;color:var(--text3);transition:all .2s;cursor:pointer;background:none;border:none}
.toggle-tab.active{color:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
.toggle-tab.t-green.active{background:var(--green)}
.toggle-tab.t-red.active{background:var(--red)}
.toggle-tab.t-blue.active{background:var(--primary)}

.tx-list{display:flex;flex-direction:column;gap:6px}
.tx-item{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface2);border-radius:var(--radius-sm);border:1px solid var(--border);position:relative}
.tx-icon{width:36px;height:36px;border-radius:var(--radius-xs);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px}
.tx-icon.income{background:var(--green-bg);color:var(--green)}
.tx-icon.expense{background:var(--red-bg);color:var(--red)}
.tx-icon.card-icon{background:var(--purple-bg);color:var(--purple)}
.tx-info{flex:1;min-width:0}
.tx-desc{font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tx-meta{font-size:11px;color:var(--text3);margin-top:2px}
.tx-amount{font-family:var(--mono);font-size:15px;font-weight:600;text-align:right;flex-shrink:0}
.tx-amount.positive{color:var(--green)}.tx-amount.negative{color:var(--red)}
.tx-del{width:28px;height:28px;border-radius:6px;background:var(--red-bg);color:var(--red);display:none;align-items:center;justify-content:center;font-size:14px;cursor:pointer;border:none;flex-shrink:0}
.tx-item:hover .tx-del{display:flex}

.month-selector{display:flex;align-items:center;gap:8px;margin-bottom:16px;justify-content:center}
.month-btn{width:36px;height:36px;border-radius:50%;background:var(--surface2);color:var(--text2);display:flex;align-items:center;justify-content:center;transition:all .2s;border:none}
.month-btn:hover{background:var(--primary);color:#fff}
.month-label{font-size:16px;font-weight:700;min-width:180px;text-align:center}

.chart-bar-group{display:flex;align-items:flex-end;justify-content:space-around;height:150px;padding:0 4px}
.chart-col{display:flex;flex-direction:column;align-items:center;gap:4px;flex:1}
.chart-bars-pair{display:flex;gap:3px;align-items:flex-end;height:120px}
.chart-bar{width:16px;border-radius:3px 3px 0 0;transition:height .5s ease;min-height:2px}
.chart-bar.green{background:linear-gradient(to top,var(--green2),var(--green))}
.chart-bar.red{background:linear-gradient(to top,var(--red2),var(--red))}
.chart-lbl{font-size:9px;color:var(--text3);font-weight:500}

.bank-list{display:flex;flex-direction:column;gap:6px}
.bank-item{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--surface2);border-radius:var(--radius-sm);border:1px solid var(--border)}
.bank-name{font-size:13px;font-weight:500;color:var(--text2)}
.bank-balance{font-family:var(--mono);font-size:14px;font-weight:600}
.bank-balance.neg{color:var(--red)}

.card-summary{display:flex;flex-direction:column;gap:8px}
.card-sum-item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--surface2);border-radius:var(--radius-sm);border-left:3px solid var(--red);cursor:pointer;transition:all .2s}
.card-sum-item:hover{background:var(--surface3)}
.card-sum-item.paid{border-left-color:var(--green);opacity:0.6}
.card-sum-left{flex:1}
.card-sum-name{font-size:13px;font-weight:600}
.card-sum-details{font-size:11px;color:var(--text3);margin-top:2px}
.card-sum-amount{font-family:var(--mono);font-size:16px;font-weight:700;color:var(--red)}
.card-sum-item.paid .card-sum-amount{color:var(--green);text-decoration:line-through}

.pie-legend{display:flex;flex-direction:column;gap:8px}
.pie-item{display:flex;align-items:center;gap:8px;font-size:13px}
.pie-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.pie-bar{flex:1;height:6px;background:var(--surface3);border-radius:3px;overflow:hidden}
.pie-fill{height:100%;border-radius:3px;transition:width .5s ease}
.pie-pct{font-family:var(--mono);font-size:12px;color:var(--text3);min-width:40px;text-align:right}
.pie-val{font-family:var(--mono);font-size:12px;color:var(--text2);min-width:80px;text-align:right}

.empty{text-align:center;padding:40px 20px;color:var(--text3)}
.empty p{font-size:14px;margin-top:8px}

.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-100px);background:var(--green);color:#fff;padding:12px 24px;border-radius:var(--radius-sm);font-size:14px;font-weight:600;z-index:1000;transition:transform .3s ease;box-shadow:var(--shadow)}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.error{background:var(--red)}

.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border-radius:var(--radius) var(--radius) 0 0;width:100%;max-width:600px;max-height:85vh;overflow-y:auto;padding:20px;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:40px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 16px}
.modal-title{font-size:18px;font-weight:700;margin-bottom:16px}
@media(min-width:768px){.modal-overlay{align-items:center}.modal{border-radius:var(--radius);max-height:80vh}}

.config-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
.config-row:last-child{border-bottom:none}
.config-label{font-size:13px;color:var(--text2);flex:1}
.config-input{width:120px;padding:8px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-xs);color:var(--text);font-family:var(--mono);font-size:13px;text-align:right}
.config-select{width:160px;padding:8px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-xs);color:var(--text);font-size:12px;appearance:none}

.card-purchases-list{margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}

::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

.bk-stmt{margin-bottom:20px}
.bk-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius) var(--radius) 0 0}
.bk-name{font-size:15px;font-weight:700}
.bk-saldo-final{font-family:var(--mono);font-size:16px;font-weight:700}
.bk-table{width:100%;border-collapse:collapse;font-size:12px;background:var(--surface);border:1px solid var(--border);border-top:none}
.bk-table th{padding:8px 10px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text3);background:var(--surface2);border-bottom:1px solid var(--border);font-weight:600}
.bk-table th:nth-child(3),.bk-table th:nth-child(4),.bk-table th:nth-child(5){text-align:right}
.bk-table td{padding:7px 10px;border-bottom:1px solid rgba(255,255,255,0.03);vertical-align:middle}
.bk-table td:nth-child(3),.bk-table td:nth-child(4),.bk-table td:nth-child(5){text-align:right;font-family:var(--mono);font-size:12px;font-weight:500}
.bk-table tr:hover{background:var(--surface2)}
.bk-table tr.bk-saldo-row{background:var(--surface2);font-weight:700}
.bk-table tr.bk-saldo-row td{border-bottom:2px solid var(--border);padding:10px;font-size:13px}
.bk-credit{color:#3b82f6}
.bk-debit{color:#ef4444}
.bk-saldo-pos{color:var(--green)}.bk-saldo-neg{color:var(--red)}
.bk-desc{max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bk-cat{font-size:10px;color:var(--text3)}
.bk-st{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px}
.bk-st-ef{background:var(--green)}.bk-st-ag{background:var(--primary)}
.bk-table tr.bk-agendado{opacity:0.5}
.bk-footer{display:flex;justify-content:space-between;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius) var(--radius);font-size:12px}
.bk-footer-item{text-align:center;flex:1}
.bk-footer-label{font-size:10px;color:var(--text3);text-transform:uppercase}
/* Investimentos */
.inv-cot-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center}
.inv-cot-label{font-size:12px;color:var(--text3);font-weight:600;margin-bottom:4px}
.inv-cot-price{font-family:var(--mono);font-size:16px;font-weight:700}
.inv-cot-var{font-size:11px;font-weight:600;margin-top:2px}
.inv-cot-var.up{color:var(--green)}.inv-cot-var.down{color:var(--red)}
.inv-cot-time{font-size:9px;color:var(--text3);margin-top:2px}
.inv-tab{background:none;color:var(--text3)}.inv-tab.active{background:var(--primary);color:#fff}
.inv-ativo{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:10px}
.inv-ativo:hover{border-color:var(--primary)}
.inv-ativo-ticker{font-size:15px;font-weight:800;font-family:var(--mono)}
.inv-ativo-tipo{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600;text-transform:uppercase}
.inv-ativo-info{font-size:12px;color:var(--text3)}
.inv-ativo-val{text-align:right}
.inv-ativo-current{font-family:var(--mono);font-size:14px;font-weight:700}
.inv-ativo-gain{font-size:11px;font-weight:600}
.inv-div-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between}
</style>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
<!-- LOGIN SCREEN -->
<div id="loginScreen" style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px">
<div style="max-width:380px;width:100%;background:var(--surface);border-radius:var(--radius);padding:32px;border:1px solid var(--border)">
<div style="text-align:center;margin-bottom:24px">
<img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAC0ALQDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwDwaiiirKCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAzRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFW9O0y+1e7W10+1luZyM7IxnA9SegHueK9C0X4Uq+19Y1DnvBac49i54/IH60gPMqfHFJMcRRvIfRFLfyr6T0LwR4Y07aYdGtncf8tJ181vzbNei6XHFBGqwxRxKO0aBR+lFxXPi1tPvUGWs7hR6mFh/Sqx4ODwfQ19x3sjBCNxx9a8x8d31jYWTSXOhyamzZwkdqJAP95sfKKEwPmqpIYJbiQRwxvI5/hUZNbqnSdU1J5ZraOxYnC2cIKJ+LEkk+wxW7HHHBH5UMaRR/wB1BgH6+v41hVxCg7Jans4DKJYqPO5JR8tX/wAD+tDnbbw3M2DdSCP/AGE+Zvz6D9ay76KOG+nihz5aOVGTk8V3AIDAnoOTXBSv5s0kh/iYt+ZqaFSU5Ns1zbB0MJShCmtW3r10/wCHGUUUV1HhBRRRQAUUUUAFFFFABRRRQAUUUUAFdV4S8FXHiIPfXUpstGgbbNdFcl2/55xj+J/0HU07wF4Mk8X6w6zSG20qzXzr+6/55x+g/wBo4OPxPavRNR1WG7khtrCAWul2i+XZ2y8BE9T6sepNIRPZR2WnWostLtFtLMHJQHLyH+9I3Vj+g7AVr2chdgqglj0AGSazNMs2u4ZrqaaO2sbZd9xdSnCRj+p9q4XxP8R5JhJp3hrzLKx+690eLi4H1/gU+g59fSgD1DUvGeieGspqV8ouB/y7QjzJfxA+7+JFc9P8f47Y7dN0B5B2e6uNv/jqg/zrxDOck9T1oosB6/L+0DrExO7Q9O2+gkkz/OoT8ZYboMbrR5IpMHb5MwYE9uoBFeTVa07T5dRuhFH8qjmSQjhF9f8A61JtRV2XTpyqSUIK7ZrWyXHiXWZ9U1E7o9+6TsGPZB7Y/SuglkzulkIAAyT0AH+FJHFHbwRwQrshjGFB/Un3NcxrWr/aSba3b9yD8zD+M/4VwPmrz02PsYRpZRhby1m/xf8Akv63NX+1ba4srl4n+dI2O1uD061yNAorsp0lTvY+axuPni+VzWqCiiitThCiiigAooooAKKKKACiiigAp8UUk8yQxI0ksjBERRksxOAB+NMr0T4KaImr/EW2nmXMGnRtdkEcFxhU/wDHmB/4DSA7nWrKLwH4K03whbFft1you9TkX+Nj0XPpkYHsg9ayPDmk3Gv6vDYW5xu+aSTtGg6sf89cVT8Y6ydX8Y6pd7sp55ij/wBxPlH8s/jVi48QJ4U+Gt69uSuray32eOQHmOH+Ij8M/iw9KBGB8S/GUOp3K+HdDbZoOnttBU/8fUo6yMe4z0/PuMeeUV1XgGx06/1m5j1K1S5iW1ZlRycBty88Eds0DOVrutEZB4btshc/P2/2jUviPS9GtrO4a1sIonCEqVJ4P51jaXJc3mmw2dqDGqZ82dhwmSTgeppSkoq7LpUp1pqFNXbE1GJtTuY7K2ALqdztj5UX1JrZtbSHTrQQxcKPmd24Ln1P+eKVY7PSLI/N5cQOXdzlnb1PqfauW1XW5L8mKPMdvn7vdvr/AIVxNyxDtHSJ9VSpYfJqfPW96q+nb+ur+4n1fV3uQbe0D+T0aQKfn9h7fzrE8qT/AJ5v/wB8mvrf4VSJH8K9AyFz5Ddv+mjVvXl0gB6flXXCCgrI+ZxWLq4qo6lR6/kfFXlv/cf/AL5NIQR1BH1FfWt7dLk8D8q8H+LUgk8U2uMcWa5/77atDnOBooooGFFFFABRRRQAUUUUAFFFFABXsvwLH2RtencYk2QKPXBDN/hXjJ6H6V6poeo3PhjUTqUVpJdadfW8QuEgGXjZVGGA7jGfzrOU1FpPqdFLDTrU5Tgr8tvudznGnLSuxPLMSfqTVPxjeGa7s7YH93b24AHuf/1Cknu4RdS+UJtm9tu6JgcZ44+lVbqw1DVr0zQWU7KVA3Mm0ce5qnJLVsyhRqTfLGLb9Dtbz4e6HbopS8viSoPLJ6f7tc1p8tv4e8S38KNK6CPy4gF3O5JU4wK2ri41W9XFzdx2sYGDHa/O/wCLngfhWYL3T9OZo7WMy3DdRFl5HPu1YuutoK7PTpZRUS58TJU4+e/3E8trc6nLu1AmGHPFsjZZv99h0+gouNUgtNtpZQiaZRhYYh8qfU9qoXv9p3FnNLOwtIlQsIUOWb6ntVvQxFHokLKih23FmA5PJ61PsZVHeq/kdDzOhg4ungI69ZPf5f18jD1lLsok95NvkZsBF+6gx0FY9dD4icNBEP8AbP8AKueroSSVkeHOpKpJzm7tnrXhj4yQeH/Cun6M2jzzNaRlDKtwqhssT0xx1rt/D/jVvFWkXGorZSWkMU4gXfIH8xtu44wB0GP++q+dbO1nvryG0tYmluJnEccajlmJwBXuk8Nv4a06x8OWsiuNPjP2iReklw/Mh/A4H0FMg2LnUMg5avFPiBeC88VzYORFEkf6ZP8AOu/uNQARmZsKBkn0FeQX1017f3F03WWQt+GeP0oAgooopjCiiigAooooAKKKKACiiigAr0LTr6RtMsZo3I/chGx6rxXntdJ4avlKNYSHDE74c9z3X+tc2KhzQuuh7vD+IjSxLhJ/ErfPp/kdTLqV2rlPMGOx2isPW9VvreBHRg6s2GL849OOlab/ADxhu68H6VUurZLq2eB+jDr6Hsa4KbipJtH1eMp1Z05RpSs3t/X4HOSS3F2Mz3Mjqf4R8q/kKn0MiDVrgKMDysfqKqRB7WdrScbXU4B9alsn2apOf9n/AAr0oaOy2PhsXeVPml8V7O+/4mvqc26xuB6oag0yfbpMK+mf5mq97Lm2lGeqmobKTFjGv1/nWx543WZN8Uf+9/SsitK7SS4aKKKNpJHfaiIpLMT2AHU16d4V+H9t4Wij1vxTCk+o4D2mkk5CHs83/wAT+foEBH4M0L/hCdGXxPqUYGtXkZXS7VxzAhGDOw7HHQf48UnunZizMSxOSSeSfWtHWb261S/lvLyUyTSHknoB2AHYCsG7mjtoXllbaijJNMDP8RamYbAwK37yf5fovf8AwrjKs31499dvM/GeFX+6OwqtSGFLRRTAKKKKACiiigAooooAKKKKACrenT29veI13C0tueJFjba4Hqh7MOo7evFVKKQHpDadqEdol7Zf8TrTpBlLq1X96B6SRdQw74zWcNSsy5jM6xuDgpL8jD8DXO6J4gv9BuDJaSZjf/WQvyj/AOB9xzXap4yt9XjVZDC0mP8Aj3v4kmH/AAFnBz+h9q55YaEtVoe1h8+xVJKM7SXnv9/+ZjX9jbajEMyIJAPlkVgcf/Wrn3in026JuBuDDAdTkGu2a707difwxojn1+zvH/6C4FWre+0xGBi8L6Ch9Wtmk/8AQmNXTpShpfQ5sdj6eL972fLLunv6qxwq77/MFpHLcTOMLHDGXY/gBXZeH/hX4jv4ozqCw6Pb93uzmUj/AGYhz+eK6my8R6gqeVBLHaRHrHZwpAv/AI6BXQ6ZdFyCWJbuSa1PNH6R4b0jwbHu0m3MuoFcPqN0A0v/AAAdEH0rK1API7vIxZ2OSzHJJrq7xk+zGZ2VUA+ZmOAPxrzHxH480ixLxWbi+uBx+6P7sH3bv+GaAG6lLDaQPPcSLHGvVjXm2s6u+pz4QFLdT8iHqfc+9RarrF5rFx5t3JkD7sa8Kn0H9aoUAFAopaBhRRRTAKKKKACiiigAooooAKKKKACiiigAooooAswahd2wCxXDhR/CTkfkavR+I7yPqkDf8BI/kayKKQHRx+M76IfJbW+ffcf61KfiBr6qRBNDB7pECf1zXL0UAXtR1vVNXbOoahc3I7LJISo+g6CqFGKWgBKWiimAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUgCiiimAUUUUgCiiimAUUUUAFFFFABRRRQAUUUUAFFFFIAooopgFFFFABRRRQAUUUUgCiiimAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAH/2Q==" width="120" height="120" style="margin-bottom:8px;border-radius:16px">
<p style="font-size:13px;color:var(--text3);margin-top:4px">Fa√ßa login ou crie sua conta</p>
<div style="margin-top:10px">
<a href="guia.html" target="_blank" style="display:inline-flex;align-items:center;gap:6px;padding:10px 20px;background:linear-gradient(135deg,var(--primary),#991111);color:#fff;border-radius:10px;font-size:13px;font-weight:600;text-decoration:none;font-family:var(--font)">üìñ Como usar o app?</a>
</div>
</div>
<button onclick="doGoogleLogin()" style="width:100%;padding:12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface2);color:var(--text);font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:16px;font-family:var(--font)">
<svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
Entrar com Google
</button>
<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px"><div style="flex:1;height:1px;background:var(--border)"></div><span style="font-size:12px;color:var(--text3)">ou</span><div style="flex:1;height:1px;background:var(--border)"></div></div>
<div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="loginEmail" placeholder="seu@email.com" autocomplete="email"></div>
<div class="form-group"><label class="form-label">Senha</label><input type="password" class="form-input" id="loginPass" placeholder="M√≠nimo 6 caracteres" autocomplete="current-password"></div>
<button class="btn btn-primary" onclick="doEmailLogin()" style="margin-bottom:10px">Entrar</button>
<button class="btn btn-outline" onclick="doEmailRegister()">Criar Conta</button>
<div id="loginMsg" style="margin-top:14px;text-align:center;font-size:13px;display:none;padding:10px;border-radius:var(--radius-sm)"></div>
<div id="lgpdCheck" style="margin-top:14px;display:flex;align-items:flex-start;gap:8px">
<input type="checkbox" id="acceptLgpd" style="margin-top:2px;accent-color:var(--primary);width:16px;height:16px;flex-shrink:0;cursor:pointer">
<label for="acceptLgpd" style="font-size:11px;color:var(--text3);line-height:1.5;cursor:pointer">Li e concordo com a <a href="javascript:void(0)" onclick="openLgpd()" style="color:var(--primary);text-decoration:underline">Pol√≠tica de Privacidade e Seguran√ßa</a> e autorizo o tratamento dos meus dados conforme a LGPD.</label>
</div>
<div style="margin-top:14px;text-align:center;font-size:11px;color:var(--text3);line-height:1.6">
üîí Seus dados ficam salvos na nuvem com criptografia.<br>S√≥ voc√™ tem acesso. <a href="javascript:void(0)" onclick="openLgpd()" style="color:var(--primary);text-decoration:underline">Saiba mais</a>
</div>
</div>
</div>

<div class="app" id="appContainer" style="display:none">
<header class="app-header">
<div class="app-logo">
<img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAAoACgDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwDwaiium8M+Go9SjN/qMhhsELd9pfaMsc9lUEZPqQBzVFHM5x1NHWvS7Txvo9hbzWuieBtLu7dSEae7QNIxPTA5Iz7k1yeqXcMEdxbxW0aSzEtJ5SjbHk525xzgcVMpWaSN6NHnjKcnZL8X0XqzAoooqzAK7Rrhf7B06CTmwW3WOVEcgyZdnxwOPmZc/wC7XF1rafrKW1obS5t/OhJOCrYIz1Hof0qJqX2TowzoJv26bXS3fz8i/dXeywZo32OluixsAA23kAe3Hfrz1rrLvxbqdn8NV0fUvKWT7MLeGJY9rJGRhQ3q2Mk+nFYmjeJPC+kI07aPc3V4q/uWlcEIex54/HBNczrGsXGtXrXE4CDJ2xr0X/E+9NRSMp1JTsnstkZ9FFFUQFFFFABRRRQAUUUUAf/Z" width="32" height="32" style="border-radius:6px">
<span>Gileno - Gest√£o Financeira</span>
</div>
<div class="header-actions">
<span id="headerUser" style="font-size:11px;color:var(--text3);margin-right:4px"></span>
<button class="btn-icon" onclick="toggleTheme()" id="themeToggleBtn" title="Alternar tema claro/escuro"><span id="themeIcon">‚òÄÔ∏è</span></button>
<button class="btn-icon" onclick="exportCSV()" title="Exportar CSV"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg></button>
<button class="btn-icon" onclick="doLogout()" title="Sair" style="color:var(--red)"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg></button>
</div>
</header>

<main class="main">

<!-- DASHBOARD -->
<div class="page active" id="page-dash">
<div id="appUserHeader" style="text-align:center;margin-bottom:8px;font-size:13px;color:var(--text3)"></div>
<div class="month-selector">
<button class="month-btn" onclick="chgMonth(-1)">‚Äπ</button>
<div class="month-label" id="ml1"></div>
<button class="month-btn" onclick="chgMonth(1)">‚Ä∫</button>
</div>
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
<div></div>
<button onclick="toggleValVis()" id="btnVisToggle" style="background:none;border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 12px;color:var(--text2);font-size:12px;display:flex;align-items:center;gap:6px;cursor:pointer;font-family:var(--font)">
<span id="visIcon">üëÅÔ∏è</span> <span id="visLabel">Ocultar valores</span>
</button>
</div>
<div class="kpi-grid">
<div class="kpi green"><div class="kpi-label">Receitas</div><div class="kpi-value kpi-val-hide" id="k1">-</div></div>
<div class="kpi red"><div class="kpi-label">Despesas</div><div class="kpi-value kpi-val-hide" id="k2">-</div></div>
<div class="kpi" id="kpiResult"><div class="kpi-label">Resultado</div><div class="kpi-value kpi-val-hide" id="k3">-</div></div>
<div class="kpi orange"><div class="kpi-label">Cart√µes</div><div class="kpi-value kpi-val-hide" id="k4">-</div></div>
</div>
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--primary)"></div>Receitas vs Despesas (6 meses)</div>
<div class="chart-bar-group" id="chartBars"></div>
</div>
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--red)"></div>Despesas por Categoria</div>
<div style="display:flex;align-items:flex-start;gap:16px;flex-wrap:wrap">
<canvas id="pieDesp" style="flex-shrink:0"></canvas>
<div style="flex:1;min-width:200px" id="catBreakDesp"></div>
</div>
<div class="empty" id="catEmpty" style="display:none"><p>Nenhuma despesa registrada</p></div>
</div>
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--green)"></div>Receitas por Categoria</div>
<div style="display:flex;align-items:flex-start;gap:16px;flex-wrap:wrap">
<canvas id="pieRec" style="flex-shrink:0"></canvas>
<div style="flex:1;min-width:200px" id="catBreakRec"></div>
</div>
<div class="empty" id="catEmptyRec" style="display:none"><p>Nenhuma receita registrada</p></div>
</div>
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--green)"></div>Saldo das Contas</div>
<div class="bank-list" id="bankList"></div>
</div>
<div class="card" id="dashAgendaCard">
<div class="card-title" style="display:flex;justify-content:space-between;align-items:center"><div style="display:flex;align-items:center;gap:8px"><div class="dot" style="background:var(--purple)"></div>Pr√≥ximos Compromissos</div><button onclick="goPage('agenda')" style="background:none;border:none;color:var(--primary);font-size:11px;cursor:pointer;font-family:var(--font)">Ver todos ‚Üí</button></div>
<div id="dashAgendaList"></div>
<div id="dashAgendaEmpty" style="display:none;text-align:center;padding:12px;color:var(--text3);font-size:12px">üìÖ Nenhum compromisso pr√≥ximo</div>
</div>
</div>

<!-- EXTRATO -->
<div class="page" id="page-ext">
<div class="month-selector">
<button class="month-btn" onclick="chgMonth(-1)">‚Äπ</button>
<div class="month-label" id="ml2"></div>
<button class="month-btn" onclick="chgMonth(1)">‚Ä∫</button>
</div>
<div class="toggle-tabs">
<button class="toggle-tab t-blue active" onclick="setFilter('all',this)">Todos</button>
<button class="toggle-tab t-green" onclick="setFilter('Receita',this)">Receitas</button>
<button class="toggle-tab t-red" onclick="setFilter('Despesa',this)">Despesas</button>
<button class="toggle-tab t-blue" onclick="setFilter('Cartao',this)">üí≥ Cart√µes</button>
<button class="toggle-tab t-blue" onclick="setFilter('Conta',this)">üè¶ Conta</button>
</div>
<div id="extSubFilter" style="display:none;margin-bottom:12px">
<select class="form-input" id="extSubSel" onchange="rExt()" style="font-size:13px;padding:8px 10px"></select>
</div>
<!-- Vista padr√£o -->
<div id="extDefault">
<div class="tx-list" id="txList"></div>
<div class="empty" id="txEmpty" style="display:none"><p>Nenhum lan√ßamento neste m√™s.<br>Toque em + para adicionar.</p></div>
</div>
<!-- Vista Extrato Banc√°rio -->
<div id="extBankView" style="display:none">
<div id="extBankContent"></div>
</div>
</div>

<!-- NOVO LAN√áAMENTO -->
<div class="page" id="page-add">
<h2 style="font-size:20px;font-weight:700;margin-bottom:16px">Novo Lan√ßamento</h2>

<!-- Tipo: Receita ou Despesa -->
<div class="toggle-tabs" id="addTabs">
<button class="toggle-tab t-green active" onclick="setAddType('Receita',this)">üí∞ Receita</button>
<button class="toggle-tab t-red" onclick="setAddType('Despesa',this)">üí∏ Despesa</button>
<button class="toggle-tab t-blue" onclick="setAddType('Transf',this)">üîÑ Transfer√™ncia</button>
</div>

<!-- Data e M√™s -->
<div class="form-row">
<div class="form-group"><label class="form-label">Data</label><input type="date" class="form-input" id="fDate"></div>
<div class="form-group"><label class="form-label">M√™s Refer√™ncia</label><select class="form-input" id="fMonth"></select></div>
</div>

<!-- Descri√ß√£o -->
<div class="form-group"><label class="form-label">Descri√ß√£o</label><input type="text" class="form-input" id="fDesc" placeholder="Ex: Supermercado, Aluguel, Sal√°rio..."></div>

<!-- Destino: Conta ou Cart√£o (s√≥ aparece em Despesa) -->
<div id="destinoRow">
<label class="form-label">Onde foi pago?</label>
<div class="toggle-tabs" id="destinoTabs" style="margin-bottom:14px">
<button class="toggle-tab t-blue active" onclick="setDestino('conta',this)">üè¶ Conta Banc√°ria</button>
<button class="toggle-tab t-blue" onclick="setDestino('cartao',this)">üí≥ Cart√£o de Cr√©dito</button>
</div>
</div>

<!-- Op√ß√µes CONTA -->
<div id="contaFields">
<div class="form-group"><label class="form-label">Banco/Conta</label><select class="form-input" id="fBanco"></select></div>
<div class="form-group"><label class="form-label">Frequ√™ncia</label>
<div class="toggle-tabs" id="contaFreqTabs">
<button class="toggle-tab t-blue active" onclick="setContaFreq('unico',this)">√önico</button>
<button class="toggle-tab t-blue" onclick="setContaFreq('recorrente',this)">‚ôªÔ∏è Recorrente</button>
</div></div>
<div id="contaRecRow" style="display:none">
<div class="form-row">
<div class="form-group"><label class="form-label">Repetir a cada</label>
<div style="display:flex;gap:6px"><input type="number" class="form-input" id="fRecIntervalo" value="1" min="1" max="365" style="width:70px;text-align:center" oninput="calcContaRec()"><select class="form-input" id="fRecUnidade" onchange="calcContaRec()" style="flex:1">
<option value="dias">Dia(s)</option>
<option value="semanas">Semana(s)</option>
<option value="quinzenas">Quinzena(s)</option>
<option value="meses" selected>M√™s(es)</option>
</select></div></div>
<div class="form-group"><label class="form-label">Repeti√ß√µes</label><input type="number" class="form-input" id="fRecQtd" value="12" min="2" max="365" oninput="calcContaRec()"></div>
</div>
<div id="contaRecPreview" style="background:var(--primary-glow);border:1px solid rgba(59,130,246,0.3);border-radius:var(--radius-sm);padding:12px;margin-bottom:14px;text-align:center">
<span style="font-size:13px;color:var(--text2)" id="contaRecPreviewText"></span>
</div>
</div>
</div>

<!-- Op√ß√µes CART√ÉO -->
<div id="cartaoFields" style="display:none">
<div class="form-group"><label class="form-label">Cart√£o</label><select class="form-input" id="fCartao"></select></div>
<div class="form-row">
<div class="form-group"><label class="form-label">Compra</label>
<select class="form-input" id="fCompTipo" onchange="toggleAddParc()">
<option>√Ä Vista</option><option>Parcelado</option><option>Recorrente</option>
</select></div>
<div class="form-group" id="fParcRow" style="display:none"><label class="form-label" id="fParcLabel">N¬∫ Parcelas</label><input type="number" class="form-input" id="fParcT" value="2" min="2" max="48" oninput="calcAddParc()"></div>
</div>
<div id="fParcModeRow" style="display:none;margin-bottom:14px">
<label class="form-label">Informar valor por:</label>
<div class="toggle-tabs" style="margin-bottom:0">
<button class="toggle-tab t-blue active" id="btnModeTotal" onclick="setParcMode('total',this)">üí∞ Valor Total</button>
<button class="toggle-tab t-blue" id="btnModeParcela" onclick="setParcMode('parcela',this)">üìë Valor da Parcela</button>
</div>
</div>
<div id="fParcPreview" style="display:none;background:var(--primary-glow);border:1px solid rgba(59,130,246,0.3);border-radius:var(--radius-sm);padding:12px;margin-bottom:14px;text-align:center">
<span style="font-size:13px;color:var(--text2)" id="fParcPreviewText"></span>
</div>
</div>

<!-- Op√ß√µes TRANSFER√äNCIA -->
<div id="transfFields" style="display:none">
<div class="form-group"><label class="form-label">Conta Origem (d√©bito)</label><select class="form-input" id="fTransfOrigem"></select></div>
<div style="text-align:center;padding:4px 0;font-size:18px">‚¨áÔ∏è</div>
<div class="form-group"><label class="form-label">Conta Destino (cr√©dito)</label><select class="form-input" id="fTransfDestino"></select></div>
</div>

<!-- Valor -->
<div class="form-group"><label class="form-label" id="fValorLabel">Valor</label><div class="valor-input-wrap"><span class="valor-prefix">R$</span><input type="number" step="0.01" min="0" class="form-input" id="fValor" placeholder="0,00" inputmode="decimal" oninput="calcAddParc();calcContaRec()"></div></div>

<!-- Categoria e Subcategoria -->
<div class="form-group">
<label class="form-label">Categoria</label>
<select class="form-input" id="fCat" onchange="onCatChange()"></select>
</div>
<div class="form-group" id="fSubCatRow" style="display:none">
<label class="form-label">Subcategoria</label>
<select class="form-input" id="fSubCat"></select>
</div>

<!-- Status -->
<div class="form-group">
<label class="form-label">Status</label>
<div class="toggle-tabs" id="statusTabs">
<button class="toggle-tab t-green active" onclick="setStatus('efetivado',this)">‚úÖ Efetivado</button>
<button class="toggle-tab t-blue" onclick="setStatus('agendado',this)">üïê Agendado</button>
</div>
</div>

<!-- Bot√£o Salvar -->
<button class="btn btn-green" onclick="saveTx()" id="btnSave">‚úì Salvar Lan√ßamento</button>
</div>

<!-- AGENDA -->
<div class="page" id="page-agenda">
<h2 style="font-size:20px;font-weight:700;margin-bottom:16px">üìÖ Agenda</h2>

<!-- Month selector -->
<div class="month-selector">
<button class="month-btn" onclick="chgMonth(-1)">‚Äπ</button>
<div class="month-label"></div>
<button class="month-btn" onclick="chgMonth(1)">‚Ä∫</button>
</div>

<!-- Calendar Grid -->
<div id="agendaCal" style="margin-bottom:16px"></div>

<!-- Quick Actions -->
<div style="display:flex;gap:8px;margin-bottom:16px">
<button class="btn btn-primary btn-sm" onclick="openAgendaAdd()" style="flex:1">+ Novo Compromisso</button>
</div>

<!-- Events for selected day -->
<div id="agendaDayTitle" style="font-size:14px;font-weight:700;margin-bottom:8px;display:none"></div>
<div id="agendaDayEvents"></div>

<!-- Upcoming Section -->
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--primary)"></div>Pr√≥ximos Compromissos</div>
<div id="agendaUpcoming"></div>
<div class="empty" id="agendaEmpty" style="display:none"><p>Nenhum compromisso agendado</p></div>
</div>

<!-- Overdue Section -->
<div class="card" id="agendaOverdueCard" style="display:none">
<div class="card-title"><div class="dot" style="background:var(--red)"></div>‚ö†Ô∏è Vencidos / Pendentes</div>
<div id="agendaOverdue"></div>
</div>
</div>



<!-- CART√ïES (visualiza√ß√£o) -->
<div class="page" id="page-card">
<div class="month-selector">
<button class="month-btn" onclick="chgMonth(-1)">‚Äπ</button>
<div class="month-label" id="ml3"></div>
<button class="month-btn" onclick="chgMonth(1)">‚Ä∫</button>
</div>
<div class="kpi-grid" style="grid-template-columns:1fr">
<div class="kpi red"><div class="kpi-label">Total Faturas do M√™s</div><div class="kpi-value" id="kCard">-</div></div>
</div>
<div class="card-summary" id="cardSum"></div>
<button class="btn btn-primary" style="margin-top:16px" onclick="goPage('add');setAddType('Despesa',document.querySelector('#addTabs .t-red'));setTimeout(()=>setDestino('cartao',document.querySelector('#destinoTabs .toggle-tab:last-child')),100)">+ Nova Compra no Cart√£o</button>
</div>

<!-- CONFIG -->
<div class="page" id="page-cfg">
<h2 style="font-size:20px;font-weight:700;margin-bottom:16px">Configura√ß√µes</h2>
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--primary)"></div>Perfil</div>
<div class="form-group"><label class="form-label">Seu Nome</label><div style="display:flex;gap:8px"><input type="text" class="form-input" id="cfgUserName" placeholder="Ex: Maria" style="flex:1"><button class="btn btn-outline btn-sm" onclick="saveUserName()">Salvar</button></div></div>
</div>
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--orange)"></div>Saldos Iniciais (Final Jan/2026)</div>
<div id="cfgBancos"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" class="form-input" id="newBanco" placeholder="Novo banco..." style="flex:1;padding:8px 10px;font-size:13px"><button class="btn btn-outline btn-sm" onclick="addBancoCfg()">+ Banco</button></div>
<button class="btn btn-outline btn-sm" style="margin-top:12px" onclick="saveBankCfg()">Salvar Saldos</button>
</div>
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--purple)"></div>Cart√µes de Cr√©dito</div>
<div id="cfgCards"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" class="form-input" id="newCartao" placeholder="Novo cart√£o..." style="flex:1;padding:8px 10px;font-size:13px"><button class="btn btn-outline btn-sm" onclick="addCartaoCfg()">+ Cart√£o</button></div>
<button class="btn btn-outline btn-sm" style="margin-top:12px" onclick="saveCardCfg()">Salvar Cart√µes</button>
</div>
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--green)"></div>Categorias de Receita</div>
<div id="cfgCatsR"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" class="form-input" id="newCatR" placeholder="Nova categoria..." style="flex:1;padding:8px 10px;font-size:13px"><button class="btn btn-outline btn-sm" onclick="addCatR()">+ Adicionar</button></div>
</div>
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--red)"></div>Categorias de Despesa</div>
<div id="cfgCatsD"></div>
<div style="display:flex;gap:8px;margin-top:10px"><input type="text" class="form-input" id="newCatD" placeholder="Nova categoria..." style="flex:1;padding:8px 10px;font-size:13px"><button class="btn btn-outline btn-sm" onclick="addCatD()">+ Adicionar</button></div>
</div>
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--green)"></div>Exportar / Importar</div>
<button class="btn btn-primary btn-sm" onclick="exportJSON()" style="margin-bottom:8px">üì• Backup JSON</button>
<button class="btn btn-outline btn-sm" onclick="exportCSV()" style="margin-bottom:8px">üìä Exportar CSV (Excel)</button>
<button class="btn btn-outline btn-sm" onclick="$('impFile').click()">üì§ Importar Backup</button>
<input type="file" id="impFile" accept=".json" style="display:none" onchange="importJSON(event)">
<p style="font-size:11px;color:var(--text3);margin-top:8px;text-align:center">Dados salvos automaticamente no navegador (localStorage)</p>
</div>
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--green)"></div>API de Cota√ß√µes (Investimentos)</div>
<p style="font-size:12px;color:var(--text3);margin-bottom:8px">Para ver cota√ß√µes de a√ß√µes e Ibovespa, cadastre-se gr√°tis em <a href="https://brapi.dev" target="_blank" style="color:var(--blue)">brapi.dev</a> e cole seu token aqui:</p>
<div style="display:flex;gap:8px">
<input class="form-input" id="cfgBrapiToken" placeholder="Cole seu token da brapi.dev aqui" style="flex:1;font-size:12px">
<button onclick="saveBrapiToken()" class="btn btn-green btn-sm">Salvar</button>
</div>
<p id="cfgBrapiStatus" style="font-size:11px;color:var(--text3);margin-top:6px"></p>
</div>
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--red)"></div>Zona de Perigo</div>
<button class="btn btn-red btn-sm" onclick="if(confirm('‚ö†Ô∏è Apagar TODOS os dados? N√£o pode ser desfeito!')) clearAll()">üóëÔ∏è Limpar Todos os Dados</button>
</div>
<div class="card">
<div class="card-title"><div class="dot" style="background:var(--text3)"></div>Legal</div>
<button class="btn btn-outline btn-sm" onclick="openLgpd()" style="margin-bottom:8px">üîí Pol√≠tica de Privacidade e Seguran√ßa (LGPD)</button>
<p style="font-size:11px;color:var(--text3);margin-top:4px">Seus dados s√£o protegidos conforme a Lei Geral de Prote√ß√£o de Dados.</p>
</div>
</div>


<!-- INVESTIMENTOS -->
<div class="page" id="page-invest">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
<div>
<h2 style="font-size:20px;font-weight:700;margin-bottom:2px">üìà Investimentos</h2>
<p style="font-size:12px;color:var(--text3)">Cota√ß√µes e carteira pessoal</p>
</div>
<button onclick="refreshCotacoes()" style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 14px;color:var(--text2);font-size:12px;cursor:pointer;font-family:var(--font);display:flex;align-items:center;gap:5px">üîÑ Atualizar</button>
</div>

<!-- COTA√á√ïES R√ÅPIDAS -->
<div id="cotacoesGrid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px">
<div class="inv-cot-card"><div class="inv-cot-label">üíµ D√≥lar</div><div class="inv-cot-price" id="cotUSD">--</div><div class="inv-cot-var" id="cotUSDvar">--</div><div class="inv-cot-time" id="cotUSDtime"></div></div>
<div class="inv-cot-card"><div class="inv-cot-label">üí∂ Euro</div><div class="inv-cot-price" id="cotEUR">--</div><div class="inv-cot-var" id="cotEURvar">--</div><div class="inv-cot-time" id="cotEURtime"></div></div>
<div class="inv-cot-card"><div class="inv-cot-label">‚Çø Bitcoin</div><div class="inv-cot-price" id="cotBTC">--</div><div class="inv-cot-var" id="cotBTCvar">--</div><div class="inv-cot-time" id="cotBTCtime"></div></div>
<div class="inv-cot-card"><div class="inv-cot-label">üìä Ibovespa</div><div class="inv-cot-price" id="cotIBOV">--</div><div class="inv-cot-var" id="cotIBOVvar">--</div><div class="inv-cot-time" id="cotIBOVtime"></div></div>
</div>

<!-- TOP A√á√ïES -->
<div style="margin-bottom:16px">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
<span style="font-size:13px;font-weight:700;color:var(--text2)">üè¶ Principais A√ß√µes</span>
<span id="cotLastUpdate" style="font-size:10px;color:var(--text3)"></span>
</div>
<div id="topAcoesList" style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px">
</div>
</div>

<!-- TABS: Carteira / Opera√ß√µes / Dividendos -->
<div style="display:flex;gap:4px;margin-bottom:12px;background:var(--surface);border-radius:var(--radius-sm);padding:3px;border:1px solid var(--border)">
<button onclick="setInvTab('carteira')" id="invTabCarteira" class="inv-tab active" style="flex:1;padding:8px;border:none;border-radius:var(--radius-xs);font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font);transition:all .2s">üíº Carteiras</button>
<button onclick="setInvTab('operacoes')" id="invTabOperacoes" class="inv-tab" style="flex:1;padding:8px;border:none;border-radius:var(--radius-xs);font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font);transition:all .2s">üìã Opera√ß√µes</button>
<button onclick="setInvTab('dividendos')" id="invTabDividendos" class="inv-tab" style="flex:1;padding:8px;border:none;border-radius:var(--radius-xs);font-size:12px;font-weight:700;cursor:pointer;font-family:var(--font);transition:all .2s">üí∞ Dividendos</button>
</div>

<!-- CARTEIRAS -->
<div id="invCarteira">
<div id="invResumoGeral" style="margin-bottom:12px"></div>
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
<select id="invCarteiraSelect" onchange="rInvestCarteira()" class="form-input" style="flex:1;max-width:200px;font-size:13px;font-weight:700"></select>
<div style="display:flex;gap:4px">
<button onclick="addCarteira()" style="background:var(--primary);color:#fff;border:none;border-radius:var(--radius-xs);padding:6px 10px;font-size:11px;font-weight:700;cursor:pointer;font-family:var(--font)">+ Nova</button>
<button onclick="renameCarteira()" style="background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-xs);padding:6px 8px;font-size:11px;cursor:pointer;font-family:var(--font);color:var(--text2)">‚úèÔ∏è</button>
<button onclick="delCarteira()" style="background:var(--red-bg);border:1px solid rgba(239,68,68,0.3);border-radius:var(--radius-xs);padding:6px 8px;font-size:11px;cursor:pointer;font-family:var(--font);color:var(--red)">üóëÔ∏è</button>
</div>
</div>
<div id="invResumo" style="margin-bottom:12px"></div>
<div id="invCarteiraList"></div>
<div style="text-align:center;margin-top:12px">
<button onclick="openInvOp('compra')" style="background:var(--green);color:#fff;border:none;border-radius:var(--radius-sm);padding:10px 18px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font);margin-right:8px">+ Compra</button>
<button onclick="openInvOp('venda')" style="background:var(--red);color:#fff;border:none;border-radius:var(--radius-sm);padding:10px 18px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font)">‚àí Venda</button>
</div>
</div>

<!-- OPERA√á√ïES (hist√≥rico) -->
<div id="invOperacoes" style="display:none">
<div id="invOpList"></div>
</div>

<!-- DIVIDENDOS -->
<div id="invDividendos" style="display:none">
<div id="invDivResumo" style="margin-bottom:12px"></div>
<div id="invDivList"></div>
<div style="text-align:center;margin-top:12px">
<button onclick="openDivAdd()" style="background:var(--green);color:#fff;border:none;border-radius:var(--radius-sm);padding:10px 24px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font)">+ Registrar Dividendo</button>
</div>
</div>
</div>

<!-- Modal Opera√ß√£o (Compra/Venda) -->
<div id="invOpModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;padding:20px">
<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;width:100%;max-width:400px">
<h3 style="font-size:16px;font-weight:700;margin-bottom:16px" id="invOpTitle">Compra de Ativo</h3>
<div class="form-group"><label class="form-label">Carteira</label><select class="form-input" id="invOpCarteira"></select></div>
<div class="form-group"><label class="form-label">Ticker (c√≥digo)</label><input class="form-input" id="invOpTicker" placeholder="Ex: PETR4, VALE3" style="text-transform:uppercase"></div>
<div class="form-group"><label class="form-label">Tipo de ativo</label><select class="form-input" id="invOpTipo"><option value="acao">A√ß√£o</option><option value="fii">FII</option><option value="bdr">BDR</option><option value="etf">ETF</option><option value="crypto">Cripto</option></select></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div class="form-group"><label class="form-label">Quantidade</label><input class="form-input" id="invOpQtd" type="number" placeholder="100" min="1" step="1"></div>
<div class="form-group"><label class="form-label">Pre√ßo unit√°rio (R$)</label><input class="form-input" id="invOpPreco" type="number" placeholder="28.50" min="0" step="0.01"></div>
</div>
<div class="form-group"><label class="form-label">Data da opera√ß√£o</label><input class="form-input" id="invOpData" type="date"></div>
<div style="display:flex;gap:8px;margin-top:16px">
<button onclick="closeInvOp()" style="flex:1;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px;cursor:pointer;font-family:var(--font)">Cancelar</button>
<button id="invOpSaveBtn" onclick="saveInvOp()" style="flex:1;padding:10px;border:none;border-radius:var(--radius-sm);color:#fff;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font)">Salvar</button>
</div>
</div>
</div>

<!-- Modal Registrar Dividendo -->
<div id="divAddModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center;padding:20px">
<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;width:100%;max-width:400px">
<h3 style="font-size:16px;font-weight:700;margin-bottom:16px">Registrar Dividendo</h3>
<div class="form-group"><label class="form-label">Ticker</label><select class="form-input" id="divTicker"></select></div>
<div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="divTipoRend"><option value="dividendo">Dividendo</option><option value="jcp">JCP</option><option value="rendimento">Rendimento FII</option><option value="bonificacao">Bonifica√ß√£o</option></select></div>
<div class="form-group"><label class="form-label">Valor total (R$)</label><input class="form-input" id="divValor" type="number" placeholder="Ex: 150.00" min="0" step="0.01"></div>
<div class="form-group"><label class="form-label">Data</label><input class="form-input" id="divData" type="date"></div>
<div style="display:flex;gap:8px;margin-top:16px">
<button onclick="closeDivAdd()" style="flex:1;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:13px;cursor:pointer;font-family:var(--font)">Cancelar</button>
<button onclick="saveDividendo()" style="flex:1;padding:10px;background:var(--green);border:none;border-radius:var(--radius-sm);color:#fff;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font)">Salvar</button>
</div>
</div>
</div>

<!-- SOBRE -->
<div class="page" id="page-sobre">
<h2 style="font-size:20px;font-weight:700;margin-bottom:16px">üè¢ Sobre N√≥s</h2>

<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
<span style="font-size:28px">üéØ</span>
<h3 style="font-size:18px;font-weight:800;color:var(--primary)">Miss√£o</h3>
</div>
<p style="font-size:14px;color:var(--text2);line-height:1.8">Tornar a gest√£o financeira pessoal simples e acess√≠vel para todos ‚Äî tanto para quem j√° se organiza em planilhas e busca uma ferramenta mais completa, quanto para quem nunca controlou suas finan√ßas e n√£o sabe por onde come√ßar. Acreditamos que clareza e organiza√ß√£o s√£o os primeiros passos para a liberdade financeira.</p>
</div>

<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
<span style="font-size:28px">üî≠</span>
<h3 style="font-size:18px;font-weight:800;color:var(--primary)">Vis√£o</h3>
</div>
<p style="font-size:14px;color:var(--text2);line-height:1.8">Ser a ferramenta de gest√£o financeira pessoal mais simples e confi√°vel do Brasil, ajudando milhares de pessoas a enxergarem com clareza para onde vai cada centavo ‚Äî e a tomarem decis√µes melhores sobre seu dinheiro.</p>
</div>

<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
<span style="font-size:28px">üíé</span>
<h3 style="font-size:18px;font-weight:800;color:var(--primary)">Valores</h3>
</div>

<div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:14px;padding:12px;background:var(--surface2);border-radius:12px;border-left:3px solid var(--primary)">
<span style="font-size:22px">‚ú®</span>
<div><div style="font-size:14px;font-weight:700;margin-bottom:2px">Simplicidade</div><div style="font-size:13px;color:var(--text3);line-height:1.6">Se n√£o √© f√°cil de usar, n√£o serve. Qualquer pessoa precisa conseguir usar desde o primeiro minuto.</div></div>
</div>

<div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:14px;padding:12px;background:var(--surface2);border-radius:12px;border-left:3px solid var(--green)">
<span style="font-size:22px">üîç</span>
<div><div style="font-size:14px;font-weight:700;margin-bottom:2px">Clareza</div><div style="font-size:13px;color:var(--text3);line-height:1.6">Seus n√∫meros, seus gr√°ficos, seu extrato. Tudo vis√≠vel, organizado e sem surpresas.</div></div>
</div>

<div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:14px;padding:12px;background:var(--surface2);border-radius:12px;border-left:3px solid var(--red)">
<span style="font-size:22px">üîí</span>
<div><div style="font-size:14px;font-weight:700;margin-bottom:2px">Privacidade</div><div style="font-size:13px;color:var(--text3);line-height:1.6">Seus dados s√£o s√≥ seus. Sem an√∫ncios, sem compartilhamento, sem pegadinhas.</div></div>
</div>

<div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:14px;padding:12px;background:var(--surface2);border-radius:12px;border-left:3px solid #f59e0b">
<span style="font-size:22px">üåç</span>
<div><div style="font-size:14px;font-weight:700;margin-bottom:2px">Acessibilidade</div><div style="font-size:13px;color:var(--text3);line-height:1.6">Gratuito, sem barreiras. Funciona no celular, no computador, pra qualquer pessoa.</div></div>
</div>

<div style="display:flex;align-items:flex-start;gap:12px;padding:12px;background:var(--surface2);border-radius:12px;border-left:3px solid var(--purple)">
<span style="font-size:22px">üöÄ</span>
<div><div style="font-size:14px;font-weight:700;margin-bottom:2px">Evolu√ß√£o cont√≠nua</div><div style="font-size:13px;color:var(--text3);line-height:1.6">O app cresce com quem usa. Cada sugest√£o √© ouvida, cada melhoria √© pra voc√™.</div></div>
</div>

</div>
</div>

<!-- SUGEST√ïES -->
<div class="page" id="page-sug">
<h2 style="font-size:20px;font-weight:700;margin-bottom:6px">üí° Sugest√µes e Feedback</h2>
<p style="font-size:13px;color:var(--text3);margin-bottom:16px">Ajude a melhorar o app! Registre ideias, problemas ou sugest√µes.</p>

<div class="form-group"><label class="form-label">Tipo</label>
<select class="form-input" id="sugTipo">
<option>üí° Ideia / Melhoria</option>
<option>üêõ Bug / Problema</option>
<option>‚≠ê Elogio</option>
<option>‚ùì D√∫vida</option>
</select></div>
<div class="form-group"><label class="form-label">Sua sugest√£o</label><textarea class="form-input" id="sugTexto" rows="4" placeholder="Descreva aqui..." style="resize:vertical;font-family:var(--font)"></textarea></div>
<button class="btn btn-primary" onclick="saveSug()">üì© Enviar Sugest√£o</button>

<div style="margin-top:20px">
<div class="card-title"><div class="dot" style="background:var(--primary)"></div>Sugest√µes Enviadas</div>
<div id="sugList"></div>
<div class="empty" id="sugEmpty" style="display:none"><p>Nenhuma sugest√£o ainda.</p></div>
</div>
<button class="btn btn-outline" style="margin-top:12px" onclick="exportSug()">üìã Exportar Sugest√µes</button>
</div>


</main>

<div style="text-align:center;padding:8px 0 4px;font-size:11px;color:var(--text3)" id="appFooterLgpd">
<a href="javascript:void(0)" onclick="openLgpd()" style="color:var(--text3);text-decoration:underline">Pol√≠tica de Privacidade</a> ¬∑ Gileno - Gest√£o Financeira ¬© 2026 ¬∑ v2.6
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
<button class="nav-item active" data-page="dash" onclick="goPage('dash',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
Painel
</button>
<button class="nav-item" data-page="ext" onclick="goPage('ext',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
Extrato
</button>
<button class="nav-item" data-page="add" onclick="goPage('add',this)">
<div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--purple));display:flex;align-items:center;justify-content:center;margin-top:-18px;box-shadow:0 4px 16px rgba(59,130,246,0.4)">
<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2.5"><path d="M12 5v14M5 12h14"/></svg>
</div>
<span style="margin-top:2px">Novo</span>
</button>
<button class="nav-item" data-page="agenda" onclick="goPage('agenda',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><circle cx="12" cy="16" r="1"/></svg>
Agenda
</button>
<button class="nav-item" data-page="card" onclick="goPage('card',this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
Cart√µes
</button>
<button class="nav-item" data-page="cfg" onclick="toggleMaisMenu(event,this)">
<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="1"/><circle cx="12" cy="12" r="1"/><circle cx="12" cy="19" r="1"/></svg>
Mais
</button>
</nav>
<div id="maisMenu" style="display:none;position:fixed;bottom:70px;right:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 8px 32px rgba(0,0,0,0.5);z-index:999;min-width:180px;overflow:hidden">
<button onclick="closeMaisMenu();goPage('cfg')" style="width:100%;padding:14px 16px;background:none;border:none;color:var(--text);font-size:14px;text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;font-family:var(--font);border-bottom:1px solid var(--border)">‚öôÔ∏è Configura√ß√µes</button>
<button onclick="closeMaisMenu();goPage('sug')" style="width:100%;padding:14px 16px;background:none;border:none;color:var(--text);font-size:14px;text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;font-family:var(--font)">üí¨ Sugest√µes</button>
<button onclick="closeMaisMenu();window.open('guia.html','_blank')" style="width:100%;padding:14px 16px;background:none;border:none;color:var(--text);font-size:14px;text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;font-family:var(--font);border-top:1px solid var(--border)">üìñ Como usar</button>
<button onclick="closeMaisMenu();goPage('invest')" style="width:100%;padding:14px 16px;background:none;border:none;color:var(--text);font-size:14px;text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;font-family:var(--font);border-top:1px solid var(--border)">üìà Investimentos</button>
<button onclick="closeMaisMenu();goPage('sobre')" style="width:100%;padding:14px 16px;background:none;border:none;color:var(--text);font-size:14px;text-align:left;cursor:pointer;display:flex;align-items:center;gap:10px;font-family:var(--font);border-top:1px solid var(--border)">üè¢ Sobre n√≥s</button>
</div>
</nav>
</div>

<!-- PAY FATURA MODAL -->
<div class="modal-overlay" id="payModal" onclick="if(event.target===this)closePayModal()">
<div class="modal">
<div class="modal-handle"></div>
<div class="modal-title">üí∞ Pagar Fatura</div>
<div id="payInfo" style="background:var(--surface2);border-radius:var(--radius-sm);padding:12px;margin-bottom:14px">
<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="color:var(--text2);font-size:13px">Cart√£o</span><span id="payCard" style="font-weight:600"></span></div>
<div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="color:var(--text2);font-size:13px">Compras em aberto</span><span id="payQtd" style="font-weight:600"></span></div>
<div style="display:flex;justify-content:space-between"><span style="color:var(--text2);font-size:13px">Valor da fatura</span><span id="payTotal" style="font-family:var(--mono);font-weight:700;color:var(--red);font-size:18px"></span></div>
</div>
<div class="form-group"><label class="form-label">Conta para pagamento</label><select class="form-input" id="payConta"></select></div>
<div class="form-group"><label class="form-label">Data do pagamento</label><input type="date" class="form-input" id="payData"></div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closePayModal()" style="flex:1">Cancelar</button>
<button class="btn btn-green" onclick="confirmPayFatura()" style="flex:2">‚úÖ Confirmar Pagamento</button>
</div>
</div>
</div>

<!-- EDIT ITEM MODAL -->
<div class="modal-overlay" id="editModal" onclick="if(event.target===this)closeEditModal()">
<div class="modal">
<div class="modal-handle"></div>
<div class="modal-title">Editar Lan√ßamento</div>
<div class="form-group"><label class="form-label">Descri√ß√£o</label><input type="text" class="form-input" id="edDesc"></div>
<div class="form-group"><label class="form-label">Valor (R$)</label><div class="valor-input-wrap"><span class="valor-prefix">R$</span><input type="number" step="0.01" min="0" class="form-input" id="edValor" inputmode="decimal"></div></div>
<div class="form-group"><label class="form-label">Categoria</label><select class="form-input" id="edCat" onchange="onEdCatChange()"></select></div>
<div class="form-group"><label class="form-label">Subcategoria</label><select class="form-input" id="edSub"></select></div>
<div style="display:flex;gap:8px;margin-top:16px">
<button class="btn btn-outline" onclick="closeEditModal()" style="flex:1">Cancelar</button>
<button class="btn btn-primary" onclick="saveEdit()" style="flex:2">‚úì Salvar</button>
</div>
</div>
</div>

<!-- CARD DETAIL MODAL -->
<div class="modal-overlay" id="detailModal" onclick="if(event.target===this)closeDetailModal()">
<div class="modal">
<div class="modal-handle"></div>
<div class="modal-title" id="detailTitle">Compras do Cart√£o</div>
<div id="detailContent"></div>
<button class="btn btn-outline" onclick="closeDetailModal()" style="margin-top:16px">Fechar</button>
</div>
</div>

<div class="toast" id="toast"></div>

<script>
const BANCOS_DEFAULT=["Banco Principal"];
const CARTOES_DEFAULT=["Cart√£o Principal"];
const VENCS_DEFAULT=[10];
function getBancos(){return D.bancos||BANCOS_DEFAULT}
function getCartoes(){return D.cartoes||CARTOES_DEFAULT}
function getVencs(){return D.vencs||VENCS_DEFAULT}
const CATS_D_DEFAULT=["Moradia","Sa√∫de","Educa√ß√£o","Alimenta√ß√£o","Transporte","Telecom","Seguros","Cart√£o Cr√©dito","Assinaturas","Pessoal","Fam√≠lia","Investimento","Empr√©stimo","Outros"];
const CATS_R_DEFAULT=["Sal√°rio/Remunera√ß√£o","Aluguel","Rendimento","Transfer√™ncia","Outros"];
const SUBCATS_DEFAULT={
    "Sa√∫de":["Plano de Sa√∫de","Farm√°cia","Exames","Consultas","Dentista"],
    "Moradia":["Aluguel","Condom√≠nio","IPTU","Energia","√Ågua","G√°s","Manuten√ß√£o"],
    "Alimenta√ß√£o":["Supermercado","Restaurante","Delivery","Feira","Padaria"],
    "Transporte":["Combust√≠vel","Estacionamento","Uber/99","Manuten√ß√£o Ve√≠culo","Seguro Ve√≠culo","IPVA"],
    "Educa√ß√£o":["Escola","Faculdade","Cursos","Livros","Material"],
    "Telecom":["Internet","Celular","Telefone Fixo"],
    "Assinaturas":["Streaming","Apps","Revistas","Clubes"],
    "Pessoal":["Vestu√°rio","Lazer","Beleza","Academia","Presentes"],
    "Fam√≠lia":["Mesada","Ajuda Familiar","Pets"]
};
function getCatsD(){return D.catsD||CATS_D_DEFAULT}
function getCatsR(){return D.catsR||CATS_R_DEFAULT}
function getSubCats(){return D.subCats||{}}
function getSubsFor(cat){const sc=getSubCats();return sc[cat]||[]}
const MN=["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const MA=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"];
const CC=["#3b82f6","#ef4444","#f59e0b","#10b981","#8b5cf6","#06b6d4","#f97316","#ec4899","#14b8a6","#6366f1","#84cc16","#e11d48","#78716c","#64748b"];
const DSALDOS={};
const DCARDS={"Cart√£o Principal":"Banco Principal"};
const BASE_YEAR=2026;

const $=id=>document.getElementById(id);

// ===== MULTI-YEAR: month/year as a single key "YYYY-MM" =====
function mk(m,y){return y+'-'+(m<10?'0':'')+m}  // "2026-02"
function curKey(){return mk(cMonth,cYear)}

// Migrate old data (single month number) to new format
function migrateData(d){
    if(d._migrated) return d;
    d.tx=(d.tx||[]).map(t=>{if(t.y===undefined){t.y=BASE_YEAR}return t});
    d.cp=(d.cp||[]).map(c=>{if(c.y===undefined){c.y=BASE_YEAR}return c});
    if(!d.catsD) d.catsD=[...CATS_D_DEFAULT];
    if(!d.catsR) d.catsR=[...CATS_R_DEFAULT];
    if(!d.subCats) d.subCats={...SUBCATS_DEFAULT};
    if(!d.bancos) d.bancos=[...BANCOS_DEFAULT];
    if(!d.cartoes) d.cartoes=[...CARTOES_DEFAULT];
    if(!d.vencs) d.vencs=[...VENCS_DEFAULT];
    d._migrated=true;
    return d;
}

let D={}, cMonth=new Date().getMonth(), cYear=new Date().getFullYear(), cPage='dash', txFilt='all', addTp='Receita';
let currentUser='';
let currentUid='';
let db=null;
let saveTimeout=null;
let valHidden=false;
let agType='pagamento', agDestino='conta', agColor='#cc2222', agEditId=null, agSelectedDay=null;

function toggleValVis(){
    valHidden=!valHidden;
    document.querySelectorAll('.kpi-val-hide').forEach(el=>{
        if(valHidden)el.classList.add('hidden-val');else el.classList.remove('hidden-val');
    });
    document.querySelectorAll('.bank-balance').forEach(el=>{
        if(valHidden)el.classList.add('hidden-val');else el.classList.remove('hidden-val');
    });
    $('visIcon').textContent=valHidden?'üîí':'üëÅÔ∏è';
    $('visLabel').textContent=valHidden?'Mostrar valores':'Ocultar valores';
    rDash();
}

// Firebase Init
const firebaseConfig={
    apiKey:"AIzaSyDNq64Kqr2kt1baYlgPduSo5LbTsfdxdWQ",
    authDomain:"gestor-financeiro-pessoa-90a13.firebaseapp.com",
    projectId:"gestor-financeiro-pessoa-90a13",
    storageBucket:"gestor-financeiro-pessoa-90a13.firebasestorage.app",
    messagingSenderId:"465890133373",
    appId:"1:465890133373:web:ac58f801c60992b2b83814"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
db=firebase.firestore();

function loginMsg(msg,err){
    const el=document.getElementById('loginMsg');
    el.style.display='block';el.textContent=msg;
    el.style.background=err?'rgba(239,68,68,0.1)':'rgba(16,185,129,0.1)';
    el.style.color=err?'var(--red)':'var(--green)';
    el.style.border=err?'1px solid rgba(239,68,68,0.3)':'1px solid rgba(16,185,129,0.3)';
}

function fireAuthError(code){
    const m={'auth/email-already-in-use':'Email j√° cadastrado. Fa√ßa login.','auth/invalid-email':'Email inv√°lido.','auth/weak-password':'Senha fraca. M√≠nimo 6 caracteres.','auth/user-not-found':'Email n√£o encontrado. Clique Criar Conta.','auth/wrong-password':'Senha incorreta.','auth/invalid-credential':'Email ou senha incorretos.','auth/too-many-requests':'Muitas tentativas. Aguarde e tente novamente.','auth/popup-closed-by-user':'Login cancelado.'};
    return m[code]||'Erro: '+code;
}

async function doGoogleLogin(){
    try{
        const provider=new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
    }catch(e){loginMsg(fireAuthError(e.code),true)}
}

async function doEmailLogin(){
    const email=document.getElementById('loginEmail').value.trim();
    const pass=document.getElementById('loginPass').value;
    if(!email||!pass){loginMsg('Preencha email e senha',true);return}
    try{await auth.signInWithEmailAndPassword(email,pass)}
    catch(e){loginMsg(fireAuthError(e.code),true)}
}

async function doEmailRegister(){
    const email=document.getElementById('loginEmail').value.trim();
    const pass=document.getElementById('loginPass').value;
    if(!email||!pass){loginMsg('Preencha email e senha',true);return}
    if(pass.length<6){loginMsg('Senha: m√≠nimo 6 caracteres',true);return}
    if(!document.getElementById('acceptLgpd').checked){loginMsg('Voc√™ precisa aceitar a Pol√≠tica de Privacidade para criar uma conta',true);return}
    try{await auth.createUserWithEmailAndPassword(email,pass)}
    catch(e){loginMsg(fireAuthError(e.code),true)}
}

function openLgpd(){document.getElementById('lgpdModal').style.display='block'}
function closeLgpd(){document.getElementById('lgpdModal').style.display='none'}

function toggleTheme(){
    const html=document.documentElement;
    const isLight=html.getAttribute('data-theme')==='light';
    if(isLight){
        html.removeAttribute('data-theme');
        $('themeIcon').textContent='‚òÄÔ∏è';
        if(D)D.theme='dark';
    } else {
        html.setAttribute('data-theme','light');
        $('themeIcon').textContent='üåô';
        if(D)D.theme='light';
    }
    if(D)save();
}
function applyTheme(){
    if(D&&D.theme==='light'){
        document.documentElement.setAttribute('data-theme','light');
        if($('themeIcon'))$('themeIcon').textContent='üåô';
    } else {
        document.documentElement.removeAttribute('data-theme');
        if($('themeIcon'))$('themeIcon').textContent='‚òÄÔ∏è';
    }
}

function doLogout(){
    if(!confirm('Sair da conta?'))return;
    auth.signOut();
}

// Auth state listener
auth.onAuthStateChanged(async function(user){
    if(user){
        currentUid=user.uid;
        currentUser=user.displayName||user.email.split('@')[0];
        document.getElementById('loginScreen').style.display='none';
        document.getElementById('appContainer').style.display='flex';
        document.getElementById('headerUser').textContent='üë§ '+currentUser;
        await loadFromCloud();
        applyTheme();
        if(!D.userName){D.userName=currentUser;save()}
        refresh();
    } else {
        currentUid='';currentUser='';
        document.getElementById('appContainer').style.display='none';
        document.getElementById('loginScreen').style.display='flex';
        document.getElementById('loginPass').value='';
        document.getElementById('loginMsg').style.display='none';
    }
});

async function loadFromCloud(){
    try{
        const doc=await db.collection('users').doc(currentUid).get();
        if(doc.exists){
            D=migrateData(doc.data().data||{});
        } else {
            D=migrateData({tx:[],cp:[],bs:{...DSALDOS},ca:{...DCARDS},catsD:[...CATS_D_DEFAULT],catsR:[...CATS_R_DEFAULT],subCats:{...SUBCATS_DEFAULT},bancos:[...BANCOS_DEFAULT],cartoes:[...CARTOES_DEFAULT],vencs:[...VENCS_DEFAULT]});
        }
    }catch(e){
        console.error('Load error:',e);
        D=migrateData({tx:[],cp:[],bs:{...DSALDOS},ca:{...DCARDS},catsD:[...CATS_D_DEFAULT],catsR:[...CATS_R_DEFAULT],subCats:{...SUBCATS_DEFAULT},bancos:[...BANCOS_DEFAULT],cartoes:[...CARTOES_DEFAULT],vencs:[...VENCS_DEFAULT]});
    }
}

function load(){return D}

function save(){
    if(!currentUid)return;
    // Debounce: save to cloud after 1 second of inactivity
    if(saveTimeout) clearTimeout(saveTimeout);
    saveTimeout=setTimeout(async function(){
        try{
            await db.collection('users').doc(currentUid).set({data:JSON.parse(JSON.stringify(D)),updated:firebase.firestore.FieldValue.serverTimestamp()},{merge:true});
        }catch(e){console.error('Save error:',e);toast('‚ö†Ô∏è Erro ao salvar na nuvem',true)}
    },1000);
}

function checkAutoLogin(){/* handled by onAuthStateChanged */}
function uid(){return Date.now().toString(36)+Math.random().toString(36).substr(2,5)}
function fmt(v){if(!v&&v!==0)return'R$ 0,00';const a=Math.abs(v);return(v<0?'-R$ ':'R$ ')+a.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}
function toast(msg,err){const t=$('toast');t.textContent=msg;t.className='toast'+(err?' error':'')+' show';setTimeout(()=>t.className='toast',2500)}

function goPage(p,el){
    cPage=p;
    document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
    $('page-'+p).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
    if(el)el.classList.add('active');
    else if(p==='cfg'||p==='sug'||p==='sobre'||p==='invest') document.querySelector('.nav-item[data-page="cfg"]')?.classList.add('active');
    else document.querySelector(`.nav-item[data-page="${p}"]`)?.classList.add('active');
    refresh();
}

function toggleMaisMenu(e,el){
    e.stopPropagation();
    const m=$('maisMenu');
    if(m.style.display==='none'){m.style.display='block';document.addEventListener('click',closeMaisMenu,{once:true})}
    else m.style.display='none';
}
function closeMaisMenu(){$('maisMenu').style.display='none'}

function chgMonth(d){
    cMonth+=d;
    if(cMonth>11){cMonth=0;cYear++}
    if(cMonth<0){cMonth=11;cYear--}
    if(cYear<2025)cYear=2025;
    refresh();
}

// -- Calculations (now use month + year) --
function mTx(m,y){return D.tx.filter(t=>t.m===m&&t.y===y)}
function mCp(m,y){return D.cp.filter(c=>c.m===m&&c.y===y)}
function mRec(m,y){return mTx(m,y).filter(t=>t.tp==='Receita'&&!t.transf).reduce((s,t)=>s+t.v,0)}
function mDesp(m,y){return mTx(m,y).filter(t=>t.tp==='Despesa'&&!t.pgtoFatura&&!t.transf).reduce((s,t)=>s+t.v,0)}
function mCardT(m,y){return mCp(m,y).reduce((s,c)=>s+c.v,0)}
function mCardByCard(m,y,card){return mCp(m,y).filter(c=>c.card===card).reduce((s,c)=>s+c.v,0)}

// Walk from base saldos through all months up to target
function bankBal(banco,toM,toY){
    let b=D.bs[banco]||0;
    for(let y=BASE_YEAR;y<=toY;y++){
        const startM=(y===BASE_YEAR)?0:0;
        const endM=(y===toY)?toM:11;
        for(let m=startM;m<=endM;m++){
            mTx(m,y).forEach(t=>{if(t.banco===banco&&(t.st==='efetivado'||!t.st)){if(t.tp==='Receita')b+=t.v;else b-=t.v}});
        }
    }
    return b;
}

function catBreak(m,y){
    const c={};
    mTx(m,y).filter(t=>t.tp==='Despesa'&&!t.pgtoFatura&&!t.transf).forEach(t=>{const k=t.cat||'Outros';c[k]=(c[k]||0)+t.v});
    mCp(m,y).forEach(cp=>{const k=cp.cat||'Cart√£o Cr√©dito';c[k]=(c[k]||0)+cp.v});
    return Object.entries(c).sort((a,b)=>b[1]-a[1]);
}
function catBreakDetail(m,y,tipo){
    const c={};
    if(tipo==='Despesa'){
        mTx(m,y).filter(t=>t.tp==='Despesa'&&!t.pgtoFatura&&!t.transf).forEach(t=>{
            const k=t.cat||'Outros';const s=t.sub||'Sem subcategoria';
            if(!c[k])c[k]={total:0,subs:{}};
            c[k].total+=t.v;c[k].subs[s]=(c[k].subs[s]||0)+t.v;
        });
        mCp(m,y).forEach(cp=>{
            const k=cp.cat||'Cart√£o Cr√©dito';const s=cp.sub||cp.card||'Sem subcategoria';
            if(!c[k])c[k]={total:0,subs:{}};
            c[k].total+=cp.v;c[k].subs[s]=(c[k].subs[s]||0)+cp.v;
        });
    } else {
        mTx(m,y).filter(t=>t.tp==='Receita'&&!t.transf).forEach(t=>{
            const k=t.cat||'Outros';const s=t.sub||'Sem subcategoria';
            if(!c[k])c[k]={total:0,subs:{}};
            c[k].total+=t.v;c[k].subs[s]=(c[k].subs[s]||0)+t.v;
        });
    }
    return Object.entries(c).map(([k,v])=>({cat:k,total:v.total,subs:Object.entries(v.subs).sort((a,b)=>b[1]-a[1])})).sort((a,b)=>b.total-a.total);
}
function drawPie(canvasId,data,colors){
    const cv=document.getElementById(canvasId);if(!cv)return;
    const ctx=cv.getContext('2d');
    const dpr=window.devicePixelRatio||1;
    cv.width=220*dpr;cv.height=220*dpr;
    cv.style.width='220px';cv.style.height='220px';
    ctx.scale(dpr,dpr);
    const cx=110,cy=110,r=90;
    const total=data.reduce((s,d)=>s+d[1],0);
    if(!total){ctx.clearRect(0,0,220,220);return}
    let startAngle=-Math.PI/2;
    data.forEach((d,i)=>{
        const slice=(d[1]/total)*Math.PI*2;
        ctx.beginPath();ctx.moveTo(cx,cy);
        ctx.arc(cx,cy,r,startAngle,startAngle+slice);
        ctx.fillStyle=colors[i%colors.length];ctx.fill();
        startAngle+=slice;
    });
    // Inner circle for donut
    ctx.beginPath();ctx.arc(cx,cy,55,0,Math.PI*2);
    ctx.fillStyle='var(--surface)';
    ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--surface').trim()||'#1a1a1a';
    ctx.fill();
    // Center text
    ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--text').trim()||'#e8e8e8';
    ctx.font='bold 14px DM Sans,sans-serif';ctx.textAlign='center';
    ctx.fillText(valHidden?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢':'R$ '+fmtShort(total),cx,cy+5);
}
function fmtShort(v){if(v>=1000000)return(v/1000000).toFixed(1)+'M';if(v>=1000)return(v/1000).toFixed(1)+'K';return v.toFixed(0)}
function toggleCatSubs(el){
    const subs=el.nextElementSibling;
    if(subs.style.display==='none'||!subs.style.display){subs.style.display='block';el.querySelector('.cat-arrow').textContent='‚ñº'}
    else{subs.style.display='none';el.querySelector('.cat-arrow').textContent='‚ñ∂'}
}
function renderCatSection(containerId,data,colors,total){
    const el=document.getElementById(containerId);if(!el)return;
    if(!data.length){el.innerHTML='<div class="empty"><p>Nenhum lan√ßamento</p></div>';return}
    el.innerHTML=data.map((d,i)=>{
        const pct=total?(d.total/total*100):0;
        const color=colors[i%colors.length];
        const subsHtml=d.subs.map(s=>{
            const spct=d.total?(s[1]/d.total*100):0;
            return`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">
                <div style="width:8px;height:8px;border-radius:50%;background:${color};opacity:0.6;flex-shrink:0"></div>
                <span style="flex:1;font-size:12px;color:var(--text2)">${s[0]}</span>
                <span class="kpi-val-hide${valHidden?' hidden-val':''}" style="font-family:var(--mono);font-size:12px;font-weight:600">${fmt(s[1])}</span>
                <span style="font-size:11px;color:var(--text3);min-width:35px;text-align:right">${spct.toFixed(0)}%</span>
            </div>`;
        }).join('');
        return`<div style="margin-bottom:2px">
            <div onclick="toggleCatSubs(this)" style="display:flex;align-items:center;gap:8px;padding:10px 8px;cursor:pointer;border-radius:var(--radius-sm);transition:background 0.2s" onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background='transparent'">
                <div style="width:12px;height:12px;border-radius:3px;background:${color};flex-shrink:0"></div>
                <span class="cat-arrow" style="font-size:10px;color:var(--text3);width:14px">‚ñ∂</span>
                <span style="flex:1;font-size:13px;font-weight:600">${d.cat}</span>
                <span class="kpi-val-hide${valHidden?' hidden-val':''}" style="font-family:var(--mono);font-size:13px;font-weight:700">${fmt(d.total)}</span>
                <span style="font-size:11px;color:var(--text3);min-width:35px;text-align:right">${pct.toFixed(0)}%</span>
            </div>
            <div style="display:none;padding:0 8px 8px 34px">${subsHtml}</div>
        </div>`;
    }).join('');
}

// Helper: step back N months from (m,y)
function stepMonth(m,y,delta){
    let totalMonths=y*12+m+delta;
    const ny=Math.floor(totalMonths/12);
    const nm=totalMonths%12;
    return{m:nm,y:ny};
}

// -- Refresh --
function refresh(){
    const ml=MN[cMonth]+' '+cYear;
    document.querySelectorAll('.month-label').forEach(e=>e.textContent=ml);
    if(cPage==='dash')rDash();if(cPage==='ext')rExt();if(cPage==='add')rAdd();if(cPage==='agenda')rAgenda();if(cPage==='card')rCard();if(cPage==='cfg')rCfg();if(cPage==='sug')rSug();if(cPage==='invest')rInvest();
}

function rDash(){
    if(D.userName) $('appUserHeader').textContent='üë§ '+D.userName;
    const r=mRec(cMonth,cYear),d=mDesp(cMonth,cYear),res=r-d,ct=mCardT(cMonth,cYear);
    const txM=mTx(cMonth,cYear);
    const rEf=txM.filter(t=>t.tp==='Receita'&&(t.st==='efetivado'||!t.st)).reduce((s,t)=>s+t.v,0);
    const rAg=txM.filter(t=>t.tp==='Receita'&&t.st==='agendado').reduce((s,t)=>s+t.v,0);
    const dEf=txM.filter(t=>t.tp==='Despesa'&&(t.st==='efetivado'||!t.st)).reduce((s,t)=>s+t.v,0);
    const dAg=txM.filter(t=>t.tp==='Despesa'&&t.st==='agendado').reduce((s,t)=>s+t.v,0);
    $('k1').innerHTML=`${fmt(r)}<div style="font-size:10px;margin-top:2px;font-weight:400">‚úÖ ${fmt(rEf)} ¬∑ üïê ${fmt(rAg)}</div>`;
    $('k2').innerHTML=`${fmt(d)}<div style="font-size:10px;margin-top:2px;font-weight:400">‚úÖ ${fmt(dEf)} ¬∑ üïê ${fmt(dAg)}</div>`;
    $('k3').textContent=fmt(res);
    // Dynamic result color
    const kpiRes=$('kpiResult');
    kpiRes.className='kpi '+(res>=0?'res-pos':'res-neg');
    $('k4').textContent=fmt(ct);
    // Chart: last 6 months
    let months=[];
    for(let i=5;i>=0;i--){const p=stepMonth(cMonth,cYear,-i);months.push(p)}
    let mx=1;
    months.forEach(p=>{mx=Math.max(mx,mRec(p.m,p.y),mDesp(p.m,p.y))});
    let ch='';
    months.forEach(p=>{
        const rv=mRec(p.m,p.y),dv=mDesp(p.m,p.y);
        const rh=Math.max(2,(rv/mx)*110),dh=Math.max(2,(dv/mx)*110);
        const lbl=MA[p.m]+(p.y!==cYear?'/'+String(p.y).slice(2):'');
        ch+=`<div class="chart-col"><div class="chart-bars-pair"><div class="chart-bar green" style="height:${rh}px" title="Rec ${fmt(rv)}"></div><div class="chart-bar red" style="height:${dh}px" title="Desp ${fmt(dv)}"></div></div><div class="chart-lbl">${lbl}</div></div>`;
    });
    $('chartBars').innerHTML=ch;
    // Categories - Despesas
    const PIECOLORS=['#cc2222','#ef4444','#f59e0b','#f97316','#8b5cf6','#6366f1','#ec4899','#14b8a6','#06b6d4','#84cc16','#a855f7','#e11d48'];
    const PIECOLORS_REC=['#10b981','#059669','#34d399','#06b6d4','#0ea5e9','#22d3ee','#2dd4bf','#a3e635','#4ade80','#86efac','#67e8f9','#6ee7b7'];
    const catsDesp=catBreakDetail(cMonth,cYear,'Despesa');
    const totalDesp=catsDesp.reduce((s,c)=>s+c.total,0);
    if(!catsDesp.length){$('catBreakDesp').innerHTML='';$('catEmpty').style.display='block';document.getElementById('pieDesp').style.display='none'}
    else{
        $('catEmpty').style.display='none';document.getElementById('pieDesp').style.display='block';
        drawPie('pieDesp',catsDesp.map(c=>[c.cat,c.total]),PIECOLORS);
        renderCatSection('catBreakDesp',catsDesp,PIECOLORS,totalDesp);
    }
    // Categories - Receitas
    const catsRec=catBreakDetail(cMonth,cYear,'Receita');
    const totalRec2=catsRec.reduce((s,c)=>s+c.total,0);
    if(!catsRec.length){$('catBreakRec').innerHTML='';$('catEmptyRec').style.display='block';document.getElementById('pieRec').style.display='none'}
    else{
        $('catEmptyRec').style.display='none';document.getElementById('pieRec').style.display='block';
        drawPie('pieRec',catsRec.map(c=>[c.cat,c.total]),PIECOLORS_REC);
        renderCatSection('catBreakRec',catsRec,PIECOLORS_REC,totalRec2);
    }
    // Banks
    $('bankList').innerHTML=getBancos().map(b=>{
        const bal=bankBal(b,cMonth,cYear);
        return`<div class="bank-item"><span class="bank-name">${b}</span><span class="bank-balance${bal<0?' neg':''}">${fmt(bal)}</span></div>`;
    }).join('');
    // Dashboard Agenda Widget
    const todayStr2=new Date().toISOString().split('T')[0];
    const agUpcoming=(D.ag||[]).filter(e=>!e.done&&e.date>=todayStr2).sort((a,b)=>a.date.localeCompare(b.date)).slice(0,5);
    const agOverdue=(D.ag||[]).filter(e=>!e.done&&e.date<todayStr2).length;
    if(agUpcoming.length||agOverdue){
        $('dashAgendaEmpty').style.display='none';
        let agHtml='';
        if(agOverdue) agHtml+=`<div style="padding:8px 12px;background:var(--red-bg);border-radius:var(--radius-sm);margin-bottom:8px;font-size:12px;color:var(--red);cursor:pointer" onclick="goPage('agenda')">‚ö†Ô∏è ${agOverdue} compromisso${agOverdue>1?'s':''} vencido${agOverdue>1?'s':''}</div>`;
        agUpcoming.forEach(e=>{
            const dt=new Date(e.date+'T12:00:00');
            const isToday=e.date===todayStr2;
            const dayLabel=isToday?'Hoje':dt.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'});
            const typeIcon={pagamento:'üí∞',lembrete:'üîî',recebimento:'üíµ'}[e.type]||'üìÖ';
            const valorStr=e.valor?' ¬∑ '+fmt(e.valor):'';
            agHtml+=`<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);cursor:pointer" onclick="goPage('agenda')"><div style="width:4px;height:28px;border-radius:2px;background:${e.color};flex-shrink:0"></div><div style="flex:1"><div style="font-size:12px;font-weight:600">${typeIcon} ${e.title}</div><div style="font-size:11px;color:var(--text3)">${dayLabel}${e.time?' '+e.time:''}${valorStr}</div></div></div>`;
        });
        $('dashAgendaList').innerHTML=agHtml;
    } else {
        $('dashAgendaEmpty').style.display='block';
        $('dashAgendaList').innerHTML='';
    }
    // Reapply hidden state
    if(valHidden){
        document.querySelectorAll('.kpi-val-hide').forEach(el=>el.classList.add('hidden-val'));
        document.querySelectorAll('.bank-balance').forEach(el=>el.classList.add('hidden-val'));
    }
}

function rExt(){
    if(txFilt==='Conta'){rExtBank();return}
    const subVal=$('extSubSel')?$('extSubSel').value:'__all__';
    
    // === MODO CONTA (extrato banc√°rio) ===
    if(txFilt==='Conta'){
        const banco=subVal||getBancos()[0];
        rExtConta(banco);
        return;
    }
    
    let items=[];
    
    // Account transactions
    if(txFilt==='all'||txFilt==='Receita'||txFilt==='Despesa'){
        let txs=mTx(cMonth,cYear);
        if(txFilt==='Receita') txs=txs.filter(t=>t.tp==='Receita');
        if(txFilt==='Despesa') txs=txs.filter(t=>t.tp==='Despesa');
        if(subVal!=='__all__'&&(txFilt==='Receita'||txFilt==='Despesa')) txs=txs.filter(t=>t.banco===subVal);
        txs.forEach(t=>{
            items.push({type:'tx',id:t.id,dt:t.dt,desc:t.desc,v:t.v,tp:t.tp,banco:t.banco,cat:t.cat||'',sub:t.sub||'',card:null,st:t.st||'efetivado',rec:t.rec,recIdx:t.recIdx,recDur:t.recDur,recFreq:t.recFreq||'',transf:t.transf,transfOrigem:t.transfOrigem,transfDestino:t.transfDestino});
        });
    }
    
    // Card purchases
    if(txFilt==='all'||txFilt==='Cartao'){
        let cps=mCp(cMonth,cYear);
        if(subVal!=='__all__'&&txFilt==='Cartao') cps=cps.filter(c=>c.card===subVal);
        cps.forEach(c=>{
            items.push({type:'cp',id:c.id,dt:c.dt,desc:c.desc,v:c.v,tp:'Cartao',banco:null,cat:c.cat||'',sub:c.sub||'',card:c.card,tipo:c.tipo,parc:c.parc||'',st:c.st||'aberta'});
        });
    }
    
    items.sort((a,b)=>new Date(b.dt||'2000-01-01')-new Date(a.dt||'2000-01-01'));
    
    // For Cartao filter: group by card
    let groupByCard=(txFilt==='Cartao');
    let cardGroups={};
    if(groupByCard){
        items.forEach(t=>{
            if(t.type==='cp'){
                const k=t.card||'Outros';
                if(!cardGroups[k])cardGroups[k]=[];
                cardGroups[k].push(t);
            }
        });
    }
    
    if(!items.length){$('txList').innerHTML='';$('txEmpty').style.display='block';return}
    $('txEmpty').style.display='none';
    
    // Separated totals
    let recEf=0,recAg=0,despEf=0,despAg=0,cardPg=0,cardAb=0;
    items.forEach(t=>{
        if(t.type==='tx'&&t.tp==='Receita'){if(t.st==='efetivado')recEf+=t.v;else recAg+=t.v}
        if(t.type==='tx'&&t.tp==='Despesa'){if(t.st==='efetivado')despEf+=t.v;else despAg+=t.v}
        if(t.type==='cp'){if(t.st==='paga')cardPg+=t.v;else cardAb+=t.v}
    });
    
    let header='';
    if(txFilt==='Receita') header=`<div style="padding:10px 14px;background:var(--green-bg);border-radius:var(--radius-sm);margin-bottom:10px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--green);font-size:13px">‚úÖ Efetivado</span><span style="font-family:var(--mono);font-weight:700;color:var(--green)">${fmt(recEf)}</span></div><div style="display:flex;justify-content:space-between"><span style="color:var(--primary);font-size:13px">üïê Agendado</span><span style="font-family:var(--mono);font-weight:600;color:var(--primary)">${fmt(recAg)}</span></div></div>`;
    else if(txFilt==='Despesa') header=`<div style="padding:10px 14px;background:var(--red-bg);border-radius:var(--radius-sm);margin-bottom:10px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--red);font-size:13px">‚úÖ Efetivado</span><span style="font-family:var(--mono);font-weight:700;color:var(--red)">${fmt(despEf)}</span></div><div style="display:flex;justify-content:space-between"><span style="color:var(--primary);font-size:13px">üïê Agendado</span><span style="font-family:var(--mono);font-weight:600;color:var(--primary)">${fmt(despAg)}</span></div></div>`;
    else if(txFilt==='Cartao') header=`<div style="padding:10px 14px;background:var(--red-bg);border-radius:var(--radius-sm);margin-bottom:10px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--green);font-size:13px">‚úÖ Paga</span><span style="font-family:var(--mono);font-weight:700;color:var(--green)">${fmt(cardPg)}</span></div><div style="display:flex;justify-content:space-between"><span style="color:var(--red);font-size:13px">üî¥ Em aberto</span><span style="font-family:var(--mono);font-weight:700;color:var(--red)">${fmt(cardAb)}</span></div></div>`;
    
    // ====== RENDER GROUPED BY ACCOUNT/CARD ======
    
    // Build groups
    const bancoGroups={};
    const cardGroupsAll={};
    items.forEach(t=>{
        if(t.type==='tx'){
            const k=t.banco||'Outros';
            if(!bancoGroups[k])bancoGroups[k]=[];
            bancoGroups[k].push(t);
        } else if(t.type==='cp'){
            const k=t.card||'Outros';
            if(!cardGroupsAll[k])cardGroupsAll[k]=[];
            cardGroupsAll[k].push(t);
        }
    });
    
    let html=header;
    
    // --- BANK GROUPS ---
    const bancos=getBancos();
    const bancoKeys=Object.keys(bancoGroups).sort((a,b)=>{
        const ia=bancos.indexOf(a),ib=bancos.indexOf(b);
        return (ia===-1?999:ia)-(ib===-1?999:ib);
    });
    
    bancoKeys.forEach(banco=>{
        const grp=bancoGroups[banco];
        if(!grp||!grp.length)return;
        const grpRec=grp.filter(t=>t.tp==='Receita'&&(t.st==='efetivado'||!t.st)).reduce((s,t)=>s+t.v,0);
        const grpDesp=grp.filter(t=>t.tp==='Despesa'&&(t.st==='efetivado'||!t.st)).reduce((s,t)=>s+t.v,0);
        const grpAg=grp.filter(t=>t.st==='agendado').length;
        const saldoBanco=bankBal(banco,cMonth,cYear);
        
        html+=`<div style="margin-bottom:14px;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden">`;
        html+=`<div style="padding:10px 14px;background:var(--surface2);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px">`;
        html+=`<div style="display:flex;align-items:center;gap:8px"><span style="font-size:15px;font-weight:700">üè¶ ${banco}</span>`;
        if(grpAg>0) html+=`<span style="font-size:10px;padding:2px 8px;border-radius:4px;font-weight:600;background:rgba(245,158,11,0.12);color:#f59e0b">${grpAg} agendado${grpAg>1?'s':''}</span>`;
        html+=`</div>`;
        html+=`<div style="display:flex;gap:12px;align-items:center">`;
        if(txFilt==='all'){
            html+=`<span style="font-family:var(--mono);font-size:12px;color:var(--green)">+${fmtN(grpRec)}</span>`;
            html+=`<span style="font-family:var(--mono);font-size:12px;color:var(--red)">-${fmtN(grpDesp)}</span>`;
        }
        html+=`<span style="font-family:var(--mono);font-size:13px;font-weight:700;color:${saldoBanco>=0?'var(--green)':'var(--red)'}">${fmt(saldoBanco)}</span>`;
        html+=`</div></div>`;
        html+=`<div style="padding:2px 0">`;
        grp.sort((a,b)=>new Date(b.dt||'2000-01-01')-new Date(a.dt||'2000-01-01'));
        grp.forEach(t=>{html+=renderExtItem(t)});
        html+=`</div></div>`;
    });
    
    // --- CARD GROUPS ---
    if(txFilt==='all'||txFilt==='Cartao'){
        const cartoes=getCartoes();
        const cardKeys=Object.keys(cardGroupsAll).sort((a,b)=>{
            const ia=cartoes.indexOf(a),ib=cartoes.indexOf(b);
            return (ia===-1?999:ia)-(ib===-1?999:ib);
        });
        
        cardKeys.forEach(cardName=>{
            const grp=cardGroupsAll[cardName];
            if(!grp||!grp.length)return;
            const ci=cartoes.indexOf(cardName);
            const vencDia=ci>=0?getVencs()[ci]:0;
            const hoje=new Date();
            const vencDate=new Date(cYear,cMonth,vencDia);
            const diasPraVenc=Math.ceil((vencDate-hoje)/(1000*60*60*24));
            const grpTotal=grp.reduce((s,t)=>s+t.v,0);
            const allPaid=grp.length>0&&grp.every(t=>t.st==='paga');
            let vencStyle='background:var(--surface3);color:var(--text2)';
            let vencExtra='';
            if(allPaid){vencStyle='background:var(--green-bg);color:var(--green)';vencExtra=' ¬∑ ‚úÖ Paga'}
            else if(diasPraVenc<0){vencStyle='background:var(--red-bg);color:var(--red)';vencExtra=' ¬∑ Vencida'}
            else if(diasPraVenc<=5){vencStyle='background:rgba(245,158,11,0.15);color:#f59e0b';vencExtra=' ¬∑ '+diasPraVenc+'d'}
            
            html+=`<div style="margin-bottom:14px;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden">`;
            html+=`<div style="padding:10px 14px;background:var(--surface2);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px">`;
            html+=`<div style="display:flex;align-items:center;gap:8px"><span style="font-size:15px;font-weight:700">üí≥ ${cardName}</span>`;
            html+=`<span style="font-size:11px;padding:2px 8px;border-radius:4px;font-weight:600;${vencStyle}">Venc. dia ${vencDia}${vencExtra}</span></div>`;
            html+=`<div style="font-family:var(--mono);font-size:13px;font-weight:700;color:var(--red)">${fmt(grpTotal)}</div>`;
            html+=`</div>`;
            html+=`<div style="padding:2px 0">`;
            grp.sort((a,b)=>new Date(b.dt||'2000-01-01')-new Date(a.dt||'2000-01-01'));
            grp.forEach(t=>{html+=renderExtItem(t)});
            html+=`</div></div>`;
        });
    }
    
    if(!bancoKeys.length && !Object.keys(cardGroupsAll).length){
        html+=items.map(t=>renderExtItem(t)).join('');
    }
    
    $('txList').innerHTML=html;
}

function renderExtItem(t){
    const dt=t.dt?new Date(t.dt+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'2-digit'}):'';
    const subLabel=t.sub?' ‚Ä∫ '+t.sub:'';
    if(t.type==='tx'){
        const isR=t.tp==='Receita';
        const isTransf=t.transf;
        const isEf=t.st==='efetivado';
        const stBadge=isTransf?`<span style="font-size:10px;background:var(--primary-glow);color:var(--primary);padding:2px 6px;border-radius:4px;margin-left:4px">üîÑ</span>`:(isEf?`<span style="font-size:10px;background:var(--green-bg);color:var(--green);padding:2px 6px;border-radius:4px;margin-left:4px">‚úÖ</span>`:`<span style="font-size:10px;background:var(--primary-glow);color:var(--primary);padding:2px 6px;border-radius:4px;margin-left:4px">üïê</span>`);
        const opacity=isEf?'1':'0.6';
        const recLabel=t.rec?` ¬∑ <span style="color:var(--purple)">‚ôªÔ∏è ${t.recIdx}/${t.recDur}</span>`:'';
        const iconClass=isTransf?'card-icon':isR?'income':'expense';
        const iconChar=isTransf?'üîÑ':isR?'‚Üë':'‚Üì';
        const amtClass=isTransf?'':isR?'positive':'negative';
        const amtSign=isTransf?'':isR?'+':'‚àí';
        const metaInfo=isTransf?`${dt} ¬∑ ${t.transfOrigem} ‚Üí ${t.transfDestino}`:`${dt} ¬∑ ${t.banco}${recLabel} ¬∑ ${t.cat}${subLabel}`;
        return`<div class="tx-item" style="opacity:${opacity}"><div class="tx-icon ${iconClass}" style="cursor:pointer" onclick="${isTransf?'':`toggleTxStatus('${t.id}')`}" title="${isTransf?'Transfer√™ncia':'Toque para alternar status'}">${iconChar}</div><div class="tx-info" style="cursor:pointer" onclick="editItem('tx','${t.id}')"><div class="tx-desc">${t.desc}${stBadge}</div><div class="tx-meta">${metaInfo} <span style="font-size:9px;color:var(--primary)">‚úèÔ∏è</span></div></div><div class="tx-amount ${amtClass}" style="${isTransf?'color:var(--primary)':''}">${amtSign}${fmt(t.v).replace('R$ ','').replace('-R$ ','')}</div><button class="tx-del" onclick="delTx('${t.id}')">&times;</button></div>`;
    } else {
        const isPaga=t.st==='paga';
        const stBadge=isPaga?`<span style="font-size:10px;background:var(--green-bg);color:var(--green);padding:2px 6px;border-radius:4px;margin-left:4px">‚úÖ Paga</span>`:`<span style="font-size:10px;background:var(--red-bg);color:var(--red);padding:2px 6px;border-radius:4px;margin-left:4px">üî¥ Aberta</span>`;
        const opacity=isPaga?'0.6':'1';
        return`<div class="tx-item" style="opacity:${opacity}"><div class="tx-icon card-icon">üí≥</div><div class="tx-info" style="cursor:pointer" onclick="editItem('cp','${t.id}')"><div class="tx-desc">${t.desc}${stBadge}</div><div class="tx-meta">${dt} ¬∑ ${t.card}${t.parc?' ¬∑ '+t.parc:''} ¬∑ ${t.cat}${subLabel} <span style="font-size:9px;color:var(--primary)">‚úèÔ∏è</span></div></div><div class="tx-amount negative">‚àí${fmt(t.v).replace('R$ ','').replace('-R$ ','')}</div><button class="tx-del" onclick="delCardExt('${t.id}')">‚úï</button></div>`;
    }
}

// === EXTRATO BANC√ÅRIO (vis√£o Conta) ===
function rExtConta(banco){
    // Get previous month balance as starting saldo
    const prev=stepMonth(cMonth,cYear,-1);
    const saldoAnterior=bankBal(banco,prev.m,prev.y);
    
    // Get all transactions for this bank this month, sorted by date ASC
    const txsAll=mTx(cMonth,cYear).filter(t=>t.banco===banco).sort((a,b)=>{
        const da=new Date(a.dt||'2000-01-01'),db=new Date(b.dt||'2000-01-01');
        return da-db||a.id.localeCompare(b.id);
    });
    
    // Separate efetivados and agendados
    const txsEf=txsAll.filter(t=>t.st==='efetivado'||!t.st);
    const txsAg=txsAll.filter(t=>t.st==='agendado');
    
    // Calc totals ONLY from efetivados
    let totalCred=0,totalDeb=0;
    txsEf.forEach(t=>{if(t.tp==='Receita')totalCred+=t.v;else totalDeb+=t.v});
    const saldoFinal=saldoAnterior+totalCred-totalDeb;
    
    // Calc agendados totals
    let agCred=0,agDeb=0;
    txsAg.forEach(t=>{if(t.tp==='Receita')agCred+=t.v;else agDeb+=t.v});
    const saldoPrevisto=saldoFinal+agCred-agDeb;
    
    // Header: resumo da conta
    let html=`<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:12px">
<div style="text-align:center;margin-bottom:10px"><span style="font-size:16px;font-weight:700">üè¶ ${banco}</span></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
<div style="background:var(--surface2);border-radius:var(--radius-sm);padding:10px;text-align:center"><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:4px">Saldo Anterior</div><div style="font-family:var(--mono);font-size:15px;font-weight:700;color:${saldoAnterior>=0?'var(--text)':'var(--red)'}">${fmt(saldoAnterior)}</div></div>
<div style="background:var(--surface2);border-radius:var(--radius-sm);padding:10px;text-align:center"><div style="font-size:10px;color:var(--text3);text-transform:uppercase;margin-bottom:4px">Saldo Atual</div><div style="font-family:var(--mono);font-size:15px;font-weight:700;color:${saldoFinal>=0?'var(--green)':'var(--red)'}">${fmt(saldoFinal)}</div></div>
</div>
${txsAg.length?`<div style="background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:var(--radius-sm);padding:8px 10px;margin-top:8px;text-align:center"><div style="font-size:10px;color:#f59e0b;text-transform:uppercase;margin-bottom:2px">üïê Saldo Previsto (com agendados)</div><div style="font-family:var(--mono);font-size:14px;font-weight:700;color:#f59e0b">${fmt(saldoPrevisto)}</div><div style="font-size:10px;color:var(--text3);margin-top:2px">${txsAg.length} agendado${txsAg.length>1?'s':''}: +${fmt(agCred).replace('R$ ','')} / -${fmt(agDeb).replace('R$ ','')}</div></div>`:''}
<div style="display:flex;justify-content:space-between;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
<div style="text-align:center;flex:1"><div style="font-size:10px;color:var(--text3)">Cr√©ditos</div><div style="font-family:var(--mono);font-size:14px;font-weight:600;color:var(--primary)">+${fmt(totalCred).replace('R$ ','')}</div></div>
<div style="width:1px;background:var(--border)"></div>
<div style="text-align:center;flex:1"><div style="font-size:10px;color:var(--text3)">D√©bitos</div><div style="font-family:var(--mono);font-size:14px;font-weight:600;color:var(--red)">-${fmt(totalDeb).replace('R$ ','')}</div></div>
<div style="width:1px;background:var(--border)"></div>
<div style="text-align:center;flex:1"><div style="font-size:10px;color:var(--text3)">Lan√ßamentos</div><div style="font-size:14px;font-weight:600">${txsAll.length}</div></div>
</div></div>`;
    
    if(!txsAll.length){
        $('txList').innerHTML=html+'<div class="empty"><p>Nenhum lan√ßamento nesta conta neste m√™s.</p></div>';
        $('txEmpty').style.display='none';
        return;
    }
    $('txEmpty').style.display='none';
    
    // Saldo line header
    html+=`<div style="display:flex;padding:6px 14px;font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;border-bottom:1px solid var(--border);margin-bottom:4px">
<span style="flex:1">Data / Descri√ß√£o</span>
<span style="width:80px;text-align:right">Valor</span>
<span style="width:85px;text-align:right">Saldo</span>
</div>`;
    
    // Saldo anterior row
    html+=`<div style="display:flex;align-items:center;padding:8px 14px;background:var(--surface2);border-radius:var(--radius-sm);margin-bottom:3px;border-left:3px solid var(--text3)">
<div style="flex:1"><span style="font-size:12px;color:var(--text3);font-weight:600">üìã Saldo Anterior</span></div>
<div style="width:80px"></div>
<div style="width:85px;text-align:right;font-family:var(--mono);font-size:13px;font-weight:700;color:${saldoAnterior>=0?'var(--text)':'var(--red)'}">${fmt(saldoAnterior)}</div>
</div>`;
    
    // Transaction rows - EFETIVADOS first with running balance
    let saldo=saldoAnterior;
    txsEf.forEach(t=>{
        const isR=t.tp==='Receita';
        if(isR) saldo+=t.v; else saldo-=t.v;
        const dt=t.dt?new Date(t.dt+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}):'';
        const subLabel=t.sub?' ‚Ä∫ '+t.sub:'';
        const borderColor=isR?'var(--primary)':'var(--red)';
        const valColor=isR?'var(--primary)':'var(--red)';
        const valSign=isR?'+':'‚àí';
        const recLabel=t.rec?' <span style="font-size:9px;color:var(--purple)">‚ôªÔ∏è'+t.recIdx+'/'+t.recDur+'</span>':'';
        
        html+=`<div style="display:flex;align-items:center;padding:8px 14px;background:var(--surface2);border-radius:var(--radius-sm);margin-bottom:3px;border-left:3px solid ${borderColor};cursor:pointer" onclick="editItem('tx','${t.id}')">
<div style="flex:1;min-width:0">
<div style="font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${t.desc}${recLabel}</div>
<div style="font-size:10px;color:var(--text3);margin-top:1px">${dt} ¬∑ ${t.cat}${subLabel}</div>
</div>
<div style="width:80px;text-align:right;font-family:var(--mono);font-size:13px;font-weight:600;color:${valColor}">${valSign}${fmt(t.v).replace('R$ ','').replace('-R$ ','')}</div>
<div style="width:85px;text-align:right;font-family:var(--mono);font-size:13px;font-weight:700;color:${saldo>=0?'var(--text)':'var(--red)'}">${fmt(saldo)}</div>
</div>`;
    });
    
    // Saldo final row (only efetivados)
    html+=`<div style="display:flex;align-items:center;padding:10px 14px;background:${saldoFinal>=0?'var(--green-bg)':'var(--red-bg)'};border-radius:var(--radius-sm);margin-top:4px;border-left:3px solid ${saldoFinal>=0?'var(--green)':'var(--red)'}">
<div style="flex:1"><span style="font-size:12px;font-weight:700;color:${saldoFinal>=0?'var(--green)':'var(--red)'}">üí∞ Saldo Final</span></div>
<div style="width:80px"></div>
<div style="width:85px;text-align:right;font-family:var(--mono);font-size:15px;font-weight:700;color:${saldoFinal>=0?'var(--green)':'var(--red)'}">${fmt(saldoFinal)}</div>
</div>`;
    
    // AGENDADOS section - separate, visually distinct
    if(txsAg.length){
        html+=`<div style="margin-top:16px;padding-top:12px;border-top:2px dashed rgba(245,158,11,0.4)">
<div style="font-size:12px;font-weight:700;color:#f59e0b;margin-bottom:8px;display:flex;align-items:center;gap:6px">üïê Agendados / Pendentes</div>`;
        txsAg.forEach(t=>{
            const isR=t.tp==='Receita';
            const dt=t.dt?new Date(t.dt+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}):'';
            const subLabel=t.sub?' ‚Ä∫ '+t.sub:'';
            const valColor=isR?'var(--primary)':'var(--red)';
            const valSign=isR?'+':'‚àí';
            
            html+=`<div style="display:flex;align-items:center;padding:8px 14px;background:rgba(245,158,11,0.05);border:1px dashed rgba(245,158,11,0.3);border-radius:var(--radius-sm);margin-bottom:3px;opacity:0.7;cursor:pointer" onclick="editItem('tx','${t.id}')">
<div style="flex:1;min-width:0">
<div style="font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">üïê ${t.desc}</div>
<div style="font-size:10px;color:var(--text3);margin-top:1px">${dt} ¬∑ ${t.cat}${subLabel}</div>
</div>
<div style="width:80px;text-align:right;font-family:var(--mono);font-size:13px;font-weight:600;color:${valColor}">${valSign}${fmt(t.v).replace('R$ ','').replace('-R$ ','')}</div>
<div style="width:85px"></div>
</div>`;
        });
        html+=`</div>`;
    }
    
    $('txList').innerHTML=html;
}

let addDestino='conta'; // 'conta' or 'cartao'
let addStatus='efetivado'; // 'efetivado' or 'agendado'
let contaFreq='unico'; // 'unico' or 'recorrente'

function setStatus(st,el){
    addStatus=st;
    document.querySelectorAll('#statusTabs .toggle-tab').forEach(t=>t.classList.remove('active'));
    if(el)el.classList.add('active');
}

function setContaFreq(freq,el){
    contaFreq=freq;
    document.querySelectorAll('#contaFreqTabs .toggle-tab').forEach(t=>t.classList.remove('active'));
    if(el)el.classList.add('active');
    $('contaRecRow').style.display=freq==='recorrente'?'block':'none';
    if(freq==='recorrente') calcContaRec();
}

function recDaysFor(unidade,intervalo){
    if(unidade==='dias') return intervalo;
    if(unidade==='semanas') return intervalo*7;
    if(unidade==='quinzenas') return intervalo*15;
    return 0; // meses handled separately
}

function recDatesCalc(startDate,unidade,intervalo,qtd){
    const dates=[];
    const d0=new Date(startDate+'T12:00:00');
    for(let i=0;i<qtd;i++){
        const d=new Date(d0);
        if(unidade==='meses'){
            d.setMonth(d.getMonth()+(i*intervalo));
        } else {
            const days=recDaysFor(unidade,intervalo);
            d.setDate(d.getDate()+(i*days));
        }
        dates.push({dt:d.toISOString().split('T')[0],m:d.getMonth(),y:d.getFullYear()});
    }
    return dates;
}

function recFreqLabel(unidade,intervalo){
    if(unidade==='dias'&&intervalo===1) return 'Di√°rio';
    if(unidade==='dias') return 'A cada '+intervalo+' dias';
    if(unidade==='semanas'&&intervalo===1) return 'Semanal';
    if(unidade==='semanas') return 'A cada '+intervalo+' semanas';
    if(unidade==='quinzenas'&&intervalo===1) return 'Quinzenal';
    if(unidade==='quinzenas') return 'A cada '+intervalo+' quinzenas';
    if(unidade==='meses'&&intervalo===1) return 'Mensal';
    if(unidade==='meses') return 'A cada '+intervalo+' meses';
    return '';
}

function calcContaRec(){
    const val=parseFloat($('fValor').value)||0;
    const qtd=parseInt($('fRecQtd').value)||12;
    const intervalo=parseInt($('fRecIntervalo').value)||1;
    const unidade=$('fRecUnidade').value;
    const startDt=$('fDate').value||new Date().toISOString().split('T')[0];
    const dates=recDatesCalc(startDt,unidade,intervalo,qtd);
    const last=dates[dates.length-1];
    const freqLabel=recFreqLabel(unidade,intervalo);
    const lastDt=last?new Date(last.dt+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'short',year:'numeric'}):'';
    $('contaRecPreviewText').innerHTML=`<strong>${freqLabel}</strong> √ó ${qtd} vezes<br><span style="font-family:var(--mono);font-weight:700;color:var(--purple)">${fmt(val)}</span> cada ¬∑ Total: <span style="font-family:var(--mono);font-weight:700;color:var(--purple)">${fmt(val*qtd)}</span><br><span style="font-size:11px;color:var(--text3)">√öltimo: ${lastDt}</span>`;
}

function rAdd(){
    const sel=$('fMonth');
    sel.innerHTML='';
    for(let y=BASE_YEAR;y<=cYear+2;y++){
        MN.forEach((m,i)=>{
            const o=document.createElement('option');
            o.value=i+'-'+y;
            o.textContent=m+' '+y;
            if(i===cMonth&&y===cYear)o.selected=true;
            sel.appendChild(o);
        });
    }
    const bsel=$('fBanco');
    bsel.innerHTML='';
    getBancos().forEach(b=>{const o=document.createElement('option');o.value=b;o.textContent=b;bsel.appendChild(o)});
    const oNewB=document.createElement('option');oNewB.value='__novo_banco__';oNewB.textContent='Ôºã Novo banco...';oNewB.style.color='#3b82f6';bsel.appendChild(oNewB);
    const csel=$('fCartao');
    csel.innerHTML='';
    getCartoes().forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;csel.appendChild(o)});
    const oNewC=document.createElement('option');oNewC.value='__novo_cartao__';oNewC.textContent='Ôºã Novo cart√£o...';oNewC.style.color='#3b82f6';csel.appendChild(oNewC);
    updateCatOptions();
    updateDestinoUI();
    if(!$('fDate').value){$('fDate').value=new Date().toISOString().split('T')[0]}
}

function updateCatOptions(){
    const sel=$('fCat');sel.innerHTML='';
    const cats=addTp==='Receita'?getCatsR():getCatsD();
    cats.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o)});
    const oNew=document.createElement('option');oNew.value='__nova__';oNew.textContent='Ôºã Nova categoria...';oNew.style.color='#3b82f6';sel.appendChild(oNew);
    onCatChange();
}

function onCatChange(){
    const cat=$('fCat').value;
    if(cat==='__nova__') return;
    const subs=getSubsFor(cat);
    $('fSubCatRow').style.display='block';
    const sel=$('fSubCat');sel.innerHTML='';
    const oNone=document.createElement('option');oNone.value='';oNone.textContent='‚Äî Geral (sem subcategoria)';sel.appendChild(oNone);
    subs.forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;sel.appendChild(o)});
    const oNew=document.createElement('option');oNew.value='__nova_sub__';oNew.textContent='Ôºã Nova subcategoria...';oNew.style.color='#3b82f6';sel.appendChild(oNew);
}

// Listener for "new category" and "new subcategory" inline
document.addEventListener('change',function(e){
    if(e.target.id==='fCat' && e.target.value==='__nova__'){
        const nome=prompt('Nome da nova categoria:');
        if(!nome||!nome.trim()){updateCatOptions();return}
        const catName=nome.trim();
        if(addTp==='Receita'){
            if(!D.catsR) D.catsR=[...CATS_R_DEFAULT];
            if(!D.catsR.includes(catName)){D.catsR.push(catName);save();toast('‚úÖ Categoria "'+catName+'" criada!')}
        } else {
            if(!D.catsD) D.catsD=[...CATS_D_DEFAULT];
            if(!D.catsD.includes(catName)){D.catsD.push(catName);save();toast('‚úÖ Categoria "'+catName+'" criada!')}
        }
        updateCatOptions();
        $('fCat').value=catName;
        onCatChange();
    }
    if(e.target.id==='fSubCat' && e.target.value==='__nova_sub__'){
        const cat=$('fCat').value;
        const nome=prompt('Nova subcategoria para "'+cat+'":');
        if(!nome||!nome.trim()){onCatChange();return}
        const subName=nome.trim();
        if(!D.subCats) D.subCats={};
        if(!D.subCats[cat]) D.subCats[cat]=[];
        if(!D.subCats[cat].includes(subName)){D.subCats[cat].push(subName);save();toast('‚úÖ Subcategoria "'+subName+'" criada!')}
        onCatChange();
        $('fSubCat').value=subName;
    }
    if(e.target.id==='fBanco' && e.target.value==='__novo_banco__'){
        const nome=prompt('Nome do novo banco/conta:');
        if(!nome||!nome.trim()){$('fBanco').value=getBancos()[0];return}
        const bankName=nome.trim();
        if(!D.bancos) D.bancos=[...BANCOS_DEFAULT];
        if(!D.bancos.includes(bankName)){
            D.bancos.push(bankName);
            if(!D.bs[bankName]) D.bs[bankName]=0;
            save();toast('‚úÖ Banco "'+bankName+'" cadastrado!');
        }
        rAdd();
        $('fBanco').value=bankName;
    }
    if(e.target.id==='fCartao' && e.target.value==='__novo_cartao__'){
        const nome=prompt('Nome do novo cart√£o:');
        if(!nome||!nome.trim()){$('fCartao').value=getCartoes()[0];return}
        const cardName=nome.trim();
        const venc=prompt('Dia de vencimento da fatura (1-31):','10');
        const vencNum=parseInt(venc)||10;
        const contaPag=prompt('Conta para pagamento do cart√£o:',getBancos()[0]);
        if(!D.cartoes) D.cartoes=[...CARTOES_DEFAULT];
        if(!D.vencs) D.vencs=[...VENCS_DEFAULT];
        if(!D.cartoes.includes(cardName)){
            D.cartoes.push(cardName);
            D.vencs.push(vencNum);
            if(contaPag) D.ca[cardName]=contaPag;
            save();toast('‚úÖ Cart√£o "'+cardName+'" cadastrado!');
        }
        rAdd();
        $('fCartao').value=cardName;
    }
});

function updateDestinoUI(){
    const isDespesa=addTp==='Despesa';
    const isTransf=addTp==='Transf';
    $('destinoRow').style.display=isDespesa?'block':'none';
    $('transfFields').style.display=isTransf?'block':'none';
    // Hide categoria/subcategoria/status for transfers
    $('fCat').parentElement.style.display=isTransf?'none':'block';
    $('fSubCatRow').style.display=isTransf?'none':(txFilt!=='Conta'?'block':'block');
    $('statusTabs').parentElement.style.display=isTransf?'none':'block';
    if(isTransf){
        $('contaFields').style.display='none';
        $('cartaoFields').style.display='none';
        $('fValorLabel').textContent='Valor da Transfer√™ncia';
        // Populate transfer dropdowns
        const bancos=getBancos();
        const selO=$('fTransfOrigem'),selD=$('fTransfDestino');
        selO.innerHTML='';selD.innerHTML='';
        bancos.forEach((b,i)=>{
            const o1=document.createElement('option');o1.value=b;o1.textContent=b;selO.appendChild(o1);
            const o2=document.createElement('option');o2.value=b;o2.textContent=b;
            if(i===1||(!i&&bancos.length===1)) o2.selected=true;
            selD.appendChild(o2);
        });
    } else if(!isDespesa){
        $('contaFields').style.display='block';
        $('cartaoFields').style.display='none';
        $('fValorLabel').textContent='Valor';
    } else {
        $('contaFields').style.display=addDestino==='conta'?'block':'none';
        $('cartaoFields').style.display=addDestino==='cartao'?'block':'none';
        if(addDestino==='cartao'){
            toggleAddParc();
        } else {
            $('fValorLabel').textContent='Valor';
        }
    }
}

function setDestino(dest,el){
    addDestino=dest;
    document.querySelectorAll('#destinoTabs .toggle-tab').forEach(t=>t.classList.remove('active'));
    if(el)el.classList.add('active');
    updateDestinoUI();
}

let parcMode='total'; // 'total' or 'parcela'

function setParcMode(mode,el){
    parcMode=mode;
    document.querySelectorAll('#fParcModeRow .toggle-tab').forEach(t=>t.classList.remove('active'));
    if(el)el.classList.add('active');
    if(mode==='total') $('fValorLabel').textContent='Valor Total da Compra';
    else $('fValorLabel').textContent='Valor da Parcela';
    calcAddParc();
}

function toggleAddParc(){
    const tipo=$('fCompTipo').value;
    const isParc=tipo==='Parcelado';
    const isRec=tipo==='Recorrente';
    $('fParcRow').style.display=(isParc||isRec)?'block':'none';
    $('fParcPreview').style.display=(isParc||isRec)?'block':'none';
    $('fParcModeRow').style.display=isParc?'block':'none';
    if(isParc){
        $('fParcLabel').textContent='N¬∫ Parcelas';
        $('fParcT').min=2;$('fParcT').value=Math.max(2,parseInt($('fParcT').value)||2);
        setParcMode(parcMode,parcMode==='total'?$('btnModeTotal'):$('btnModeParcela'));
    } else if(isRec){
        $('fParcLabel').textContent='Dura√ß√£o (meses)';
        $('fParcT').min=1;$('fParcT').value=Math.max(1,parseInt($('fParcT').value)||12);
        $('fValorLabel').textContent='Valor Mensal';
    } else {
        $('fValorLabel').textContent='Valor';
    }
    calcAddParc();
}

function calcAddParc(){
    const tipo=$('fCompTipo').value;
    const val=parseFloat($('fValor').value)||0;
    const n=parseInt($('fParcT').value)||2;
    if(tipo==='Parcelado'){
        if(parcMode==='total'){
            const parcVal=val/n;
            $('fParcPreviewText').innerHTML=`${n}x de <span style="font-family:var(--mono);font-weight:700;color:var(--primary)">${fmt(parcVal)}</span> ¬∑ Total: ${fmt(val)}`;
        } else {
            const totalVal=val*n;
            $('fParcPreviewText').innerHTML=`${n}x de <span style="font-family:var(--mono);font-weight:700;color:var(--primary)">${fmt(val)}</span> ¬∑ Total: ${fmt(totalVal)}`;
        }
    } else if(tipo==='Recorrente'){
        const my=parseMonthSel($('fMonth').value);
        const end=stepMonth(my.m,my.y,n-1);
        $('fParcPreviewText').innerHTML=`<span style="font-family:var(--mono);font-weight:700;color:var(--purple)">${fmt(val)}</span>/m√™s √ó ${n} meses (${MA[my.m]}/${my.y} a ${MA[end.m]}/${end.y}) = <span style="font-family:var(--mono);font-weight:700;color:var(--purple)">${fmt(val*n)}</span>`;
    }
}

function rExtBank(){
    const selVal=$('extSubSel')?$('extSubSel').value:'__todas__';
    const bancos=selVal==='__todas__'?getBancos():[selVal];
    
    let html='';
    bancos.forEach(banco=>{
        // Get transactions for this bank in this month
        const txsAll=mTx(cMonth,cYear).filter(t=>t.banco===banco).sort((a,b)=>{
            const da=a.dt||'2000-01-01',db=b.dt||'2000-01-01';
            return da.localeCompare(db);
        });
        
        // Separate efetivados and agendados
        const txsEf=txsAll.filter(t=>t.st==='efetivado'||!t.st);
        const txsAg=txsAll.filter(t=>t.st==='agendado');
        
        // Calculate opening balance (only efetivados)
        const prev=stepMonth(cMonth,cYear,-1);
        const saldoAnterior=bankBal(banco,prev.m,prev.y);
        
        // Build rows - EFETIVADOS only
        let saldo=saldoAnterior;
        let totalCredito=0, totalDebito=0;
        
        let rows='';
        rows+=`<tr class="bk-saldo-row"><td colspan="2" style="font-size:12px;color:var(--text2)">üìã Saldo Anterior</td><td></td><td></td><td class="${saldo>=0?'bk-saldo-pos':'bk-saldo-neg'}">${fmtN(saldo)}</td></tr>`;
        
        txsEf.forEach(t=>{
            const dt=t.dt?new Date(t.dt+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}):'‚Äî';
            const isR=t.tp==='Receita';
            const credito=isR?t.v:0;
            const debito=isR?0:t.v;
            saldo+=isR?t.v:-t.v;
            totalCredito+=credito;
            totalDebito+=debito;
            const subLabel=t.sub?' ‚Ä∫ '+t.sub:'';
            const isTransf=t.transf;
            const stDot=isTransf?'<span class="bk-st" style="background:var(--primary)"></span>':'<span class="bk-st bk-st-ef"></span>';
            const recBadge=t.rec?` <span style="font-size:9px;color:var(--purple)">‚ôªÔ∏è${t.recIdx}/${t.recDur}</span>`:'';
            const transfBadge=isTransf?' <span style="font-size:9px;color:var(--primary)">üîÑ</span>':'';
            const descExtra=isTransf?`<div class="bk-cat" style="color:var(--primary)">${isR?'‚Üê de '+t.transfOrigem:'‚Üí para '+t.transfDestino}</div>`:`<div class="bk-cat">${t.cat||''}${subLabel}</div>`;
            
            rows+=`<tr style="cursor:pointer" onclick="editItem('tx','${t.id}')"><td style="font-size:11px;color:var(--text3);white-space:nowrap">${stDot}${dt}</td><td><div class="bk-desc">${t.desc}${recBadge}${transfBadge}</div>${descExtra}</td><td class="bk-credit">${credito?fmtN(credito):''}</td><td class="bk-debit">${debito?fmtN(debito):''}</td><td class="${saldo>=0?'bk-saldo-pos':'bk-saldo-neg'}">${fmtN(saldo)}</td></tr>`;
        });
        
        // Saldo final row (efetivados only)
        rows+=`<tr class="bk-saldo-row"><td colspan="2" style="font-size:12px;color:var(--text2)">üìä Saldo Final</td><td class="bk-credit" style="font-weight:700">${fmtN(totalCredito)}</td><td class="bk-debit" style="font-weight:700">${fmtN(totalDebito)}</td><td class="${saldo>=0?'bk-saldo-pos':'bk-saldo-neg'}" style="font-size:14px;font-weight:700">${fmtN(saldo)}</td></tr>`;
        
        // AGENDADOS section
        let agRows='';
        let agCred=0,agDeb=0;
        if(txsAg.length){
            txsAg.forEach(t=>{
                const dt=t.dt?new Date(t.dt+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}):'‚Äî';
                const isR=t.tp==='Receita';
                const credito=isR?t.v:0;
                const debito=isR?0:t.v;
                agCred+=credito;agDeb+=debito;
                const subLabel=t.sub?' ‚Ä∫ '+t.sub:'';
                const descExtra=`<div class="bk-cat">${t.cat||''}${subLabel}</div>`;
                agRows+=`<tr class="bk-agendado" style="cursor:pointer" onclick="editItem('tx','${t.id}')"><td style="font-size:11px;color:var(--text3);white-space:nowrap"><span class="bk-st bk-st-ag"></span>${dt}</td><td><div class="bk-desc">üïê ${t.desc}</div>${descExtra}</td><td class="bk-credit">${credito?fmtN(credito):''}</td><td class="bk-debit">${debito?fmtN(debito):''}</td><td></td></tr>`;
            });
            const saldoPrevisto=saldo+agCred-agDeb;
            agRows+=`<tr style="background:rgba(245,158,11,0.1)"><td colspan="2" style="font-size:12px;color:#f59e0b;font-weight:700">üïê Total Agendado</td><td class="bk-credit" style="font-weight:700;color:#f59e0b">${agCred?fmtN(agCred):''}</td><td class="bk-debit" style="font-weight:700;color:#f59e0b">${agDeb?fmtN(agDeb):''}</td><td style="font-weight:700;color:#f59e0b">${fmtN(saldoPrevisto)}</td></tr>`;
        }
        
        html+=`<div class="bk-stmt">
<div class="bk-header"><div class="bk-name">üè¶ ${banco}</div><div class="bk-saldo-final ${saldo>=0?'bk-saldo-pos':'bk-saldo-neg'}">${fmt(saldo)}</div></div>
<div style="overflow-x:auto"><table class="bk-table"><thead><tr><th style="width:60px">Data</th><th>Descri√ß√£o</th><th style="width:80px">Cr√©dito</th><th style="width:80px">D√©bito</th><th style="width:85px">Saldo</th></tr></thead><tbody>${rows}${agRows?'<tr><td colspan="5" style="padding:8px 0;border-bottom:2px dashed rgba(245,158,11,0.4)"><div style="font-size:11px;font-weight:700;color:#f59e0b;text-align:center">üïê AGENDADOS / PENDENTES</div></td></tr>'+agRows:''}</tbody></table></div>
<div class="bk-footer">
<div class="bk-footer-item"><div class="bk-footer-label">Cr√©ditos</div><div class="bk-credit" style="font-family:var(--mono);font-weight:700">${fmtN(totalCredito)}</div></div>
<div class="bk-footer-item"><div class="bk-footer-label">D√©bitos</div><div class="bk-debit" style="font-family:var(--mono);font-weight:700">${fmtN(totalDebito)}</div></div>
<div class="bk-footer-item"><div class="bk-footer-label">Movimenta√ß√£o</div><div style="font-family:var(--mono);font-weight:700;color:${(totalCredito-totalDebito)>=0?'var(--green)':'var(--red)'}">${fmtN(totalCredito-totalDebito)}</div></div>
</div></div>`;
    });
    
    if(!html) html='<div class="empty"><p>Nenhuma conta cadastrada</p></div>';
    $('extBankContent').innerHTML=html;
}

function fmtN(v){return v.toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}

function setFilter(f,el){
    txFilt=f;
    document.querySelectorAll('#page-ext .toggle-tab').forEach(t=>t.classList.remove('active'));
    el.classList.add('active');
    const sub=$('extSubFilter');
    const sel=$('extSubSel');
    if(f==='Despesa'||f==='Receita'){
        sub.style.display='block';
        sel.innerHTML='<option value="__all__">üè¶ Todas as contas</option>';
        getBancos().forEach(b=>{const o=document.createElement('option');o.value=b;o.textContent=b;sel.appendChild(o)});
        $('extDefault').style.display='block';$('extBankView').style.display='none';
    } else if(f==='Cartao'){
        sub.style.display='block';
        sel.innerHTML='<option value="__all__">üí≥ Todos os cart√µes</option>';
        getCartoes().forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o)});
        $('extDefault').style.display='block';$('extBankView').style.display='none';
    } else if(f==='Conta'){
        sub.style.display='block';
        sel.innerHTML='';
        const oAll=document.createElement('option');oAll.value='__todas__';oAll.textContent='üè¶ Todas as contas';sel.appendChild(oAll);
        getBancos().forEach(b=>{const o=document.createElement('option');o.value=b;o.textContent=b;sel.appendChild(o)});
        $('extDefault').style.display='none';$('extBankView').style.display='block';
    } else {
        sub.style.display='none';
        $('extDefault').style.display='block';$('extBankView').style.display='none';
    }
    rExt();
}
function setAddType(tp,el){
    addTp=tp;
    document.querySelectorAll('#addTabs .toggle-tab').forEach(t=>t.classList.remove('active'));
    if(el)el.classList.add('active');
    updateCatOptions();
    updateDestinoUI();
    if(tp==='Receita'){
        $('btnSave').className='btn btn-green';$('btnSave').innerHTML='üí∞ Salvar Receita';
    } else if(tp==='Transf'){
        $('btnSave').className='btn btn-primary';$('btnSave').innerHTML='üîÑ Salvar Transfer√™ncia';
    } else {
        $('btnSave').className='btn btn-red';$('btnSave').innerHTML='üí∏ Salvar Despesa';
    }
}

function parseMonthSel(val){const p=val.split('-');return{m:parseInt(p[0]),y:parseInt(p[1])}}

// -- Save Transaction (unified) --
function saveTx(){
    const desc=$('fDesc').value.trim();
    const val=parseFloat($('fValor').value);
    if(!val||val<=0){toast('Preencha o valor',true);return}
    const my=parseMonthSel($('fMonth').value);
    
    // TRANSFER√äNCIA
    if(addTp==='Transf'){
        const origem=$('fTransfOrigem').value;
        const destino=$('fTransfDestino').value;
        if(origem===destino){toast('Origem e destino devem ser diferentes',true);return}
        const descFinal=desc||'Transfer√™ncia '+origem+' ‚Üí '+destino;
        const transfId=uid();
        // D√©bito na origem
        D.tx.push({id:uid(),dt:$('fDate').value,m:my.m,y:my.y,desc:descFinal,v:val,tp:'Despesa',banco:origem,cat:'Transfer√™ncia',sub:destino,st:'efetivado',transf:true,transfId,transfOrigem:origem,transfDestino:destino});
        // Cr√©dito no destino
        D.tx.push({id:uid(),dt:$('fDate').value,m:my.m,y:my.y,desc:descFinal,v:val,tp:'Receita',banco:destino,cat:'Transfer√™ncia',sub:origem,st:'efetivado',transf:true,transfId,transfOrigem:origem,transfDestino:destino});
        save();
        $('fDesc').value='';$('fValor').value='';
        toast('üîÑ Transfer√™ncia: '+fmt(val)+' de '+origem+' ‚Üí '+destino);
        return;
    }
    
    if(!desc){toast('Preencha a descri√ß√£o',true);return}
    const cat=$('fCat').value;
    const subCat=$('fSubCat')?$('fSubCat').value:'';
    const subCatClean=(subCat==='__nova_sub__'||subCat==='')?'':subCat;
    
    if(addTp==='Receita' || (addTp==='Despesa' && addDestino==='conta')){
        // Lan√ßamento em conta banc√°ria
        const banco=$('fBanco').value;
        if(contaFreq==='recorrente'){
            const qtd=parseInt($('fRecQtd').value)||12;
            const intervalo=parseInt($('fRecIntervalo').value)||1;
            const unidade=$('fRecUnidade').value;
            const startDt=$('fDate').value||new Date().toISOString().split('T')[0];
            const dates=recDatesCalc(startDt,unidade,intervalo,qtd);
            const recGroupId=uid();
            const freqLabel=recFreqLabel(unidade,intervalo);
            dates.forEach((d,r)=>{
                D.tx.push({id:uid(),dt:d.dt,m:d.m,y:d.y,desc:desc+' ‚ôªÔ∏è',v:val,tp:addTp,banco,cat,sub:subCatClean,st:r===0?addStatus:'agendado',rec:true,recGroup:recGroupId,recDur:qtd,recIdx:r+1,recFreq:freqLabel});
            });
            toast('‚úÖ '+addTp+' recorrente: '+freqLabel+' √ó '+qtd+'x');
        } else {
            D.tx.push({id:uid(),dt:$('fDate').value,m:my.m,y:my.y,desc,v:val,tp:addTp,banco,cat,sub:subCatClean,st:addStatus});
            toast(addTp==='Receita'?'‚úÖ Receita salva!':'‚úÖ Despesa salva!');
        }
        save();
        $('fDesc').value='';$('fValor').value='';
        contaFreq='unico';
        if($('contaFreqTabs')){document.querySelectorAll('#contaFreqTabs .toggle-tab').forEach(t=>t.classList.remove('active'));$('contaFreqTabs').querySelector('.toggle-tab').classList.add('active');$('contaRecRow').style.display='none'}
    } else {
        // Lan√ßamento no cart√£o de cr√©dito
        const card=$('fCartao').value;
        const tipo=$('fCompTipo').value;
        
        if(tipo==='Parcelado'){
            const pt=parseInt($('fParcT').value)||2;
            let parcVal, totalCompra;
            if(parcMode==='total'){
                totalCompra=val;
                parcVal=Math.round((val/pt)*100)/100;
            } else {
                parcVal=val;
                totalCompra=Math.round((val*pt)*100)/100;
            }
            for(let p=1;p<=pt;p++){
                const target=stepMonth(my.m,my.y,p-1);
                D.cp.push({id:uid(),dt:$('fDate').value,m:target.m,y:target.y,card,desc:`${desc} (${p}/${pt})`,v:parcVal,tipo:'Parcelado',parc:`${p}/${pt}`,totalCompra,cat,sub:subCatClean,st:addStatus});
            }
        } else if(tipo==='Recorrente'){
            const dur=parseInt($('fParcT').value)||1;
            for(let r=0;r<dur;r++){
                const target=stepMonth(my.m,my.y,r);
                D.cp.push({id:uid(),dt:$('fDate').value,m:target.m,y:target.y,card,desc:`${desc} ‚ôªÔ∏è`,v:val,tipo:'Recorrente',parc:'',recDur:dur,cat,sub:subCatClean,st:addStatus});
            }
        } else {
            D.cp.push({id:uid(),dt:$('fDate').value,m:my.m,y:my.y,card,desc,v:val,tipo:'√Ä Vista',parc:'',cat,sub:subCatClean,st:addStatus});
        }
        save();
        $('fDesc').value='';$('fValor').value='';
        toast('‚úÖ Compra registrada no cart√£o!');
    }
}

function delTx(id){
    if(!confirm('Excluir este lan√ßamento?'))return;
    D.tx=D.tx.filter(t=>t.id!==id);save();rExt();toast('Lan√ßamento exclu√≠do');
}

function toggleTxStatus(id){
    const tx=D.tx.find(t=>t.id===id);
    if(!tx)return;
    tx.st=(tx.st==='efetivado'||!tx.st)?'agendado':'efetivado';
    save();rExt();
    toast(tx.st==='efetivado'?'‚úÖ Marcado como efetivado':'üïê Marcado como agendado');
}

function delCardExt(id){
    if(!confirm('Excluir esta compra do cart√£o?'))return;
    D.cp=D.cp.filter(c=>c.id!==id);save();rExt();toast('Compra exclu√≠da');
}

// -- Edit Item --
let editingType='', editingId='';

function editItem(type,id){
    editingType=type;
    editingId=id;
    let item;
    if(type==='tx') item=D.tx.find(t=>t.id===id);
    else item=D.cp.find(c=>c.id===id);
    if(!item)return;
    
    $('edDesc').value=item.desc||'';
    $('edValor').value=item.v||0;
    
    // Populate categories
    const sel=$('edCat');sel.innerHTML='';
    const isReceita=(type==='tx'&&item.tp==='Receita');
    const cats=isReceita?getCatsR():getCatsD();
    cats.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o)});
    const oNew=document.createElement('option');oNew.value='__nova__';oNew.textContent='Ôºã Nova categoria...';sel.appendChild(oNew);
    if(item.cat) sel.value=item.cat;
    
    onEdCatChange(item.sub||'');
    
    $('editModal').classList.add('show');
}

function onEdCatChange(preselect){
    const cat=$('edCat').value;
    if(cat==='__nova__'){
        const nome=prompt('Nome da nova categoria:');
        if(!nome||!nome.trim()){
            // reset to first
            $('edCat').value=$('edCat').options[0].value;
            onEdCatChange('');
            return;
        }
        const catName=nome.trim();
        // Detect if editing receita or despesa
        const item=editingType==='tx'?D.tx.find(t=>t.id===editingId):D.cp.find(c=>c.id===editingId);
        const isReceita=(editingType==='tx'&&item&&item.tp==='Receita');
        if(isReceita){
            if(!D.catsR) D.catsR=[...CATS_R_DEFAULT];
            if(!D.catsR.includes(catName)) D.catsR.push(catName);
        } else {
            if(!D.catsD) D.catsD=[...CATS_D_DEFAULT];
            if(!D.catsD.includes(catName)) D.catsD.push(catName);
        }
        save();
        // Re-populate and select
        const sel=$('edCat');
        const cats2=isReceita?getCatsR():getCatsD();
        sel.innerHTML='';
        cats2.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;sel.appendChild(o)});
        const oN=document.createElement('option');oN.value='__nova__';oN.textContent='Ôºã Nova categoria...';sel.appendChild(oN);
        sel.value=catName;
        toast('‚úÖ Categoria "'+catName+'" criada!');
    }
    
    // Subcategories
    const catVal=$('edCat').value;
    const subs=getSubsFor(catVal);
    const subSel=$('edSub');subSel.innerHTML='';
    const oNone=document.createElement('option');oNone.value='';oNone.textContent='‚Äî Geral (sem subcategoria)';subSel.appendChild(oNone);
    subs.forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;subSel.appendChild(o)});
    const oNewSub=document.createElement('option');oNewSub.value='__nova_sub__';oNewSub.textContent='Ôºã Nova subcategoria...';subSel.appendChild(oNewSub);
    if(preselect!==undefined&&preselect!=='') subSel.value=preselect;
}

// Listen for new subcategory in edit modal
document.addEventListener('change',function(e){
    if(e.target.id==='edSub' && e.target.value==='__nova_sub__'){
        const cat=$('edCat').value;
        const nome=prompt('Nova subcategoria para "'+cat+'":');
        if(!nome||!nome.trim()){$('edSub').value='';return}
        const subName=nome.trim();
        if(!D.subCats) D.subCats={};
        if(!D.subCats[cat]) D.subCats[cat]=[];
        if(!D.subCats[cat].includes(subName)){D.subCats[cat].push(subName);save();toast('‚úÖ Subcategoria "'+subName+'" criada!')}
        onEdCatChange(subName);
    }
});

function saveEdit(){
    let item;
    if(editingType==='tx') item=D.tx.find(t=>t.id===editingId);
    else item=D.cp.find(c=>c.id===editingId);
    if(!item)return;
    
    const desc=$('edDesc').value.trim();
    const val=parseFloat($('edValor').value);
    const cat=$('edCat').value;
    const sub=$('edSub').value;
    
    if(desc) item.desc=desc;
    if(val&&val>0) item.v=val;
    if(cat&&cat!=='__nova__') item.cat=cat;
    item.sub=(sub==='__nova_sub__'||!sub)?'':sub;
    
    save();closeEditModal();rExt();
    toast('‚úÖ Lan√ßamento atualizado!');
}

function closeEditModal(){$('editModal').classList.remove('show')}

function rCfg(){
    // Brapi token
    if($('cfgBrapiToken')){
        $('cfgBrapiToken').value=D.brapiToken||'';
        const st=$('cfgBrapiStatus');
        if(D.brapiToken){st.textContent='‚úÖ Token configurado';st.style.color='var(--green)';}
        else{st.textContent='Sem token ‚Äî apenas D√≥lar, Euro e Bitcoin ser√£o exibidos.';st.style.color='var(--text3)';}
    }
    // User name
    $('cfgUserName').value=D.userName||'';
    // Banks with saldo + rename/delete
    $('cfgBancos').innerHTML=getBancos().map((b,i)=>`<div class="config-row"><span class="config-label" style="flex:1">${b}</span><input type="number" step="0.01" class="config-input" data-banco="${b}" value="${(D.bs[b]||0).toFixed(2)}" style="width:90px;margin-right:6px"><button style="padding:3px 8px;font-size:10px;background:var(--primary-glow);color:var(--primary);border:1px solid rgba(59,130,246,0.3);border-radius:4px;cursor:pointer;margin-right:4px" onclick="renameBanco(${i})">‚úèÔ∏è</button><button style="padding:3px 8px;font-size:10px;background:var(--red-bg);color:var(--red);border:1px solid rgba(239,68,68,0.3);border-radius:4px;cursor:pointer" onclick="removeBanco(${i})">‚úï</button></div>`).join('');
    // Cards with vencimento + conta pagamento + rename/delete
    $('cfgCards').innerHTML=getCartoes().map((c,i)=>{
        let opts=getBancos().map(b=>`<option value="${b}"${D.ca[c]===b?' selected':''}>${b}</option>`).join('');
        const venc=getVencs()[i]||10;
        return`<div style="background:var(--surface2);border-radius:var(--radius-sm);padding:10px;margin-bottom:6px;border:1px solid var(--border)"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px"><span style="font-weight:600;font-size:13px">${c}</span><div><button style="padding:3px 8px;font-size:10px;background:var(--primary-glow);color:var(--primary);border:1px solid rgba(59,130,246,0.3);border-radius:4px;cursor:pointer;margin-right:4px" onclick="renameCartao(${i})">‚úèÔ∏è</button><button style="padding:3px 8px;font-size:10px;background:var(--red-bg);color:var(--red);border:1px solid rgba(239,68,68,0.3);border-radius:4px;cursor:pointer" onclick="removeCartao(${i})">‚úï</button></div></div><div style="display:flex;gap:8px"><div style="flex:1"><label style="font-size:10px;color:var(--text3)">Vencimento</label><input type="number" min="1" max="31" class="config-input" data-venc="${i}" value="${venc}" style="width:100%;text-align:center"></div><div style="flex:2"><label style="font-size:10px;color:var(--text3)">Conta pagamento</label><select class="config-select" data-card="${c}" style="width:100%">${opts}</select></div></div></div>`;
    }).join('');
    // Categories
    renderCatList('cfgCatsR',getCatsR(),'R');
    renderCatList('cfgCatsD',getCatsD(),'D');
}

function renderCatList(elId,cats,tipo){
    $(elId).innerHTML=cats.map((c,i)=>{
        const subs=getSubsFor(c);
        const subsHtml=subs.length?subs.map((s,si)=>`<div class="config-row" style="padding-left:24px;border-bottom:1px solid var(--border)"><span class="config-label" style="font-size:12px;color:var(--text3)">‚Ü≥ ${s}</span><button style="padding:3px 8px;font-size:10px;background:var(--primary-glow);color:var(--primary);border:1px solid rgba(59,130,246,0.3);border-radius:4px;cursor:pointer;margin-right:4px" onclick="renameSubCat('${c}',${si})">‚úèÔ∏è</button><button style="padding:3px 8px;font-size:10px;background:var(--red-bg);color:var(--red);border:1px solid rgba(239,68,68,0.3);border-radius:4px;cursor:pointer" onclick="removeSubCat('${c}',${si})">‚úï</button></div>`).join(''):'';
        const addSubHtml=`<div class="config-row" style="padding-left:24px"><input type="text" class="form-input" placeholder="Nova subcategoria..." style="flex:1;padding:5px 8px;font-size:11px" id="newSub_${tipo}_${i}"><button style="padding:4px 8px;font-size:10px;background:var(--surface3);color:var(--primary);border:1px solid var(--border);border-radius:4px;cursor:pointer;margin-left:6px" onclick="addSubCat('${c}','newSub_${tipo}_${i}')">+ Sub</button></div>`;
        return`<div style="border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:6px;overflow:hidden"><div class="config-row" style="padding:8px 12px;border-bottom:${subs.length?'1px solid var(--border)':'none'}"><span class="config-label" style="font-weight:600">${c}</span><span style="font-size:10px;color:var(--text3);margin-right:8px">${subs.length} sub</span><button style="padding:4px 10px;font-size:11px;background:var(--primary-glow);color:var(--primary);border:1px solid rgba(59,130,246,0.3);border-radius:6px;cursor:pointer;margin-right:4px" onclick="renameCat('${tipo}',${i})">‚úèÔ∏è</button><button style="padding:4px 10px;font-size:11px;background:var(--red-bg);color:var(--red);border:1px solid rgba(239,68,68,0.3);border-radius:6px;cursor:pointer" onclick="removeCat('${tipo}',${i})">üóëÔ∏è</button></div>${subsHtml}${addSubHtml}</div>`;
    }).join('');
}

function addCatR(){
    const nome=$('newCatR').value.trim();
    if(!nome){toast('Digite o nome da categoria',true);return}
    if(!D.catsR) D.catsR=[...CATS_R_DEFAULT];
    if(D.catsR.includes(nome)){toast('Categoria j√° existe',true);return}
    D.catsR.push(nome);save();$('newCatR').value='';rCfg();toast('‚úÖ Categoria "'+nome+'" criada!');
}

function addCatD(){
    const nome=$('newCatD').value.trim();
    if(!nome){toast('Digite o nome da categoria',true);return}
    if(!D.catsD) D.catsD=[...CATS_D_DEFAULT];
    if(D.catsD.includes(nome)){toast('Categoria j√° existe',true);return}
    D.catsD.push(nome);save();$('newCatD').value='';rCfg();toast('‚úÖ Categoria "'+nome+'" criada!');
}

function removeCat(tipo,idx){
    const list=tipo==='R'?getCatsR():getCatsD();
    const nome=list[idx];
    if(!confirm('Excluir a categoria "'+nome+'"?\n\nLan√ßamentos j√° feitos com esta categoria n√£o ser√£o afetados.'))return;
    list.splice(idx,1);
    if(tipo==='R') D.catsR=list; else D.catsD=list;
    save();rCfg();toast('Categoria "'+nome+'" exclu√≠da');
}

function renameCat(tipo,idx){
    const list=tipo==='R'?getCatsR():getCatsD();
    const nomeAtual=list[idx];
    const novoNome=prompt('Renomear categoria:\n\nNome atual: '+nomeAtual+'\n\nNovo nome:',nomeAtual);
    if(!novoNome||!novoNome.trim()||novoNome.trim()===nomeAtual)return;
    const novo=novoNome.trim();
    if(list.includes(novo)){toast('J√° existe uma categoria com esse nome',true);return}
    D.tx.forEach(t=>{if(t.cat===nomeAtual) t.cat=novo});
    D.cp.forEach(c=>{if(c.cat===nomeAtual) c.cat=novo});
    // Rename subcats key
    if(D.subCats&&D.subCats[nomeAtual]){D.subCats[novo]=D.subCats[nomeAtual];delete D.subCats[nomeAtual]}
    list[idx]=novo;
    if(tipo==='R') D.catsR=list; else D.catsD=list;
    save();rCfg();toast('‚úÖ "'+nomeAtual+'" ‚Üí "'+novo+'"');
}

function addSubCat(cat,inputId){
    const inp=$(inputId);
    const nome=inp.value.trim();
    if(!nome){toast('Digite o nome da subcategoria',true);return}
    if(!D.subCats) D.subCats={};
    if(!D.subCats[cat]) D.subCats[cat]=[];
    if(D.subCats[cat].includes(nome)){toast('Subcategoria j√° existe',true);return}
    D.subCats[cat].push(nome);save();rCfg();toast('‚úÖ Subcategoria "'+nome+'" criada em '+cat);
}

function removeSubCat(cat,idx){
    const nome=D.subCats[cat][idx];
    if(!confirm('Excluir subcategoria "'+nome+'" de "'+cat+'"?'))return;
    D.subCats[cat].splice(idx,1);
    save();rCfg();toast('Subcategoria removida');
}

function renameSubCat(cat,idx){
    const nomeAtual=D.subCats[cat][idx];
    const novo=prompt('Renomear subcategoria:\n\nAtual: '+nomeAtual+'\nNovo nome:',nomeAtual);
    if(!novo||!novo.trim()||novo.trim()===nomeAtual)return;
    const novoNome=novo.trim();
    if(D.subCats[cat].includes(novoNome)){toast('J√° existe',true);return}
    // Update existing records
    D.tx.forEach(t=>{if(t.cat===cat&&t.sub===nomeAtual) t.sub=novoNome});
    D.cp.forEach(c=>{if(c.cat===cat&&c.sub===nomeAtual) c.sub=novoNome});
    D.subCats[cat][idx]=novoNome;
    save();rCfg();toast('‚úÖ "'+nomeAtual+'" ‚Üí "'+novoNome+'"');
}

function rCard(){
    const total=mCardT(cMonth,cYear);
    const totalPago=mCp(cMonth,cYear).filter(c=>c.st==='paga').reduce((s,c)=>s+c.v,0);
    const totalAberto=total-totalPago;
    $('kCard').innerHTML=`<div style="font-size:22px">${fmt(total)}</div><div style="display:flex;gap:16px;justify-content:center;margin-top:6px;font-size:12px"><span style="color:var(--green)">‚úÖ Pago: ${fmt(totalPago)}</span><span style="color:var(--red)">üî¥ Aberto: ${fmt(totalAberto)}</span></div>`;
    $('cardSum').innerHTML=getCartoes().map((c,i)=>{
        const cpList=mCp(cMonth,cYear).filter(x=>x.card===c);
        const val=cpList.reduce((s,x)=>s+x.v,0);
        const items=cpList.length;
        const allPaid=items>0&&cpList.every(x=>x.st==='paga');
        const somePaid=cpList.some(x=>x.st==='paga');
        let stLabel='';
        if(items===0) stLabel='<span style="font-size:10px;color:var(--text3)">Sem compras</span>';
        else if(allPaid) stLabel='<span style="font-size:10px;background:var(--green-bg);color:var(--green);padding:2px 8px;border-radius:4px">‚úÖ Paga</span>';
        else if(somePaid) stLabel='<span style="font-size:10px;background:var(--yellow-bg,rgba(245,158,11,0.15));color:#f59e0b;padding:2px 8px;border-radius:4px">‚ö†Ô∏è Parcial</span>';
        else stLabel='<span style="font-size:10px;background:var(--red-bg);color:var(--red);padding:2px 8px;border-radius:4px">üî¥ Aberta</span>';
        const payBtn=(!allPaid&&items>0)?`<button style="font-size:11px;padding:4px 10px;background:var(--green);color:#fff;border:none;border-radius:6px;cursor:pointer;margin-top:6px" onclick="event.stopPropagation();payFatura('${c}')">üí∞ Pagar Fatura</button>`:'';
        const reopenBtn=(allPaid&&items>0)?`<button style="font-size:11px;padding:4px 10px;background:var(--surface3);color:var(--red);border:1px solid rgba(239,68,68,0.3);border-radius:6px;cursor:pointer;margin-top:6px" onclick="event.stopPropagation();reopenFatura('${c}')">üîì Reabrir Fatura</button>`:'';
        const vencDia=getVencs()[i];
        const hoje=new Date();
        const vencDate=new Date(cYear,cMonth,vencDia);
        const diasPraVenc=Math.ceil((vencDate-hoje)/(1000*60*60*24));
        let vencBadge='';
        if(allPaid&&items>0) vencBadge=`<span style="font-size:11px;background:var(--green-bg);color:var(--green);padding:2px 8px;border-radius:4px;font-weight:600">Venc. ${vencDia} ¬∑ ‚úÖ Paga</span>`;
        else if(diasPraVenc<0) vencBadge=`<span style="font-size:11px;background:var(--red-bg);color:var(--red);padding:2px 8px;border-radius:4px;font-weight:600">Venc. ${vencDia} ¬∑ Vencida</span>`;
        else if(diasPraVenc<=5) vencBadge=`<span style="font-size:11px;background:rgba(245,158,11,0.15);color:#f59e0b;padding:2px 8px;border-radius:4px;font-weight:600">Venc. ${vencDia} ¬∑ ${diasPraVenc}d</span>`;
        else vencBadge=`<span style="font-size:11px;background:var(--surface3);color:var(--text2);padding:2px 8px;border-radius:4px;font-weight:600">Venc. dia ${vencDia}</span>`;
        return`<div class="card-sum-item" onclick="showCardDetail('${c}')"><div class="card-sum-left"><div class="card-sum-name" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">${c} ${vencBadge} ${stLabel}</div><div class="card-sum-details">${items} compra${items!==1?'s':''} ¬∑ Paga com ${D.ca[c]||'‚Äî'}</div>${payBtn}${reopenBtn}</div><div class="card-sum-amount">${fmt(val)}</div></div>`;
    }).join('');
}

let payingCard='';

function payFatura(card){
    const cpList=mCp(cMonth,cYear).filter(c=>c.card===card&&c.st!=='paga');
    if(!cpList.length){toast('Fatura j√° est√° paga!');return}
    payingCard=card;
    const total=cpList.reduce((s,c)=>s+c.v,0);
    
    $('payCard').textContent=card;
    $('payQtd').textContent=cpList.length+' compra'+(cpList.length!==1?'s':'');
    $('payTotal').textContent=fmt(total);
    
    // Populate conta dropdown, pre-select the configured account
    const sel=$('payConta');sel.innerHTML='';
    getBancos().forEach(b=>{
        const o=document.createElement('option');o.value=b;o.textContent=b;
        if(D.ca[card]===b) o.selected=true;
        sel.appendChild(o);
    });
    
    // Default date to today
    $('payData').value=new Date().toISOString().split('T')[0];
    
    $('payModal').classList.add('show');
}

function closePayModal(){$('payModal').classList.remove('show')}

function confirmPayFatura(){
    const card=payingCard;
    const conta=$('payConta').value;
    const data=$('payData').value;
    if(!data){toast('Informe a data do pagamento',true);return}
    
    const cpList=mCp(cMonth,cYear).filter(c=>c.card===card&&c.st!=='paga');
    const total=cpList.reduce((s,c)=>s+c.v,0);
    
    // Mark all card purchases as paid
    cpList.forEach(c=>{
        const cp=D.cp.find(x=>x.id===c.id);
        if(cp){cp.st='paga';cp.paidDt=data;cp.paidConta=conta}
    });
    
    // Create transaction in bank account (flagged to avoid category duplication)
    D.tx.push({
        id:uid(),
        dt:data,
        m:cMonth,
        y:cYear,
        desc:'Pgto Fatura '+card,
        v:total,
        tp:'Despesa',
        banco:conta,
        cat:'Cart√£o Cr√©dito',
        sub:card,
        st:'efetivado',
        pgtoFatura:true,
        pgtoCard:card
    });
    
    save();closePayModal();rCard();
    toast('‚úÖ Fatura do '+card+' paga! '+fmt(total)+' debitado de '+conta);
}

function reopenFatura(card){
    const cpList=mCp(cMonth,cYear).filter(c=>c.card===card&&c.st==='paga');
    if(!cpList.length){toast('Nenhuma compra paga para reabrir');return}
    const total=cpList.reduce((s,c)=>s+c.v,0);
    if(!confirm('Reabrir fatura do '+card+'?\n\nIsso vai desmarcar '+cpList.length+' compra'+(cpList.length!==1?'s':'')+' ('+fmt(total)+') como n√£o pagas e remover o lan√ßamento de pagamento da conta.'))return;
    
    // Reopen card purchases
    cpList.forEach(c=>{
        const cp=D.cp.find(x=>x.id===c.id);
        if(cp){cp.st='aberta';delete cp.paidDt;delete cp.paidConta}
    });
    
    // Remove the payment transaction from bank account
    D.tx=D.tx.filter(t=>!(t.pgtoFatura&&t.pgtoCard===card&&t.m===cMonth&&t.y===cYear));
    
    save();rCard();
    toast('üîì Fatura do '+card+' reaberta!');
}

function delCard(id){
    if(!confirm('Excluir esta compra?'))return;
    D.cp=D.cp.filter(c=>c.id!==id);save();rCard();toast('Compra exclu√≠da');
}

function showCardDetail(card){
    const items=mCp(cMonth,cYear).filter(c=>c.card===card);
    $('detailTitle').textContent=card+' ‚Äî '+MN[cMonth]+' '+cYear;
    if(!items.length){$('detailContent').innerHTML='<div class="empty"><p>Nenhuma compra registrada</p></div>'} 
    else{
        const total=items.reduce((s,c)=>s+c.v,0);
        $('detailContent').innerHTML=items.map(c=>{
            const dt=c.dt?new Date(c.dt+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'2-digit'}):'';
            const catLabel=c.cat?` ¬∑ ${c.cat}`:'';
            const subLabel=c.sub?' ‚Ä∫ '+c.sub:'';
            const stBadge=c.st==='paga'?'<span style="font-size:9px;background:var(--green-bg);color:var(--green);padding:1px 5px;border-radius:3px;margin-left:4px">‚úÖ</span>':'';
            return`<div class="tx-item"><div class="tx-icon card-icon">üí≥</div><div class="tx-info" style="cursor:pointer" onclick="closeDetailModal();editItem('cp','${c.id}')"><div class="tx-desc">${c.desc}${stBadge}</div><div class="tx-meta">${dt} ¬∑ ${c.tipo}${c.parc?' ¬∑ '+c.parc:''}${catLabel}${subLabel} <span style="font-size:9px;color:var(--primary)">‚úèÔ∏è</span></div></div><div class="tx-amount negative">${fmt(c.v)}</div><button class="tx-del" onclick="delCard('${c.id}');showCardDetail('${card}')">‚úï</button></div>`;
        }).join('')+`<div style="text-align:right;margin-top:12px;font-family:var(--mono);font-size:16px;font-weight:700;color:var(--red)">Total: ${fmt(total)}</div>`;
    }
    $('detailModal').classList.add('show');
}
function closeDetailModal(){$('detailModal').classList.remove('show')}

// -- Config --
function saveUserName(){
    D.userName=$('cfgUserName').value.trim();
    save();rDash();toast('‚úÖ Nome salvo!');
}

function saveBankCfg(){
    document.querySelectorAll('#cfgBancos .config-input').forEach(inp=>{D.bs[inp.dataset.banco]=parseFloat(inp.value)||0});
    save();toast('‚úÖ Saldos atualizados!');
}
function saveCardCfg(){
    document.querySelectorAll('#cfgCards .config-select').forEach(sel=>{D.ca[sel.dataset.card]=sel.value});
    document.querySelectorAll('#cfgCards [data-venc]').forEach(inp=>{
        const idx=parseInt(inp.dataset.venc);
        if(!D.vencs) D.vencs=[...VENCS_DEFAULT];
        D.vencs[idx]=parseInt(inp.value)||10;
    });
    save();toast('‚úÖ Cart√µes atualizados!');
}

function addBancoCfg(){
    const nome=$('newBanco').value.trim();
    if(!nome){toast('Digite o nome do banco',true);return}
    if(!D.bancos) D.bancos=[...BANCOS_DEFAULT];
    if(D.bancos.includes(nome)){toast('Banco j√° existe',true);return}
    D.bancos.push(nome);
    if(!D.bs[nome]) D.bs[nome]=0;
    save();$('newBanco').value='';rCfg();toast('‚úÖ Banco "'+nome+'" cadastrado!');
}

function renameBanco(idx){
    const list=getBancos();
    const atual=list[idx];
    const novo=prompt('Renomear banco:\n\nAtual: '+atual+'\nNovo nome:',atual);
    if(!novo||!novo.trim()||novo.trim()===atual)return;
    const novoNome=novo.trim();
    if(list.includes(novoNome)){toast('J√° existe',true);return}
    // Update references
    D.tx.forEach(t=>{if(t.banco===atual) t.banco=novoNome});
    if(D.bs[atual]!==undefined){D.bs[novoNome]=D.bs[atual];delete D.bs[atual]}
    Object.keys(D.ca).forEach(k=>{if(D.ca[k]===atual) D.ca[k]=novoNome});
    list[idx]=novoNome;
    D.bancos=list;
    save();rCfg();toast('‚úÖ "'+atual+'" ‚Üí "'+novoNome+'"');
}

function removeBanco(idx){
    const list=getBancos();
    const nome=list[idx];
    if(list.length<=1){toast('Precisa ter pelo menos um banco',true);return}
    if(!confirm('Excluir banco "'+nome+'"?\n\nLan√ßamentos existentes n√£o ser√£o afetados.'))return;
    list.splice(idx,1);
    D.bancos=list;
    save();rCfg();toast('Banco removido');
}

function addCartaoCfg(){
    const nome=$('newCartao').value.trim();
    if(!nome){toast('Digite o nome do cart√£o',true);return}
    if(!D.cartoes) D.cartoes=[...CARTOES_DEFAULT];
    if(!D.vencs) D.vencs=[...VENCS_DEFAULT];
    if(D.cartoes.includes(nome)){toast('Cart√£o j√° existe',true);return}
    D.cartoes.push(nome);
    D.vencs.push(10);
    D.ca[nome]=getBancos()[0];
    save();$('newCartao').value='';rCfg();toast('‚úÖ Cart√£o "'+nome+'" cadastrado!');
}

function renameCartao(idx){
    const list=getCartoes();
    const atual=list[idx];
    const novo=prompt('Renomear cart√£o:\n\nAtual: '+atual+'\nNovo nome:',atual);
    if(!novo||!novo.trim()||novo.trim()===atual)return;
    const novoNome=novo.trim();
    if(list.includes(novoNome)){toast('J√° existe',true);return}
    // Update references
    D.cp.forEach(c=>{if(c.card===atual) c.card=novoNome});
    D.tx.forEach(t=>{if(t.pgtoCard===atual) t.pgtoCard=novoNome;if(t.sub===atual&&t.pgtoFatura) t.sub=novoNome});
    if(D.ca[atual]!==undefined){D.ca[novoNome]=D.ca[atual];delete D.ca[atual]}
    list[idx]=novoNome;
    D.cartoes=list;
    save();rCfg();toast('‚úÖ "'+atual+'" ‚Üí "'+novoNome+'"');
}

function removeCartao(idx){
    const list=getCartoes();
    const nome=list[idx];
    if(list.length<=1){toast('Precisa ter pelo menos um cart√£o',true);return}
    if(!confirm('Excluir cart√£o "'+nome+'"?\n\nCompras existentes n√£o ser√£o afetadas.'))return;
    list.splice(idx,1);
    D.cartoes=list;
    if(D.vencs) D.vencs.splice(idx,1);
    save();rCfg();toast('Cart√£o removido');
}

// -- Export/Import --
function exportJSON(){
    const blob=new Blob([JSON.stringify(D,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='gestor_financeiro_backup_'+new Date().toISOString().split('T')[0]+'.json';a.click();toast('üì• Backup exportado!')
}
function exportCSV(){
    let csv='Tipo,Data,M√™s,Ano,Descri√ß√£o,Valor,Banco/Cart√£o,Categoria,Subcategoria,Parcela\n';
    D.tx.forEach(t=>{csv+=`${t.tp},${t.dt},${MN[t.m]},${t.y},\"${t.desc}\",${t.v.toFixed(2)},${t.banco},${t.cat||''},${t.sub||''},\n`});
    D.cp.forEach(c=>{csv+=`Cart√£o,${c.dt},${MN[c.m]},${c.y},\"${c.desc}\",${c.v.toFixed(2)},${c.card},${c.cat||''},${c.sub||''},${c.parc||''}\n`});
    const blob=new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='gestor_financeiro_'+new Date().toISOString().split('T')[0]+'.csv';a.click();toast('üìä CSV exportado!')
}
function importJSON(e){
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=function(ev){
        try{D=migrateData(JSON.parse(ev.target.result));save();refresh();toast('‚úÖ Dados importados com sucesso!')}
        catch(err){toast('‚ùå Erro ao importar arquivo',true)}
    };reader.readAsText(file);
    e.target.value='';
}
function clearAll(){D={tx:[],cp:[],bs:{...DSALDOS},ca:{...DCARDS},catsD:[...CATS_D_DEFAULT],catsR:[...CATS_R_DEFAULT],subCats:{...SUBCATS_DEFAULT},bancos:[...BANCOS_DEFAULT],cartoes:[...CARTOES_DEFAULT],vencs:[...VENCS_DEFAULT],_migrated:true};save();refresh();toast('üóëÔ∏è Dados limpos')}

// -- Suggestions --
function rSug(){
    const sugs=D.sugs||[];
    if(!sugs.length){$('sugList').innerHTML='';$('sugEmpty').style.display='block';return}
    $('sugEmpty').style.display='none';
    $('sugList').innerHTML=sugs.slice().reverse().map((s,i)=>{
        const idx=sugs.length-1-i;
        const dt=s.dt?new Date(s.dt).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'}):'';
        return`<div style="background:var(--surface2);border-radius:var(--radius-sm);padding:12px;margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><span style="font-size:12px;background:var(--primary-glow);color:var(--primary);padding:2px 8px;border-radius:4px">${s.tipo}</span><span style="font-size:11px;color:var(--text3)">${dt}</span></div><p style="font-size:13px;color:var(--text1);margin:0;line-height:1.4">${s.texto}</p><div style="text-align:right;margin-top:6px"><button style="font-size:11px;padding:2px 8px;background:var(--red-bg);color:var(--red);border:1px solid rgba(239,68,68,0.3);border-radius:4px;cursor:pointer" onclick="delSug(${idx})">Excluir</button></div></div>`;
    }).join('');
}

function saveBrapiToken(){
    const token=$('cfgBrapiToken').value.trim();
    D.brapiToken=token;save();
    if(token){
        toast('‚úÖ Token salvo! Cota√ß√µes de a√ß√µes ativadas.');
        $('cfgBrapiStatus').textContent='‚úÖ Token configurado. As cota√ß√µes ser√£o carregadas na aba Investimentos.';
        $('cfgBrapiStatus').style.color='var(--green)';
    } else {
        toast('Token removido');
        $('cfgBrapiStatus').textContent='Sem token ‚Äî apenas D√≥lar, Euro e Bitcoin ser√£o exibidos.';
        $('cfgBrapiStatus').style.color='var(--text3)';
    }
}

// ==================== INVESTIMENTOS ====================
let invTab='carteira';
let cotacoesCache={};
let invOpType='compra';

function getCarteiras(){if(!D.investCarteiras||!D.investCarteiras.length){D.investCarteiras=[{id:'c1',nome:'Minha Carteira'}];save()}return D.investCarteiras}
function getOps(){if(!D.investOps)D.investOps=[];return D.investOps}
function getCurCarteiraId(){return $('invCarteiraSelect')?$('invCarteiraSelect').value:getCarteiras()[0].id}

function setInvTab(tab){
    invTab=tab;
    document.querySelectorAll('.inv-tab').forEach(t=>t.classList.remove('active'));
    $('invTab'+(tab.charAt(0).toUpperCase()+tab.slice(1))).classList.add('active');
    $('invCarteira').style.display=tab==='carteira'?'block':'none';
    $('invOperacoes').style.display=tab==='operacoes'?'block':'none';
    $('invDividendos').style.display=tab==='dividendos'?'block':'none';
    if(tab==='operacoes')rInvestOps();
    if(tab==='dividendos')rInvestDividendos();
}

// -- Carteiras CRUD --
function addCarteira(){
    const nome=prompt('Nome da nova carteira:');
    if(!nome||!nome.trim())return;
    const id='c'+Date.now();
    getCarteiras().push({id,nome:nome.trim()});save();
    rInvestCarteira();$('invCarteiraSelect').value=id;rInvestCarteira();
    toast('‚úÖ Carteira "'+nome.trim()+'" criada!');
}
function renameCarteira(){
    const cid=getCurCarteiraId();const c=getCarteiras().find(x=>x.id===cid);if(!c)return;
    const nome=prompt('Renomear carteira:',c.nome);if(!nome||!nome.trim())return;
    c.nome=nome.trim();save();rInvestCarteira();toast('‚úÖ Renomeada!');
}
function delCarteira(){
    const carts=getCarteiras();if(carts.length<=1){toast('Precisa ter pelo menos 1 carteira',true);return}
    const cid=getCurCarteiraId();const c=carts.find(x=>x.id===cid);if(!c)return;
    if(!confirm('Excluir carteira "'+c.nome+'" e todas as opera√ß√µes?'))return;
    D.investCarteiras=carts.filter(x=>x.id!==cid);
    D.investOps=(D.investOps||[]).filter(o=>o.carteira!==cid);
    save();rInvestCarteira();toast('Carteira exclu√≠da');
}

// -- Opera√ß√µes (Compra/Venda) --
function openInvOp(tipo){
    invOpType=tipo;
    $('invOpTitle').textContent=tipo==='compra'?'üìà Compra de Ativo':'üìâ Venda de Ativo';
    $('invOpSaveBtn').style.background=tipo==='compra'?'var(--green)':'var(--red)';
    $('invOpSaveBtn').textContent=tipo==='compra'?'Registrar Compra':'Registrar Venda';
    const sel=$('invOpCarteira');
    sel.innerHTML=getCarteiras().map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');
    sel.value=getCurCarteiraId();
    $('invOpTicker').value='';$('invOpQtd').value='';$('invOpPreco').value='';
    $('invOpData').value=new Date().toISOString().split('T')[0];
    $('invOpTipo').value='acao';
    $('invOpModal').style.display='flex';
}
function closeInvOp(){$('invOpModal').style.display='none'}

function saveInvOp(){
    const carteira=$('invOpCarteira').value;
    const ticker=$('invOpTicker').value.trim().toUpperCase();
    const qtd=parseInt($('invOpQtd').value);
    const preco=parseFloat($('invOpPreco').value);
    const data=$('invOpData').value;
    const tipo=$('invOpTipo').value;
    if(!ticker){toast('Informe o ticker',true);return}
    if(!qtd||qtd<=0){toast('Informe a quantidade',true);return}
    if(!preco||preco<=0){toast('Informe o pre√ßo',true);return}
    if(!data){toast('Informe a data',true);return}
    // Validate sell: check if has enough shares
    if(invOpType==='venda'){
        const pos=calcPosition(carteira,ticker);
        if(qtd>pos.qtd){toast('Quantidade maior que posi√ß√£o ('+pos.qtd+' un)',true);return}
    }
    getOps().push({id:'op'+Date.now(),carteira,tipo:invOpType,tipoAtivo:tipo,ticker,qtd,preco,data});
    save();closeInvOp();rInvestCarteira();
    toast('‚úÖ '+(invOpType==='compra'?'Compra':'Venda')+' de '+qtd+' '+ticker+' registrada!');
}

// -- Calc position for a ticker in a carteira --
function calcPosition(carteiraId,ticker){
    const ops=getOps().filter(o=>o.carteira===carteiraId&&o.ticker===ticker);
    let qtd=0,totalCost=0;
    ops.sort((a,b)=>a.data.localeCompare(b.data));
    let lucroRealizado=0;
    ops.forEach(o=>{
        if(o.tipo==='compra'){
            totalCost+=o.qtd*o.preco;
            qtd+=o.qtd;
        } else {
            // Venda: realiza lucro com pre√ßo m√©dio
            const pm=qtd>0?totalCost/qtd:0;
            lucroRealizado+=(o.preco-pm)*o.qtd;
            totalCost-=pm*o.qtd;
            qtd-=o.qtd;
        }
    });
    const precoMedio=qtd>0?totalCost/qtd:0;
    const tipoAtivo=ops.length?ops[ops.length-1].tipoAtivo:'acao';
    return{qtd,precoMedio,totalCost,lucroRealizado,tipoAtivo};
}

// -- Render carteira --
function rInvestCarteira(){
    const carts=getCarteiras();
    const sel=$('invCarteiraSelect');
    const curId=sel.value||carts[0].id;
    sel.innerHTML=carts.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');
    sel.value=curId;
    
    // Find all unique tickers in current carteira
    const ops=getOps().filter(o=>o.carteira===curId);
    const tickers=[...new Set(ops.map(o=>o.ticker))];
    
    // Build positions
    const positions=[];
    tickers.forEach(tk=>{
        const pos=calcPosition(curId,tk);
        if(pos.qtd>0) positions.push({ticker:tk,...pos});
    });
    
    if(!positions.length){
        $('invResumo').innerHTML='';
        $('invCarteiraList').innerHTML='<div style="text-align:center;padding:30px;color:var(--text3)"><div style="font-size:36px;margin-bottom:8px">üíº</div><div style="font-size:13px">Nenhum ativo nesta carteira</div><div style="font-size:12px;margin-top:4px">Clique em "+ Compra" para come√ßar</div></div>';
        rInvestResumoGeral();return;
    }
    
    let totalInv=0,totalAtual=0,totalLucroReal=0;
    const tipoColors={acao:'var(--primary)',fii:'var(--purple)',bdr:'var(--orange)',etf:'var(--green)',crypto:'#f59e0b'};
    const tipoLabels={acao:'A√ß√£o',fii:'FII',bdr:'BDR',etf:'ETF',crypto:'Cripto'};
    
    let html='';
    positions.forEach(p=>{
        const cot=cotacoesCache[p.ticker];
        const precoAtual=cot?cot.price:p.precoMedio;
        const nome=cot?cot.name:'';
        const varPct=cot?cot.var:0;
        const investido=p.totalCost;
        const atual=p.qtd*precoAtual;
        const ganho=atual-investido;
        const ganhoPct=investido>0?((ganho/investido)*100):0;
        totalInv+=investido;totalAtual+=atual;totalLucroReal+=p.lucroRealizado;
        const tc=tipoColors[p.tipoAtivo]||'var(--text3)';
        
        html+=`<div class="inv-ativo">
<div style="flex:1;min-width:0">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
<span class="inv-ativo-ticker">${p.ticker}</span>
<span class="inv-ativo-tipo" style="background:${tc}20;color:${tc}">${tipoLabels[p.tipoAtivo]||p.tipoAtivo}</span>
${cot?`<span style="font-size:10px;color:${varPct>=0?'var(--green)':'var(--red)'};font-weight:600">${varPct>=0?'‚ñ≤':'‚ñº'} ${Math.abs(varPct).toFixed(2)}%</span>`:''}
</div>
<div class="inv-ativo-info">${nome?nome+' ¬∑ ':''}${p.qtd} un √ó PM R$ ${p.precoMedio.toFixed(2)}</div>
${p.lucroRealizado!==0?`<div style="font-size:10px;color:${p.lucroRealizado>=0?'var(--green)':'var(--red)'}">Lucro realizado: ${p.lucroRealizado>=0?'+':''}${fmt(p.lucroRealizado)}</div>`:''}
</div>
<div class="inv-ativo-val">
<div class="inv-ativo-current">${fmt(atual)}</div>
<div class="inv-ativo-gain" style="color:${ganho>=0?'var(--green)':'var(--red)'}">${ganho>=0?'+':''}${fmt(ganho)} (${ganhoPct>=0?'+':''}${ganhoPct.toFixed(1)}%)</div>
</div>
</div>`;
    });
    
    const ganhoTotal=totalAtual-totalInv;
    const ganhoPctTotal=totalInv>0?((ganhoTotal/totalInv)*100):0;
    
    $('invResumo').innerHTML=`
<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px">
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center">
<div><div style="font-size:11px;color:var(--text3);margin-bottom:2px">Investido</div><div style="font-family:var(--mono);font-size:14px;font-weight:700">${fmt(totalInv)}</div></div>
<div><div style="font-size:11px;color:var(--text3);margin-bottom:2px">Valor Atual</div><div style="font-family:var(--mono);font-size:14px;font-weight:700">${fmt(totalAtual)}</div></div>
<div><div style="font-size:11px;color:var(--text3);margin-bottom:2px">Resultado</div><div style="font-family:var(--mono);font-size:14px;font-weight:700;color:${ganhoTotal>=0?'var(--green)':'var(--red)'}">${ganhoTotal>=0?'+':''}${fmt(ganhoTotal)}<br><span style="font-size:11px">(${ganhoPctTotal>=0?'+':''}${ganhoPctTotal.toFixed(1)}%)</span></div></div>
</div>
${totalLucroReal?`<div style="text-align:center;margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:11px;color:${totalLucroReal>=0?'var(--green)':'var(--red)'}">Lucro realizado total: ${totalLucroReal>=0?'+':''}${fmt(totalLucroReal)}</div>`:''}
</div>`;
    
    $('invCarteiraList').innerHTML=html;
    rInvestResumoGeral();
}

function rInvestResumoGeral(){
    // Sum across all carteiras
    const carts=getCarteiras();
    let gTotalInv=0,gTotalAtual=0;
    carts.forEach(c=>{
        const ops=getOps().filter(o=>o.carteira===c.id);
        const tickers=[...new Set(ops.map(o=>o.ticker))];
        tickers.forEach(tk=>{
            const pos=calcPosition(c.id,tk);
            if(pos.qtd>0){
                const cot=cotacoesCache[tk];
                gTotalInv+=pos.totalCost;
                gTotalAtual+=pos.qtd*(cot?cot.price:pos.precoMedio);
            }
        });
    });
    if(gTotalInv===0){$('invResumoGeral').innerHTML='';return}
    const g=gTotalAtual-gTotalInv;
    const gp=gTotalInv>0?((g/gTotalInv)*100):0;
    $('invResumoGeral').innerHTML=carts.length>1?`<div style="background:linear-gradient(135deg,var(--primary)15,var(--surface));border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center"><span style="font-size:12px;font-weight:700">üìä Patrim√¥nio Total</span><span style="font-family:var(--mono);font-size:14px;font-weight:700">${fmt(gTotalAtual)} <span style="font-size:11px;color:${g>=0?'var(--green)':'var(--red)'}">(${g>=0?'+':''}${gp.toFixed(1)}%)</span></span></div>`:'';
}

// -- Render opera√ß√µes (hist√≥rico) --
function rInvestOps(){
    const ops=[...getOps()].sort((a,b)=>b.data.localeCompare(a.data));
    if(!ops.length){$('invOpList').innerHTML='<div style="text-align:center;padding:30px;color:var(--text3)"><div style="font-size:36px;margin-bottom:8px">üìã</div><div style="font-size:13px">Nenhuma opera√ß√£o registrada</div></div>';return}
    const cartMap={};getCarteiras().forEach(c=>cartMap[c.id]=c.nome);
    $('invOpList').innerHTML=ops.map((o,i)=>{
        const isCompra=o.tipo==='compra';
        const total=o.qtd*o.preco;
        const dt=new Date(o.data+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'2-digit'});
        return `<div style="background:var(--surface);border:1px solid var(--border);border-left:3px solid ${isCompra?'var(--green)':'var(--red)'};border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between">
<div><div style="display:flex;align-items:center;gap:6px;margin-bottom:2px"><span style="font-size:11px;padding:1px 6px;border-radius:3px;font-weight:700;background:${isCompra?'var(--green-bg)':'var(--red-bg)'};color:${isCompra?'var(--green)':'var(--red)'}">${isCompra?'COMPRA':'VENDA'}</span><span style="font-family:var(--mono);font-size:13px;font-weight:800">${o.ticker}</span></div>
<div style="font-size:11px;color:var(--text3)">${dt} ¬∑ ${o.qtd} un √ó R$ ${o.preco.toFixed(2)} ¬∑ ${cartMap[o.carteira]||'?'}</div></div>
<div style="display:flex;align-items:center;gap:8px"><span style="font-family:var(--mono);font-size:13px;font-weight:700;color:${isCompra?'var(--green)':'var(--red)'}">R$ ${total.toFixed(2)}</span>
<button onclick="delOp(${i})" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:12px">‚úï</button></div></div>`;
    }).join('');
}

function delOp(sortedIdx){
    const ops=[...getOps()].sort((a,b)=>b.data.localeCompare(a.data));
    const op=ops[sortedIdx];if(!op)return;
    if(!confirm('Excluir opera√ß√£o de '+op.tipo+' de '+op.ticker+'?'))return;
    const realIdx=D.investOps.findIndex(o=>o.id===op.id);
    if(realIdx>=0)D.investOps.splice(realIdx,1);
    save();rInvestOps();rInvestCarteira();toast('Opera√ß√£o exclu√≠da');
}

function fmtCotTime(t){
    if(!t)return'';
    try{
        const d=new Date(t);
        if(isNaN(d.getTime()))return t;
        const hoje=new Date();
        const isHoje=d.toDateString()===hoje.toDateString();
        const hora=d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
        if(isHoje)return'Hoje '+hora;
        return d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'})+' '+hora;
    }catch(e){return t}
}

async function fetchCotacoes(){
    const TOP_TICKERS=['PETR4','VALE3','ITUB4','BBDC4','WEGE3','ABEV3','RENT3','BBAS3','SUZB3','MGLU3','ELET3','B3SA3'];
    
    // AwesomeAPI - moedas + BTC (100% gratuita, sem chave, CORS ok)
    try{
        const resp=await fetch('https://economia.awesomeapi.com.br/json/last/USD-BRL,EUR-BRL,BTC-BRL');
        if(resp.ok){
            const data=await resp.json();
            if(data.USDBRL) cotacoesCache.USD={price:parseFloat(data.USDBRL.bid),var:parseFloat(data.USDBRL.pctChange),time:data.USDBRL.create_date||''};
            if(data.EURBRL) cotacoesCache.EUR={price:parseFloat(data.EURBRL.bid),var:parseFloat(data.EURBRL.pctChange),time:data.EURBRL.create_date||''};
            if(data.BTCBRL) cotacoesCache.BTC={price:parseFloat(data.BTCBRL.bid),var:parseFloat(data.BTCBRL.pctChange),time:data.BTCBRL.create_date||''};
        }
    }catch(e){console.log('AwesomeAPI:',e)}
    
    // brapi.dev - a√ß√µes + Ibovespa (precisa de token gratuito)
    const brapiToken=D.brapiToken||'';
    if(brapiToken){
        // Top a√ß√µes + carteira
        const carteiraT=[...new Set((D.investOps||[]).map(o=>o.ticker))];
        const allTickers=[...new Set([...TOP_TICKERS,...carteiraT])];
        try{
            const resp2=await fetch('https://brapi.dev/api/quote/'+allTickers.join(',')+`?token=${brapiToken}`);
            if(resp2.ok){
                const data2=await resp2.json();
                if(data2.results){
                    data2.results.forEach(r=>{
                        cotacoesCache[r.symbol]={price:r.regularMarketPrice,var:r.regularMarketChangePercent,name:r.shortName||r.longName||'',time:r.regularMarketTime||''};
                    });
                }
            }
        }catch(e){console.log('brapi a√ß√µes:',e)}
        
        // Ibovespa
        try{
            const respIb=await fetch('https://brapi.dev/api/quote/%5EBVSP?token='+brapiToken);
            if(respIb.ok){
                const dataIb=await respIb.json();
                if(dataIb.results&&dataIb.results[0]){
                    const ib=dataIb.results[0];
                    cotacoesCache.IBOV={price:ib.regularMarketPrice,var:ib.regularMarketChangePercent,time:ib.regularMarketTime||''};
                }
            }
        }catch(e){console.log('brapi ibov:',e)}
    }
}

function updateCotacoesUI(){
    const u=cotacoesCache.USD;
    const e=cotacoesCache.EUR;
    const b=cotacoesCache.BTC;
    const i=cotacoesCache.IBOV;
    
    if(u){
        $('cotUSD').textContent='R$ '+Number(u.price).toFixed(2);
        const v=Number(u.var);
        $('cotUSDvar').textContent=(v>=0?'+':'')+v.toFixed(2)+'%';
        $('cotUSDvar').className='inv-cot-var '+(v>=0?'up':'down');
        if(u.time)$('cotUSDtime').textContent=fmtCotTime(u.time);
    }
    if(e){
        $('cotEUR').textContent='R$ '+Number(e.price).toFixed(2);
        const v=Number(e.var);
        $('cotEURvar').textContent=(v>=0?'+':'')+v.toFixed(2)+'%';
        $('cotEURvar').className='inv-cot-var '+(v>=0?'up':'down');
        if(e.time)$('cotEURtime').textContent=fmtCotTime(e.time);
    }
    if(b){
        const bp=Number(b.price);
        $('cotBTC').textContent='R$ '+(bp>=1000?Math.round(bp).toLocaleString('pt-BR'):bp.toFixed(2));
        const v=Number(b.var);
        $('cotBTCvar').textContent=(v>=0?'+':'')+v.toFixed(2)+'%';
        $('cotBTCvar').className='inv-cot-var '+(v>=0?'up':'down');
        if(b.time)$('cotBTCtime').textContent=fmtCotTime(b.time);
    }
    if(i){
        $('cotIBOV').textContent=Math.round(Number(i.price)).toLocaleString('pt-BR')+' pts';
        const v=Number(i.var);
        $('cotIBOVvar').textContent=(v>=0?'+':'')+v.toFixed(2)+'%';
        $('cotIBOVvar').className='inv-cot-var '+(v>=0?'up':'down');
        if(i.time)$('cotIBOVtime').textContent=fmtCotTime(i.time);
    }
    
    // Top A√ß√µes
    const topTickers='PETR4,VALE3,ITUB4,BBDC4,WEGE3,ABEV3,RENT3,BBAS3,SUZB3,MGLU3,ELET3,B3SA3'.split(',');
    let topHtml='';
    let hasStocks=false;
    topTickers.forEach(tk=>{
        const c=cotacoesCache[tk];
        if(!c)return;
        hasStocks=true;
        const v=Number(c.var||0);
        const varColor=v>=0?'var(--green)':'var(--red)';
        const arrow=v>=0?'‚ñ≤':'‚ñº';
        topHtml+=`<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xs);padding:8px 10px;text-align:center">
<div style="font-family:var(--mono);font-size:12px;font-weight:800;margin-bottom:2px">${tk}</div>
<div style="font-family:var(--mono);font-size:13px;font-weight:700">R$ ${Number(c.price).toFixed(2)}</div>
<div style="font-size:10px;font-weight:600;color:${varColor}">${arrow} ${Math.abs(v).toFixed(2)}%</div>
</div>`;
    });
    if(hasStocks){
        $('topAcoesList').innerHTML=topHtml;
        $('cotLastUpdate').textContent='Atualizado: '+new Date().toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'})+' '+new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    } else {
        const brapiToken=D.brapiToken||'';
        $('topAcoesList').innerHTML=brapiToken?
            '<div style="grid-column:1/-1;text-align:center;padding:12px;color:var(--text3);font-size:12px">‚è≥ Carregando a√ß√µes...</div>':
            '<div style="grid-column:1/-1;text-align:center;padding:12px;color:var(--text3);font-size:12px">üîë Configure seu token da <b>brapi.dev</b> em Config ‚Üí API de Cota√ß√µes para ver a√ß√µes e Ibovespa ao vivo</div>';
    }
}

async function refreshCotacoes(){
    toast('üîÑ Atualizando cota√ß√µes...');
    await fetchCotacoes();
    updateCotacoesUI();
    rInvestCarteira();
    toast('‚úÖ Cota√ß√µes atualizadas!');
}

let invAutoRefresh=null;
function rInvest(){
    fetchCotacoes().then(()=>{
        updateCotacoesUI();
        rInvestCarteira();
        rInvestDividendos();
    });
    // Auto-refresh every 5 min while on investimentos
    if(invAutoRefresh)clearInterval(invAutoRefresh);
    invAutoRefresh=setInterval(()=>{
        if(curPage==='investimentos'){
            fetchCotacoes().then(()=>{updateCotacoesUI();rInvestCarteira()});
        } else {clearInterval(invAutoRefresh);invAutoRefresh=null}
    },300000);
}

function rInvestDividendos(){
    const divs=D.investDivs||[];
    if(!divs.length){
        $('invDivResumo').innerHTML='';
        $('invDivList').innerHTML='<div style="text-align:center;padding:30px;color:var(--text3)"><div style="font-size:36px;margin-bottom:8px">üí∞</div><div style="font-size:13px">Nenhum dividendo registrado</div></div>';
        return;
    }
    const divsMonth=divs.filter(d=>{const dt=new Date(d.data+'T12:00:00');return dt.getMonth()===cMonth&&dt.getFullYear()===cYear});
    const totalMonth=divsMonth.reduce((s,d)=>s+d.valor,0);
    const totalAll=divs.reduce((s,d)=>s+d.valor,0);
    $('invDivResumo').innerHTML=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px"><div style="background:var(--green-bg);border:1px solid rgba(16,185,129,0.2);border-radius:var(--radius-sm);padding:12px;text-align:center"><div style="font-size:11px;color:var(--green)">Este m√™s</div><div style="font-family:var(--mono);font-size:16px;font-weight:700;color:var(--green)">${fmt(totalMonth)}</div></div><div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center"><div style="font-size:11px;color:var(--text3)">Total acumulado</div><div style="font-family:var(--mono);font-size:16px;font-weight:700">${fmt(totalAll)}</div></div></div>`;
    const sorted=[...divs].sort((a,b)=>b.data.localeCompare(a.data));
    const tipoLabels={dividendo:'Dividendo',jcp:'JCP',rendimento:'Rend. FII',bonificacao:'Bonifica√ß√£o'};
    $('invDivList').innerHTML=sorted.map((d,i)=>{
        const dt=new Date(d.data+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'2-digit'});
        return `<div class="inv-div-item"><div><div style="font-size:13px;font-weight:700;font-family:var(--mono)">${d.ticker}</div><div style="font-size:11px;color:var(--text3)">${dt} ¬∑ ${tipoLabels[d.tipo]||d.tipo}</div></div><div style="display:flex;align-items:center;gap:8px"><span style="font-family:var(--mono);font-size:14px;font-weight:700;color:var(--green)">+${fmt(d.valor)}</span><button onclick="delDividendo(${i})" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:12px">‚úï</button></div></div>`;
    }).join('');
}

function openDivAdd(){
    // Get all unique tickers across all carteiras
    const ops=getOps();
    const allTickers=[...new Set(ops.map(o=>o.ticker))];
    const sel=$('divTicker');
    sel.innerHTML=allTickers.length?allTickers.map(t=>`<option value="${t}">${t}</option>`).join(''):'<option value="">Nenhum ativo</option>';
    $('divValor').value='';
    $('divData').value=new Date().toISOString().split('T')[0];
    $('divTipoRend').value='dividendo';
    $('divAddModal').style.display='flex';
}
function closeDivAdd(){$('divAddModal').style.display='none'}

function saveDividendo(){
    const ticker=$('divTicker').value;
    const valor=parseFloat($('divValor').value);
    const data=$('divData').value;
    const tipo=$('divTipoRend').value;
    if(!ticker){toast('Selecione o ativo',true);return}
    if(!valor||valor<=0){toast('Informe o valor',true);return}
    if(!data){toast('Informe a data',true);return}
    if(!D.investDivs)D.investDivs=[];
    D.investDivs.push({ticker,valor,data,tipo,id:'div_'+Date.now()});
    save();closeDivAdd();rInvestDividendos();
    toast('‚úÖ Dividendo registrado!');
}

function delDividendo(idx){
    const sorted=[...D.investDivs].sort((a,b)=>b.data.localeCompare(a.data));
    const d=sorted[idx];if(!d)return;
    if(!confirm('Remover este dividendo?'))return;
    const realIdx=D.investDivs.findIndex(x=>x.id===d.id);
    if(realIdx>=0)D.investDivs.splice(realIdx,1);
    save();rInvestDividendos();toast('Dividendo removido');
}

function saveSug(){
    const texto=$('sugTexto').value.trim();
    if(!texto){toast('Escreva sua sugest√£o',true);return}
    const tipo=$('sugTipo').value;
    const user=D.userName||'An√¥nimo';
    const dt=new Date().toISOString();
    
    // Save locally
    if(!D.sugs) D.sugs=[];
    D.sugs.push({tipo,texto,dt,user});
    save();$('sugTexto').value='';rSug();
    toast('üì© Enviando sugest√£o...');
    
    // Send email via FormSubmit
    fetch('https://formsubmit.co/ajax/gilenopaivalima@gmail.com',{
        method:'POST',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body:JSON.stringify({
            _subject:'üí¨ Nova Sugest√£o - Gestor Financeiro',
            Tipo:tipo,
            Sugest√£o:texto,
            Usu√°rio:user,
            Email:currentUser||'N√£o logado',
            Data:new Date().toLocaleString('pt-BR')
        })
    }).then(r=>r.json()).then(data=>{
        if(data.success) toast('‚úÖ Sugest√£o enviada com sucesso!');
        else toast('‚ö†Ô∏è Salva localmente, email pendente',true);
    }).catch(()=>{
        toast('‚ö†Ô∏è Salva localmente, email pendente',true);
    });
}

function delSug(idx){
    if(!confirm('Excluir esta sugest√£o?'))return;
    D.sugs.splice(idx,1);save();rSug();
}

function exportSug(){
    const sugs=D.sugs||[];
    if(!sugs.length){toast('Nenhuma sugest√£o para exportar',true);return}
    let txt='SUGEST√ïES - '+(D.userName||'Usu√°rio')+'\nExportado em: '+new Date().toLocaleDateString('pt-BR')+'\n\n';
    sugs.forEach((s,i)=>{
        txt+='#'+(i+1)+' ['+s.tipo+'] - '+new Date(s.dt).toLocaleDateString('pt-BR')+'\n';
        txt+=s.texto+'\n\n';
    });
    const blob=new Blob([txt],{type:'text/plain;charset=utf-8'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='sugestoes_'+(D.userName||'usuario')+'_'+new Date().toISOString().split('T')[0]+'.txt';a.click();
    toast('üìã Sugest√µes exportadas!');
}

// -- Init --
checkAutoLogin();
// Enter key on login
document.getElementById('loginPass').addEventListener('keydown',function(e){if(e.key==='Enter')doLogin()});
document.getElementById('loginEmail').addEventListener('keydown',function(e){if(e.key==='Enter')document.getElementById('loginPass').focus()});

// ============== AGENDA ==============

function setAgType(t,el){
    agType=t;
    document.querySelectorAll('#agTypeTabs .toggle-tab').forEach(b=>b.classList.remove('active'));
    if(el)el.classList.add('active');
    $('agPayFields').style.display=(t==='lembrete')?'none':'block';
    // Update categories based on type
    const cats=$('agCat');
    if(cats){
        const prev=cats.value;
        cats.innerHTML='<option value="">Sem categoria</option>';
        const list=t==='recebimento'?(D.catsR||[]):(D.catsD||[]);
        list.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;cats.appendChild(o)});
        if(prev)cats.value=prev;
        onAgCatChange();
    }
}
function setAgDestino(d,el){
    agDestino=d;
    document.querySelectorAll('#agDestinoTabs .toggle-tab').forEach(b=>b.classList.remove('active'));
    if(el)el.classList.add('active');
    $('agContaField').style.display=(d==='conta')?'block':'none';
    $('agCartaoField').style.display=(d==='cartao')?'block':'none';
}
function setAgColor(color,el){
    agColor=color;
    document.querySelectorAll('.ag-color-dot').forEach(d=>{d.style.border='2px solid transparent';d.classList.remove('active')});
    el.style.border='2px solid #fff';el.classList.add('active');
}

function onAgCatChange(){
    const cat=$('agCat').value;
    const subs=(D.subCats&&D.subCats[cat])||[];
    const row=$('agSubCatRow');
    const sel=$('agSubCat');
    if(subs.length||cat){
        row.style.display='block';
        sel.innerHTML='<option value="">Sem subcategoria</option>';
        subs.forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;sel.appendChild(o)});
    } else {
        row.style.display='none';
        sel.innerHTML='';
    }
}

function addAgCat(){
    const nome=prompt('Nome da nova categoria:');
    if(!nome||!nome.trim())return;
    const n=nome.trim();
    const list=agType==='recebimento'?'catsR':'catsD';
    if(!D[list])D[list]=[];
    if(D[list].includes(n)){toast('Categoria j√° existe');return}
    D[list].push(n);
    save();
    // Refresh categories and select the new one
    setAgType(agType,document.querySelector('#agTypeTabs .toggle-tab.active'));
    $('agCat').value=n;
    onAgCatChange();
    toast('‚úÖ Categoria "'+n+'" criada!');
}

function addAgSubCat(){
    const cat=$('agCat').value;
    if(!cat){toast('Selecione uma categoria primeiro');return}
    const nome=prompt('Nova subcategoria para "'+cat+'":');
    if(!nome||!nome.trim())return;
    const n=nome.trim();
    if(!D.subCats)D.subCats={};
    if(!D.subCats[cat])D.subCats[cat]=[];
    if(D.subCats[cat].includes(n)){toast('Subcategoria j√° existe');return}
    D.subCats[cat].push(n);
    save();
    onAgCatChange();
    $('agSubCat').value=n;
    toast('‚úÖ Subcategoria "'+n+'" criada!');
}

function openAgendaAdd(dateStr){
    try{
    agEditId=null;
    $('agTitle').value='';
    $('agDate').value=dateStr||new Date().toISOString().split('T')[0];
    $('agTime').value='';
    $('agValor').value='';
    $('agNotes').value='';
    $('agRepeat').value='none';
    // Populate selects
    const bs=$('agBanco');if(bs){bs.innerHTML='';getBancos().forEach(b=>{const o=document.createElement('option');o.value=b;o.textContent=b;bs.appendChild(o)})}
    const cs=$('agCartao');if(cs){cs.innerHTML='';getCartoes().forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;cs.appendChild(o)})}
    const cats=$('agCat');if(cats){cats.innerHTML='<option value="">Sem categoria</option>';(D.catsD||[]).concat(D.catsR||[]).forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;cats.appendChild(o)})}
    $('agSubCatRow').style.display='none';
    $('agSubCat').innerHTML='';
    const typeBtn=document.querySelector('#agTypeTabs .toggle-tab:first-child');
    if(typeBtn)setAgType('pagamento',typeBtn);
    const destBtn=document.querySelector('#agDestinoTabs .toggle-tab:first-child');
    if(destBtn)setAgDestino('conta',destBtn);
    const colorBtn=document.querySelector('.ag-color-dot');
    if(colorBtn)setAgColor('#cc2222',colorBtn);
    $('agendaModal').classList.add('show');
    }catch(err){console.error('Agenda error:',err);alert('Erro: '+err.message)}
}

function openAgendaEdit(id){
    const ev=(D.ag||[]).find(e=>e.id===id);
    if(!ev)return;
    agEditId=id;
    openAgendaAdd(ev.date);
    $('agTitle').value=ev.title||'';
    $('agDate').value=ev.date||'';
    $('agTime').value=ev.time||'';
    $('agValor').value=ev.valor||'';
    $('agNotes').value=ev.notes||'';
    $('agRepeat').value=ev.repeat||'none';
    if(ev.type){
        const idx={pagamento:0,lembrete:1,recebimento:2}[ev.type]||0;
        setAgType(ev.type,document.querySelectorAll('#agTypeTabs .toggle-tab')[idx]);
    }
    if(ev.destino){
        const idx={conta:0,cartao:1,nenhum:2}[ev.destino]||0;
        setAgDestino(ev.destino,document.querySelectorAll('#agDestinoTabs .toggle-tab')[idx]);
    }
    if(ev.banco)$('agBanco').value=ev.banco;
    if(ev.cartao)$('agCartao').value=ev.cartao;
    if(ev.cat){$('agCat').value=ev.cat;onAgCatChange();if(ev.sub)$('agSubCat').value=ev.sub}
    if(ev.color){
        const dots=document.querySelectorAll('.ag-color-dot');
        dots.forEach(d=>{if(d.style.background===ev.color||d.style.backgroundColor===ev.color)setAgColor(ev.color,d)});
    }
    $('agendaModal').classList.add('show');
}

function closeAgendaModal(){$('agendaModal').classList.remove('show')}

function saveAgenda(){
    const title=$('agTitle').value.trim();
    if(!title){toast('Preencha o t√≠tulo');return}
    const date=$('agDate').value;
    if(!date){toast('Preencha a data');return}
    if(!D.ag)D.ag=[];
    const ev={
        id:agEditId||'ag_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),
        title,date,
        time:$('agTime').value||'',
        type:agType,
        valor:agType!=='lembrete'?parseFloat($('agValor').value)||0:0,
        destino:agType!=='lembrete'?agDestino:'nenhum',
        banco:agDestino==='conta'?$('agBanco').value:'',
        cartao:agDestino==='cartao'?$('agCartao').value:'',
        cat:$('agCat').value||'',
        sub:$('agSubCat').value||'',
        repeat:$('agRepeat').value||'none',
        notes:$('agNotes').value.trim(),
        color:agColor,
        done:false,
        txId:null
    };
    if(agEditId){
        const idx=D.ag.findIndex(e=>e.id===agEditId);
        if(idx>=0){ev.done=D.ag[idx].done;ev.txId=D.ag[idx].txId;D.ag[idx]=ev}
    } else {
        D.ag.push(ev);
        // Auto-create pending transaction for payments/receipts
        if(ev.type!=='lembrete' && ev.valor>0 && ev.destino!=='nenhum'){
            const txId=launchAgendaTxPending(ev);
            ev.txId=txId;
        }
    }
    save();closeAgendaModal();refresh();
    if(agEditId){
        toast('Compromisso atualizado!');
    } else {
        toast('Compromisso agendado!');
        // Offer to add to device calendar
        setTimeout(()=>{
            if(confirm('üìÖ Deseja adicionar "'+ev.title+'" ao Calend√°rio do seu dispositivo?')){
                exportICS(ev.id);
            }
        },500);
    }
}

function toggleAgDone(id){
    const ev=(D.ag||[]).find(e=>e.id===id);
    if(!ev)return;
    ev.done=!ev.done;
    // When marking done, efetivate the linked transaction
    if(ev.done && ev.txId){
        const tx=D.tx.find(t=>t.id===ev.txId);
        if(tx){tx.st='efetivado';toast('‚úÖ Lan√ßamento efetivado!')}
        const cp=D.cp.find(c=>c.id===ev.txId);
        if(cp){cp.st='paga';toast('‚úÖ Compra marcada como paga!')}
    }
    // When unmarking, set back to pending
    if(!ev.done && ev.txId){
        const tx=D.tx.find(t=>t.id===ev.txId);
        if(tx)tx.st='agendado';
        const cp=D.cp.find(c=>c.id===ev.txId);
        if(cp)cp.st='aberta';
    }
    save();refresh();
}

function launchAgendaTxPending(ev){
    const tp=ev.type==='recebimento'?'Receita':'Despesa';
    const txId='tx_'+Date.now()+'_'+Math.random().toString(36).slice(2,6);
    if(ev.destino==='conta'){
        const tx={id:txId,dt:ev.date,desc:ev.title,v:ev.valor,tp,banco:ev.banco,cat:ev.cat,sub:ev.sub||'',st:'agendado',m:parseInt(ev.date.split('-')[1])-1,y:parseInt(ev.date.split('-')[0])};
        D.tx.push(tx);
    } else if(ev.destino==='cartao'){
        const m=parseInt(ev.date.split('-')[1])-1;
        const y=parseInt(ev.date.split('-')[0]);
        const cp={id:txId,dt:ev.date,desc:ev.title,v:ev.valor,card:ev.cartao,cat:ev.cat,sub:ev.sub||'',tipo:'√Ä Vista',m,y,st:'aberta'};
        D.cp.push(cp);
    }
    return txId;
}

function delAgenda(id){
    if(!confirm('Excluir este compromisso?'))return;
    const ev=(D.ag||[]).find(e=>e.id===id);
    if(ev&&ev.txId){
        D.tx=D.tx.filter(t=>t.id!==ev.txId);
        D.cp=D.cp.filter(c=>c.id!==ev.txId);
    }
    D.ag=(D.ag||[]).filter(e=>e.id!==id);
    save();refresh();
    toast('Compromisso e lan√ßamento removidos');
}

function rAgenda(){
    if(!D.ag)D.ag=[];
    const today=new Date();today.setHours(0,0,0,0);
    const todayStr=today.toISOString().split('T')[0];
    
    // === CALENDAR GRID ===
    const firstDay=new Date(cYear,cMonth,1).getDay();
    const daysInMonth=new Date(cYear,cMonth+1,0).getDate();
    const dayNames=['Dom','Seg','Ter','Qua','Qui','Sex','S√°b'];
    
    let cal='<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center">';
    dayNames.forEach(d=>cal+=`<div style="font-size:10px;color:var(--text3);padding:4px 0;font-weight:600">${d}</div>`);
    for(let i=0;i<firstDay;i++)cal+='<div></div>';
    for(let d=1;d<=daysInMonth;d++){
        const dateStr=`${cYear}-${String(cMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const evts=D.ag.filter(e=>e.date===dateStr);
        const isToday=dateStr===todayStr;
        const isSelected=dateStr===agSelectedDay;
        const hasPending=evts.some(e=>!e.done);
        const hasDone=evts.some(e=>e.done);
        let dotHtml='';
        if(evts.length){
            const colors=[...new Set(evts.map(e=>e.color))].slice(0,3);
            dotHtml='<div style="display:flex;gap:2px;justify-content:center;margin-top:1px">'+colors.map(c=>`<div style="width:4px;height:4px;border-radius:50%;background:${c}"></div>`).join('')+'</div>';
        }
        const bg=isSelected?'var(--primary)':isToday?'var(--surface3)':'transparent';
        const border=isToday&&!isSelected?'1px solid var(--primary)':'1px solid transparent';
        const textColor=isSelected?'#fff':'var(--text)';
        cal+=`<div onclick="selectAgDay('${dateStr}')" style="padding:6px 2px;border-radius:var(--radius-xs);cursor:pointer;background:${bg};border:${border};color:${textColor};font-size:13px;font-weight:${isToday?'700':'400'}">${d}${dotHtml}</div>`;
    }
    cal+='</div>';
    $('agendaCal').innerHTML=cal;
    
    // === SELECTED DAY EVENTS ===
    if(agSelectedDay){
        const dayEvts=D.ag.filter(e=>e.date===agSelectedDay).sort((a,b)=>(a.time||'99:99').localeCompare(b.time||'99:99'));
        const dayDate=new Date(agSelectedDay+'T12:00:00');
        $('agendaDayTitle').style.display='block';
        $('agendaDayTitle').innerHTML=`üìÖ ${dayDate.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'})} <button onclick="openAgendaAdd('${agSelectedDay}')" style="background:none;border:none;color:var(--primary);font-size:12px;cursor:pointer;margin-left:8px">+ Adicionar</button>`;
        if(dayEvts.length){
            $('agendaDayEvents').innerHTML=dayEvts.map(e=>renderAgEvent(e)).join('');
        } else {
            $('agendaDayEvents').innerHTML='<div style="text-align:center;padding:12px;color:var(--text3);font-size:13px">Nenhum compromisso neste dia</div>';
        }
    } else {
        $('agendaDayTitle').style.display='none';
        $('agendaDayEvents').innerHTML='';
    }
    
    // === UPCOMING (next 30 days, not done) ===
    const upcoming=D.ag.filter(e=>!e.done&&e.date>=todayStr).sort((a,b)=>a.date.localeCompare(b.date)||(a.time||'').localeCompare(b.time||'')).slice(0,15);
    if(upcoming.length){
        $('agendaEmpty').style.display='none';
        $('agendaUpcoming').innerHTML=upcoming.map(e=>renderAgEvent(e)).join('');
    } else {
        $('agendaEmpty').style.display='block';
        $('agendaUpcoming').innerHTML='';
    }
    
    // === OVERDUE (past, not done) ===
    const overdue=D.ag.filter(e=>!e.done&&e.date<todayStr).sort((a,b)=>b.date.localeCompare(a.date));
    if(overdue.length){
        $('agendaOverdueCard').style.display='block';
        $('agendaOverdue').innerHTML=overdue.map(e=>renderAgEvent(e,true)).join('');
    } else {
        $('agendaOverdueCard').style.display='none';
    }
}

function renderAgEvent(e,isOverdue){
    const dt=new Date(e.date+'T12:00:00');
    const dayStr=dt.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'});
    const timeStr=e.time?(' ¬∑ '+e.time):'';
    const typeIcon={pagamento:'üí∞',lembrete:'üîî',recebimento:'üíµ'}[e.type]||'üìÖ';
    const valorStr=e.valor?(' ¬∑ '+fmt(e.valor)):'';
    const destStr=e.destino==='conta'?(' ¬∑ üè¶ '+e.banco):e.destino==='cartao'?(' ¬∑ üí≥ '+e.cartao):'';
    const opacity=e.done?'0.4':'1';
    const textDeco=e.done?'line-through':'none';
    const overdueStyle=isOverdue?'border-left:3px solid var(--red);':'border-left:3px solid '+e.color+';';
    return `<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:6px;opacity:${opacity};${overdueStyle}">
        <div onclick="toggleAgDone('${e.id}')" style="width:22px;height:22px;border-radius:50%;border:2px solid ${e.done?'var(--green)':e.color};display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;background:${e.done?'var(--green)':'transparent'};font-size:12px;color:#fff">${e.done?'‚úì':''}</div>
        <div style="flex:1;cursor:pointer" onclick="openAgendaEdit('${e.id}')">
            <div style="font-size:13px;font-weight:600;text-decoration:${textDeco}">${typeIcon} ${e.title}</div>
            <div style="font-size:11px;color:var(--text3)">${dayStr}${timeStr}${valorStr}${destStr}${e.cat?' ¬∑ '+e.cat+(e.sub?' ‚Ä∫ '+e.sub:''):''}</div>
            ${e.notes?'<div style="font-size:11px;color:var(--text3);margin-top:2px;font-style:italic">'+e.notes+'</div>':''}
            ${isOverdue?'<div style="font-size:10px;color:var(--red);margin-top:2px">‚ö†Ô∏è Vencido</div>':''}
        </div>
        <button onclick="exportICS('${e.id}')" title="Adicionar ao Calend√°rio" style="background:none;border:none;color:var(--blue);font-size:16px;cursor:pointer;padding:4px">üìÖ</button>
        <button onclick="delAgenda('${e.id}')" style="background:none;border:none;color:var(--text3);font-size:16px;cursor:pointer;padding:4px">&times;</button>
    </div>`;
}

function exportICS(id){
    const ev=(D.ag||[]).find(e=>e.id===id);
    if(!ev){toast('Evento n√£o encontrado',true);return}
    const dtStart=ev.date.replace(/-/g,'');
    let startStr,endStr,allDay=false;
    if(ev.time){
        const t=ev.time.replace(':','');
        startStr=dtStart+'T'+t+'00';
        // End = start + 1 hour
        const h=parseInt(ev.time.split(':')[0]);
        const m=ev.time.split(':')[1];
        const eh=String(h+1).padStart(2,'0');
        endStr=dtStart+'T'+eh+m+'00';
    } else {
        allDay=true;
        startStr=dtStart;
        // All day end = next day
        const nd=new Date(ev.date+'T12:00:00');
        nd.setDate(nd.getDate()+1);
        endStr=nd.toISOString().split('T')[0].replace(/-/g,'');
    }
    const typeLabel={pagamento:'Pagamento',lembrete:'Lembrete',recebimento:'Recebimento'}[ev.type]||'Compromisso';
    let desc=typeLabel;
    if(ev.valor)desc+=' - '+fmt(ev.valor);
    if(ev.cat)desc+=' - '+ev.cat;
    if(ev.notes)desc+='\\n'+ev.notes;
    const uid=ev.id+'@gileno-gestao';
    let ics='BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//Gileno Gestao Financeira//PT\r\nCALSCALE:GREGORIAN\r\nMETHOD:PUBLISH\r\nBEGIN:VEVENT\r\n';
    ics+='UID:'+uid+'\r\n';
    ics+='SUMMARY:'+ev.title+'\r\n';
    ics+='DESCRIPTION:'+desc+'\r\n';
    if(allDay){
        ics+='DTSTART;VALUE=DATE:'+startStr+'\r\n';
        ics+='DTEND;VALUE=DATE:'+endStr+'\r\n';
    } else {
        ics+='DTSTART:'+startStr+'\r\n';
        ics+='DTEND:'+endStr+'\r\n';
    }
    // Alarm 30 min before (or at the time for all-day)
    ics+='BEGIN:VALARM\r\nTRIGGER:'+(allDay?'-PT8H':'-PT30M')+'\r\nACTION:DISPLAY\r\nDESCRIPTION:'+ev.title+'\r\nEND:VALARM\r\n';
    ics+='END:VEVENT\r\nEND:VCALENDAR\r\n';
    const blob=new Blob([ics],{type:'text/calendar;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=ev.title.replace(/[^a-zA-Z0-9√°√†√¢√£√©√®√™√≠√Ø√≥√¥√µ√∂√∫√º√ß√Å√Ä√Ç√É√â√à√ä√ç√è√ì√î√ï√ñ√ö√ú√á ]/g,'').trim().replace(/\s+/g,'_')+'.ics';
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toast('üìÖ Arquivo .ics gerado! Abra para adicionar ao Calend√°rio');
}

function selectAgDay(dateStr){
    agSelectedDay=(agSelectedDay===dateStr)?null:dateStr;
    rAgenda();
}

</script>

<!-- LGPD MODAL -->
<div id="lgpdModal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,0.85);overflow-y:auto;padding:20px">
<div style="max-width:600px;margin:20px auto;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<h2 style="font-size:18px;font-weight:700;color:var(--text)">üîí Pol√≠tica de Privacidade e Seguran√ßa</h2>
<button onclick="closeLgpd()" style="background:none;border:none;color:var(--text3);font-size:24px;cursor:pointer">&times;</button>
</div>
<div style="font-size:13px;color:var(--text2);line-height:1.8">

<p style="margin-bottom:12px"><strong style="color:var(--text)">Gileno - Gest√£o Financeira</strong> respeita a sua privacidade e est√° comprometido com a prote√ß√£o dos seus dados pessoais, em conformidade com a <strong style="color:var(--text)">Lei Geral de Prote√ß√£o de Dados (LGPD - Lei n¬∫ 13.709/2018)</strong>.</p>

<h3 style="color:var(--text);font-size:14px;margin:16px 0 8px">1. Dados Coletados</h3>
<p style="margin-bottom:8px">Coletamos apenas os dados estritamente necess√°rios para o funcionamento do aplicativo:</p>
<p style="margin-bottom:4px">‚Ä¢ <strong style="color:var(--text)">Dados de autentica√ß√£o:</strong> e-mail e m√©todo de login (Google ou e-mail/senha)</p>
<p style="margin-bottom:4px">‚Ä¢ <strong style="color:var(--text)">Dados financeiros:</strong> informa√ß√µes inseridas voluntariamente por voc√™ (transa√ß√µes, contas, cart√µes, categorias)</p>
<p style="margin-bottom:12px">‚Ä¢ <strong style="color:var(--text)">Identificador √∫nico:</strong> gerado automaticamente pelo sistema de autentica√ß√£o</p>

<h3 style="color:var(--text);font-size:14px;margin:16px 0 8px">2. Finalidade do Tratamento</h3>
<p style="margin-bottom:12px">Seus dados s√£o utilizados exclusivamente para possibilitar a gest√£o financeira pessoal dentro do aplicativo. N√£o utilizamos seus dados para nenhuma outra finalidade, como marketing, an√°lises comportamentais ou perfilamento.</p>

<h3 style="color:var(--text);font-size:14px;margin:16px 0 8px">3. Armazenamento e Seguran√ßa</h3>
<p style="margin-bottom:4px">‚Ä¢ Os dados s√£o armazenados no <strong style="color:var(--text)">Firebase (Google Cloud Platform)</strong>, que utiliza criptografia em tr√¢nsito (TLS/SSL) e em repouso.</p>
<p style="margin-bottom:4px">‚Ä¢ Cada usu√°rio possui um espa√ßo isolado de dados ‚Äî <strong style="color:var(--text)">nenhum outro usu√°rio pode acessar suas informa√ß√µes</strong>.</p>
<p style="margin-bottom:4px">‚Ä¢ A autentica√ß√£o √© gerenciada pelo <strong style="color:var(--text)">Firebase Authentication</strong>, um servi√ßo de seguran√ßa mantido pelo Google.</p>
<p style="margin-bottom:12px">‚Ä¢ Senhas s√£o armazenadas de forma criptografada e nunca ficam vis√≠veis, nem mesmo para o administrador do sistema.</p>

<h3 style="color:var(--text);font-size:14px;margin:16px 0 8px">4. Compartilhamento de Dados</h3>
<p style="margin-bottom:12px"><strong style="color:var(--green)">N√£o compartilhamos, vendemos ou transferimos seus dados pessoais a terceiros</strong>, sob nenhuma circunst√¢ncia. O √∫nico acesso externo √© ao servi√ßo de infraestrutura (Firebase/Google Cloud), que atua como operador dos dados nos termos da LGPD.</p>

<h3 style="color:var(--text);font-size:14px;margin:16px 0 8px">5. Seus Direitos (Art. 18 da LGPD)</h3>
<p style="margin-bottom:8px">Voc√™ tem direito a:</p>
<p style="margin-bottom:4px">‚Ä¢ <strong style="color:var(--text)">Acesso:</strong> visualizar todos os seus dados a qualquer momento pelo aplicativo</p>
<p style="margin-bottom:4px">‚Ä¢ <strong style="color:var(--text)">Corre√ß√£o:</strong> editar ou corrigir qualquer informa√ß√£o diretamente no app</p>
<p style="margin-bottom:4px">‚Ä¢ <strong style="color:var(--text)">Exclus√£o:</strong> solicitar a exclus√£o completa dos seus dados e conta</p>
<p style="margin-bottom:4px">‚Ä¢ <strong style="color:var(--text)">Portabilidade:</strong> exportar seus dados a qualquer momento via backup (JSON/CSV)</p>
<p style="margin-bottom:12px">‚Ä¢ <strong style="color:var(--text)">Revoga√ß√£o do consentimento:</strong> deixar de usar o aplicativo a qualquer momento</p>

<h3 style="color:var(--text);font-size:14px;margin:16px 0 8px">6. Reten√ß√£o de Dados</h3>
<p style="margin-bottom:12px">Seus dados permanecem armazenados enquanto sua conta estiver ativa. Caso solicite a exclus√£o, todos os dados ser√£o removidos de forma definitiva e irrevers√≠vel no prazo de at√© 30 dias.</p>

<h3 style="color:var(--text);font-size:14px;margin:16px 0 8px">7. Respons√°vel pelo Tratamento</h3>
<p style="margin-bottom:4px"><strong style="color:var(--text)">Controlador:</strong> Gileno Paiva Lima</p>
<p style="margin-bottom:12px"><strong style="color:var(--text)">Contato:</strong> gilenopaivalima@gmail.com</p>

<h3 style="color:var(--text);font-size:14px;margin:16px 0 8px">8. Altera√ß√µes nesta Pol√≠tica</h3>
<p style="margin-bottom:12px">Esta pol√≠tica pode ser atualizada periodicamente. Eventuais altera√ß√µes ser√£o comunicadas atrav√©s do pr√≥prio aplicativo.</p>

<p style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);font-size:11px;color:var(--text3)">√öltima atualiza√ß√£o: Fevereiro de 2026</p>
</div>
<button onclick="closeLgpd()" class="btn btn-primary" style="margin-top:16px;width:100%">Entendi</button>
</div>
</div>

<!-- AGENDA ADD MODAL -->
<div class="modal-overlay" id="agendaModal" onclick="if(event.target===this)closeAgendaModal()">
<div class="modal" style="max-height:90vh;overflow-y:auto">
<div class="modal-handle"></div>
<div class="modal-title">üìÖ Novo Compromisso</div>

<div class="form-group"><label class="form-label">T√≠tulo</label><input type="text" class="form-input" id="agTitle" placeholder="Ex: Pagar conta de luz, Reuni√£o..."></div>

<div class="form-row">
<div class="form-group"><label class="form-label">Data</label><input type="date" class="form-input" id="agDate"></div>
<div class="form-group"><label class="form-label">Hora (opcional)</label><input type="time" class="form-input" id="agTime"></div>
</div>

<div class="form-group"><label class="form-label">Tipo</label>
<div class="toggle-tabs" id="agTypeTabs">
<button class="toggle-tab t-red active" onclick="setAgType('pagamento',this)">üí∞ Pagamento</button>
<button class="toggle-tab t-blue" onclick="setAgType('lembrete',this)">üîî Lembrete</button>
<button class="toggle-tab t-green" onclick="setAgType('recebimento',this)">üíµ Recebimento</button>
</div></div>

<!-- Payment fields -->
<div id="agPayFields">
<div class="form-group"><label class="form-label">Valor</label><div class="valor-input-wrap"><span class="valor-prefix">R$</span><input type="number" step="0.01" min="0" class="form-input" id="agValor" placeholder="0,00" inputmode="decimal"></div></div>

<div class="form-group"><label class="form-label">Onde lan√ßar?</label>
<div class="toggle-tabs" id="agDestinoTabs">
<button class="toggle-tab t-blue active" onclick="setAgDestino('conta',this)">üè¶ Conta</button>
<button class="toggle-tab t-blue" onclick="setAgDestino('cartao',this)">üí≥ Cart√£o</button>
<button class="toggle-tab t-blue" onclick="setAgDestino('nenhum',this)">üìù S√≥ lembrete</button>
</div></div>

<div id="agContaField"><div class="form-group"><label class="form-label">Banco/Conta</label><select class="form-input" id="agBanco"></select></div></div>
<div id="agCartaoField" style="display:none"><div class="form-group"><label class="form-label">Cart√£o</label><select class="form-input" id="agCartao"></select></div></div>

<div class="form-group"><label class="form-label">Categoria</label><div style="display:flex;gap:6px"><select class="form-input" id="agCat" onchange="onAgCatChange()" style="flex:1"></select><button class="btn btn-outline btn-sm" onclick="addAgCat()" style="white-space:nowrap;padding:6px 10px">+ Nova</button></div></div>
<div class="form-group" id="agSubCatRow" style="display:none"><label class="form-label">Subcategoria</label><div style="display:flex;gap:6px"><select class="form-input" id="agSubCat" style="flex:1"></select><button class="btn btn-outline btn-sm" onclick="addAgSubCat()" style="white-space:nowrap;padding:6px 10px">+ Nova</button></div></div>
</div>

<!-- Recurrence -->
<div class="form-group"><label class="form-label">Repetir</label>
<select class="form-input" id="agRepeat">
<option value="none">N√£o repetir</option>
<option value="weekly">Semanal</option>
<option value="biweekly">Quinzenal</option>
<option value="monthly">Mensal</option>
<option value="yearly">Anual</option>
</select></div>

<div class="form-group"><label class="form-label">Notas (opcional)</label>
<textarea class="form-input" id="agNotes" rows="2" placeholder="Observa√ß√µes..." style="resize:vertical;font-family:var(--font)"></textarea></div>

<div class="form-group">
<label class="form-label">Cor</label>
<div style="display:flex;gap:8px" id="agColorPicker">
<div onclick="setAgColor('#cc2222',this)" class="ag-color-dot active" style="width:28px;height:28px;border-radius:50%;background:#cc2222;cursor:pointer;border:2px solid transparent"></div>
<div onclick="setAgColor('#f59e0b',this)" class="ag-color-dot" style="width:28px;height:28px;border-radius:50%;background:#f59e0b;cursor:pointer;border:2px solid transparent"></div>
<div onclick="setAgColor('#10b981',this)" class="ag-color-dot" style="width:28px;height:28px;border-radius:50%;background:#10b981;cursor:pointer;border:2px solid transparent"></div>
<div onclick="setAgColor('#3b82f6',this)" class="ag-color-dot" style="width:28px;height:28px;border-radius:50%;background:#3b82f6;cursor:pointer;border:2px solid transparent"></div>
<div onclick="setAgColor('#8b5cf6',this)" class="ag-color-dot" style="width:28px;height:28px;border-radius:50%;background:#8b5cf6;cursor:pointer;border:2px solid transparent"></div>
</div></div>

<div style="display:flex;gap:8px;margin-top:12px">
<button class="btn btn-green" onclick="saveAgenda()" style="flex:1">‚úì Salvar</button>
<button class="btn btn-outline" onclick="closeAgendaModal()">Cancelar</button>
</div>
</div>
</div>
</body>
</html>
